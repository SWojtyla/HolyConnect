@page "/environment/{EnvironmentId:guid}/edit"
@using Microsoft.AspNetCore.WebUtilities
@inject IEnvironmentService EnvironmentService
@inject ISecretStorageService SecretStorageService
@inject NavigationManager NavigationManager
@inject ISnackbar Snackbar

<MudContainer MaxWidth="MaxWidth.Medium" Class="mt-4">
    <MudText Typo="Typo.h4" Class="mb-4">Edit Environment</MudText>

    @if (_environment != null)
    {
        <MudCard>
            <MudCardContent>
                <MudTextField @bind-Value="_name" Label="Name" Required="true" Variant="Variant.Outlined" />
                <MudTextField @bind-Value="_description" Label="Description" Lines="3" Variant="Variant.Outlined" Class="mt-4" />
                
                <MudText Typo="Typo.h6" Class="mt-6 mb-2">Environment Variables</MudText>
                @foreach (var variable in _variables)
                {
                    <MudGrid Class="mb-2">
                        <MudItem xs="4">
                            <MudTextField @bind-Value="variable.Key" Label="Key" Variant="Variant.Outlined" />
                        </MudItem>
                        <MudItem xs="4">
                            <MudStack Spacing="1">
                                <MudTextField @bind-Value="variable.Value" 
                                             Label="Value" 
                                             Variant="Variant.Outlined"
                                             InputType="@(variable.IsSecret ? InputType.Password : InputType.Text)" />
                                @if (variable.IsSecret)
                                {
                                    <MudText Typo="Typo.caption" Color="Color.Warning">Secret - stored securely</MudText>
                                }
                            </MudStack>
                        </MudItem>
                        <MudItem xs="2" Class="d-flex align-center justify-center">
                            <MudTooltip Text="@(variable.IsSecret ? "Secret (stored securely, not in git)" : "Mark as secret")">
                                <MudCheckBox @bind-Value="variable.IsSecret" 
                                             Color="@(variable.IsSecret ? Color.Warning : Color.Default)" 
                                             Icon="@Icons.Material.Filled.Lock"
                                             Size="Size.Small" />
                            </MudTooltip>
                        </MudItem>
                        <MudItem xs="2">
                            <MudIconButton Icon="@Icons.Material.Filled.Delete" Color="Color.Error" OnClick="@(() => RemoveVariable(variable))" Size="Size.Small" />
                        </MudItem>
                    </MudGrid>
                }
                <MudButton Variant="Variant.Outlined" Color="Color.Primary" OnClick="AddVariable" StartIcon="@Icons.Material.Filled.Add">
                    Add Variable
                </MudButton>
            </MudCardContent>
            <MudCardActions>
                <MudButton Variant="Variant.Filled" Color="Color.Primary" OnClick="SaveEnvironment" Disabled="@(string.IsNullOrWhiteSpace(_name))">
                    Save
                </MudButton>
                <MudButton Variant="Variant.Outlined" Color="Color.Default" OnClick="Cancel">
                    Cancel
                </MudButton>
            </MudCardActions>
        </MudCard>
    }
    else
    {
        <MudText>Loading...</MudText>
    }
</MudContainer>

@code {
    [Parameter]
    public Guid EnvironmentId { get; set; }

    private Domain.Entities.Environment? _environment;
    private string _name = string.Empty;
    private string _description = string.Empty;
    private List<VariableModel> _variables = new();
    private Guid? _requestIdToPreserve;

    private class VariableModel
    {
        public string Key { get; set; } = string.Empty;
        public string Value { get; set; } = string.Empty;
        public bool IsSecret { get; set; } = false;
    }

    protected override async Task OnInitializedAsync()
    {
        // Extract requestId from query parameters
        var uri = new Uri(NavigationManager.Uri);
        var query = QueryHelpers.ParseQuery(uri.Query);
        if (query.TryGetValue("requestId", out var requestIdString) && Guid.TryParse(requestIdString, out var requestId))
        {
            _requestIdToPreserve = requestId;
        }
        
        _environment = await EnvironmentService.GetEnvironmentByIdAsync(EnvironmentId);
        
        if (_environment != null)
        {
            _name = _environment.Name;
            _description = _environment.Description ?? string.Empty;
            
            // Load existing variables
            foreach (var kvp in _environment.Variables)
            {
                var isSecret = _environment.SecretVariables.Contains(kvp.Key);
                var value = kvp.Value;
                
                // Load secret value from secure storage if it's a secret
                if (isSecret)
                {
                    var secretValue = await SecretStorageService.GetSecretAsync(_environment.Id, kvp.Key);
                    if (!string.IsNullOrEmpty(secretValue))
                    {
                        value = secretValue;
                    }
                }
                
                _variables.Add(new VariableModel 
                { 
                    Key = kvp.Key, 
                    Value = value,
                    IsSecret = isSecret
                });
            }
        }
    }

    private void AddVariable()
    {
        _variables.Add(new VariableModel());
    }

    private void RemoveVariable(VariableModel variable)
    {
        _variables.Remove(variable);
    }

    private async Task SaveEnvironment()
    {
        if (_environment == null) return;

        _environment.Name = _name;
        _environment.Description = _description;
        
        // Clear and rebuild variables dictionary and secret variables set
        _environment.Variables.Clear();
        _environment.SecretVariables.Clear();
        
        foreach (var variable in _variables.Where(v => !string.IsNullOrWhiteSpace(v.Key)))
        {
            _environment.Variables[variable.Key] = variable.Value;
            
            // Track secret variables and save to secure storage
            if (variable.IsSecret)
            {
                _environment.SecretVariables.Add(variable.Key);
                // Save the actual value to secure storage
                await SecretStorageService.SetSecretAsync(_environment.Id, variable.Key, variable.Value);
            }
            else
            {
                // Remove from secure storage if it's no longer secret
                await SecretStorageService.RemoveSecretAsync(_environment.Id, variable.Key);
            }
        }

        await EnvironmentService.UpdateEnvironmentAsync(_environment);
        
        Snackbar.Add($"Environment '{_name}' updated successfully", Severity.Success);
        NavigateBackWithRequest();
    }

    private void Cancel()
    {
        NavigateBackWithRequest();
    }

    private void NavigateBackWithRequest()
    {
        var url = $"/environment/{EnvironmentId}";
        if (_requestIdToPreserve.HasValue)
        {
            url += $"?requestId={_requestIdToPreserve.Value}";
        }
        NavigationManager.NavigateTo(url);
    }
}
