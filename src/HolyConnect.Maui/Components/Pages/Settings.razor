@page "/settings"
@inject SettingsService SettingsService
@inject NavigationManager NavigationManager
@inject ISnackbar Snackbar
@inject IDialogService DialogService
@inject IGitFolderService GitFolderService
@inject IGitService GitService
@using HolyConnect.Maui.Services
@using HolyConnect.Application.Interfaces
@using HolyConnect.Domain.Entities
@using HolyConnect.Maui.Components.Shared.Dialogs

<MudContainer MaxWidth="MaxWidth.Large" Class="mt-4 mb-6">
    <MudText Typo="Typo.h4" Class="mb-4">Settings</MudText>

    <MudCard Class="mb-4">
        <MudCardContent>
            <MudText Typo="Typo.h6" Class="mb-3">Appearance</MudText>
            
            <MudText Typo="Typo.subtitle1" Class="mb-2">Theme Preset</MudText>
            <MudText Typo="Typo.body2" Class="mb-3">
                Choose a theme that matches your preference. Each theme offers unique colors and styling.
            </MudText>

            <MudGrid>
                @foreach (var preset in Enum.GetValues<Domain.Entities.ThemePreset>())
                {
                    var isDark = ThemeProvider.IsThemeDark(preset);
                    var isSelected = _themePreset == preset;
                    
                    <MudItem xs="12" sm="6" md="4">
                        <MudCard Outlined="true" 
                                 Class="@($"pa-3 cursor-pointer {(isSelected ? "mud-theme-primary" : "")}")"
                                 Style="@($"border: {(isSelected ? "2px solid var(--mud-palette-primary)" : "1px solid var(--mud-palette-divider)")}")"
                                 @onclick="@(() => OnThemeChanged(preset))">
                            <MudCardContent Class="pa-2">
                                <MudStack Row="true" Justify="Justify.SpaceBetween" AlignItems="AlignItems.Center" Class="mb-2">
                                    <MudText Typo="Typo.subtitle1">
                                        <strong>@ThemeProvider.GetThemeName(preset)</strong>
                                    </MudText>
                                    @if (isSelected)
                                    {
                                        <MudIcon Icon="@Icons.Material.Filled.CheckCircle" Color="Color.Primary" Size="Size.Small" />
                                    }
                                </MudStack>
                                <MudText Typo="Typo.body2" Class="mb-2">
                                    @ThemeProvider.GetThemeDescription(preset)
                                </MudText>
                                <MudStack Row="true" Spacing="1" Class="mt-2">
                                    @{
                                        var theme = ThemeProvider.GetTheme(preset);
                                        string primaryColor, secondaryColor, successColor;
                                        if (isDark)
                                        {
                                            primaryColor = theme.PaletteDark.Primary.ToString();
                                            secondaryColor = theme.PaletteDark.Secondary.ToString();
                                            successColor = theme.PaletteDark.Success.ToString();
                                        }
                                        else
                                        {
                                            primaryColor = theme.PaletteLight.Primary.ToString();
                                            secondaryColor = theme.PaletteLight.Secondary.ToString();
                                            successColor = theme.PaletteLight.Success.ToString();
                                        }
                                    }
                                    <MudChip T="string" Size="Size.Small" Style="@($"background-color: {primaryColor}; color: white")">Primary</MudChip>
                                    <MudChip T="string" Size="Size.Small" Style="@($"background-color: {secondaryColor}; color: white")">Secondary</MudChip>
                                    <MudChip T="string" Size="Size.Small" Style="@($"background-color: {successColor}; color: white")">Success</MudChip>
                                </MudStack>
                            </MudCardContent>
                        </MudCard>
                    </MudItem>
                }
            </MudGrid>
        </MudCardContent>
    </MudCard>

    <MudCard Class="mb-4">
        <MudCardContent>
            <MudText Typo="Typo.h6" Class="mb-3">Git Repositories</MudText>
            
            <MudText Typo="Typo.body2" Class="mb-3">
                Manage multiple git repositories. Set one as active to determine where requests are saved.
            </MudText>

            @if (_gitFolders.Any())
            {
                <MudTable Items="_gitFolders" Hover="true" Dense="true" Class="mb-3">
                    <HeaderContent>
                        <MudTh>Name</MudTh>
                        <MudTh>Path</MudTh>
                        <MudTh>Status</MudTh>
                        <MudTh>Actions</MudTh>
                    </HeaderContent>
                    <RowTemplate>
                        <MudTd>
                            <MudStack Row="true" AlignItems="AlignItems.Center" Spacing="1">
                                @if (context.IsActive)
                                {
                                    <MudIcon Icon="@Icons.Material.Filled.CheckCircle" Color="Color.Success" Size="Size.Small" />
                                }
                                <MudText>@context.Name</MudText>
                            </MudStack>
                        </MudTd>
                        <MudTd>
                            <MudText Typo="Typo.caption">@context.Path</MudText>
                        </MudTd>
                        <MudTd>
                            @if (context.IsActive)
                            {
                                <MudChip T="string" Size="Size.Small" Color="Color.Success">Active</MudChip>
                            }
                            else
                            {
                                <MudButton Size="Size.Small" 
                                          Variant="Variant.Text" 
                                          OnClick="@(() => SetActiveGitFolder(context.Id))">
                                    Set Active
                                </MudButton>
                            }
                        </MudTd>
                        <MudTd>
                            <MudIconButton Icon="@Icons.Material.Filled.Delete" 
                                         Size="Size.Small" 
                                         Color="Color.Error"
                                         OnClick="@(() => DeleteGitFolder(context.Id))" 
                                         Disabled="@context.IsActive" />
                        </MudTd>
                    </RowTemplate>
                </MudTable>
            }
            else
            {
                <MudAlert Severity="Severity.Info" Class="mb-3">
                    No git repositories configured. Add one below to enable version control.
                </MudAlert>
            }

            <MudDivider Class="my-3" />

            <MudText Typo="Typo.subtitle1" Class="mb-2">Add New Repository</MudText>
            <MudTextField @bind-Value="_newGitFolderName" 
                         Label="Repository Name" 
                         Variant="Variant.Outlined" 
                         Class="mb-2"
                         HelperText="A friendly name for this repository" />
            <MudTextField @bind-Value="_newGitFolderPath" 
                         Label="Repository Path" 
                         Variant="Variant.Outlined" 
                         Class="mb-2"
                         HelperText="Path to the git repository folder" />
            <MudButton Variant="Variant.Filled" 
                      Color="Color.Primary" 
                      OnClick="AddGitFolder"
                      StartIcon="@Icons.Material.Filled.Add"
                      Disabled="@(string.IsNullOrWhiteSpace(_newGitFolderName) || string.IsNullOrWhiteSpace(_newGitFolderPath))">
                Add Repository
            </MudButton>
        </MudCardContent>
    </MudCard>
</MudContainer>

@code {
    private Domain.Entities.ThemePreset _themePreset = Domain.Entities.ThemePreset.Default;
    private List<GitFolder> _gitFolders = new();
    private string _newGitFolderName = string.Empty;
    private string _newGitFolderPath = string.Empty;

    [CascadingParameter]
    public EventCallback<bool> OnDarkModeToggle { get; set; }

    protected override async Task OnInitializedAsync()
    {
        await LoadSettings();
        await LoadGitFolders();
    }

    private async Task LoadSettings()
    {
        var settings = await SettingsService.GetSettingsAsync();
        _themePreset = settings.Theme;
    }

    private async Task LoadGitFolders()
    {
        _gitFolders = (await GitFolderService.GetAllAsync()).ToList();
    }

    private async Task AddGitFolder()
    {
        try
        {
            if (string.IsNullOrWhiteSpace(_newGitFolderName) || string.IsNullOrWhiteSpace(_newGitFolderPath))
            {
                Snackbar.Add("Please provide both name and path", Severity.Warning);
                return;
            }

            // Check if path is a valid git repository
            var isRepo = await GitService.IsRepositoryAsync(_newGitFolderPath);
            if (!isRepo)
            {
                Snackbar.Add("The specified path is not a git repository", Severity.Warning);
                return;
            }

            await GitFolderService.AddAsync(_newGitFolderName, _newGitFolderPath);
            await LoadGitFolders();
            
            _newGitFolderName = string.Empty;
            _newGitFolderPath = string.Empty;
            
            Snackbar.Add("Repository added successfully", Severity.Success);
        }
        catch (Exception ex)
        {
            Snackbar.Add($"Error adding repository: {ex.Message}", Severity.Error);
        }
    }

    private async Task SetActiveGitFolder(Guid id)
    {
        try
        {
            await GitFolderService.SetActiveAsync(id);
            await LoadGitFolders();
            Snackbar.Add("Active repository changed", Severity.Success);
        }
        catch (Exception ex)
        {
            Snackbar.Add($"Error setting active repository: {ex.Message}", Severity.Error);
        }
    }

    private async Task DeleteGitFolder(Guid id)
    {
        try
        {
            var folder = _gitFolders.FirstOrDefault(f => f.Id == id);
            if (folder == null)
                return;

            var parameters = new DialogParameters
            {
                ["ContentText"] = $"Are you sure you want to remove '{folder.Name}'? This won't delete any files.",
                ["ButtonText"] = "Delete",
                ["Color"] = MudBlazor.Color.Error
            };

            var dialog = await DialogService.ShowAsync<ConfirmDialog>("Delete Repository", parameters);
            var result = await dialog.Result;

            if (!result.Canceled)
            {
                await GitFolderService.DeleteAsync(id);
                await LoadGitFolders();
                Snackbar.Add("Repository removed", Severity.Success);
            }
        }
        catch (Exception ex)
        {
            Snackbar.Add($"Error deleting repository: {ex.Message}", Severity.Error);
        }
    }

    private async Task OnThemeChanged(Domain.Entities.ThemePreset preset)
    {
        _themePreset = preset;
        var isDark = ThemeProvider.IsThemeDark(preset);
        await OnDarkModeToggle.InvokeAsync(isDark);
        
        // Auto-save theme preference
        try
        {
            var settings = await SettingsService.GetSettingsAsync();
            settings.Theme = _themePreset;
            settings.IsDarkMode = isDark;
            await SettingsService.SaveSettingsAsync(settings);
            Snackbar.Add($"Theme changed to {ThemeProvider.GetThemeName(preset)}", Severity.Success);
        }
        catch (Exception ex)
        {
            Snackbar.Add($"Error saving theme preference: {ex.Message}", Severity.Warning);
        }
    }
}
