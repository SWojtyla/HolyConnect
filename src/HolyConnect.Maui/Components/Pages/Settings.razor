@page "/settings"
@inject SettingsService SettingsService
@inject NavigationManager NavigationManager
@inject ISnackbar Snackbar
@using HolyConnect.Maui.Services

<MudContainer MaxWidth="MaxWidth.Large" Class="mt-4 mb-6">
    <MudText Typo="Typo.h4" Class="mb-4">Settings</MudText>

    <MudCard Class="mb-4">
        <MudCardContent>
            <MudText Typo="Typo.h6" Class="mb-3">Appearance</MudText>
            
            <MudText Typo="Typo.subtitle1" Class="mb-2">Theme Preset</MudText>
            <MudText Typo="Typo.body2" Class="mb-3">
                Choose a theme that matches your preference. Each theme offers unique colors and styling.
            </MudText>

            <MudGrid>
                @foreach (var preset in Enum.GetValues<Domain.Entities.ThemePreset>())
                {
                    var isDark = ThemeProvider.IsThemeDark(preset);
                    var isSelected = _themePreset == preset;
                    
                    <MudItem xs="12" sm="6" md="4">
                        <MudCard Outlined="true" 
                                 Class="@($"pa-3 cursor-pointer {(isSelected ? "mud-theme-primary" : "")}")"
                                 Style="@($"border: {(isSelected ? "2px solid var(--mud-palette-primary)" : "1px solid var(--mud-palette-divider)")}")"
                                 @onclick="@(() => OnThemeChanged(preset))">
                            <MudCardContent Class="pa-2">
                                <MudStack Row="true" Justify="Justify.SpaceBetween" AlignItems="AlignItems.Center" Class="mb-2">
                                    <MudText Typo="Typo.subtitle1">
                                        <strong>@ThemeProvider.GetThemeName(preset)</strong>
                                    </MudText>
                                    @if (isSelected)
                                    {
                                        <MudIcon Icon="@Icons.Material.Filled.CheckCircle" Color="Color.Primary" Size="Size.Small" />
                                    }
                                </MudStack>
                                <MudText Typo="Typo.body2" Class="mb-2">
                                    @ThemeProvider.GetThemeDescription(preset)
                                </MudText>
                                <MudStack Row="true" Spacing="1" Class="mt-2">
                                    @{
                                        var theme = ThemeProvider.GetTheme(preset);
                                        string primaryColor, secondaryColor, successColor;
                                        if (isDark)
                                        {
                                            primaryColor = theme.PaletteDark.Primary.ToString();
                                            secondaryColor = theme.PaletteDark.Secondary.ToString();
                                            successColor = theme.PaletteDark.Success.ToString();
                                        }
                                        else
                                        {
                                            primaryColor = theme.PaletteLight.Primary.ToString();
                                            secondaryColor = theme.PaletteLight.Secondary.ToString();
                                            successColor = theme.PaletteLight.Success.ToString();
                                        }
                                    }
                                    <MudChip T="string" Size="Size.Small" Style="@($"background-color: {primaryColor}; color: white")">Primary</MudChip>
                                    <MudChip T="string" Size="Size.Small" Style="@($"background-color: {secondaryColor}; color: white")">Secondary</MudChip>
                                    <MudChip T="string" Size="Size.Small" Style="@($"background-color: {successColor}; color: white")">Success</MudChip>
                                </MudStack>
                            </MudCardContent>
                        </MudCard>
                    </MudItem>
                }
            </MudGrid>

            <MudDivider Class="my-4" />

            <MudText Typo="Typo.subtitle1" Class="mb-2">Request Layout</MudText>
            <MudText Typo="Typo.body2" Class="mb-2">
                Choose how requests and responses are displayed.
            </MudText>
            <MudRadioGroup @bind-Value="_requestLayout">
                <MudRadio Value="@Domain.Entities.RequestLayout.Horizontal" Color="Color.Primary">
                    <MudText Typo="Typo.body2">
                        <strong>Horizontal (Default)</strong> - Request configuration on top, response below with resizable areas
                    </MudText>
                </MudRadio>
                <MudRadio Value="@Domain.Entities.RequestLayout.Vertical" Color="Color.Primary">
                    <MudText Typo="Typo.body2">
                        <strong>Vertical (Bruno/Postman style)</strong> - Request on left, response on right
                    </MudText>
                </MudRadio>
            </MudRadioGroup>
        </MudCardContent>
    </MudCard>

    <MudCard>
        <MudCardContent>
            <MudText Typo="Typo.h6" Class="mb-3">Data Storage</MudText>
            
            <MudText Typo="Typo.body2" Class="mb-2">
                Choose where to save your environments, collections, and requests.
            </MudText>

            <MudTextField @bind-Value="_storagePath" 
                         Label="Storage Path" 
                         Variant="Variant.Outlined" 
                         Class="mb-2"
                         HelperText="Path where data will be stored on disk" />

            <MudButton Variant="Variant.Filled" 
                      Color="Color.Primary" 
                      OnClick="BrowseStoragePath"
                      StartIcon="@Icons.Material.Filled.FolderOpen"
                      Class="mb-3">
                Browse
            </MudButton>

            <MudText Typo="Typo.caption" Class="mb-3">
                Current path: @_storagePath
            </MudText>

            <MudButton Variant="Variant.Filled" 
                      Color="Color.Success" 
                      OnClick="SaveSettings"
                      StartIcon="@Icons.Material.Filled.Save">
                Save Settings
            </MudButton>
        </MudCardContent>
    </MudCard>
</MudContainer>

@code {
    private string _storagePath = string.Empty;
    private Domain.Entities.RequestLayout _requestLayout = Domain.Entities.RequestLayout.Horizontal;
    private Domain.Entities.ThemePreset _themePreset = Domain.Entities.ThemePreset.Default;

    [CascadingParameter]
    public EventCallback<bool> OnDarkModeToggle { get; set; }

    protected override async Task OnInitializedAsync()
    {
        await LoadSettings();
    }

    private async Task LoadSettings()
    {
        var settings = await SettingsService.GetSettingsAsync();
        _storagePath = settings.StoragePath;
        _requestLayout = settings.Layout;
        _themePreset = settings.Theme;
    }

    private async Task OnThemeChanged(Domain.Entities.ThemePreset preset)
    {
        _themePreset = preset;
        var isDark = ThemeProvider.IsThemeDark(preset);
        await OnDarkModeToggle.InvokeAsync(isDark);
        
        // Auto-save theme preference
        try
        {
            var settings = await SettingsService.GetSettingsAsync();
            settings.Theme = _themePreset;
            settings.IsDarkMode = isDark;
            await SettingsService.SaveSettingsAsync(settings);
            Snackbar.Add($"Theme changed to {ThemeProvider.GetThemeName(preset)}", Severity.Success);
        }
        catch (Exception ex)
        {
            Snackbar.Add($"Error saving theme preference: {ex.Message}", Severity.Warning);
        }
    }

    private async Task BrowseStoragePath()
    {
        try
        {
#if WINDOWS
            var folderPicker = new Windows.Storage.Pickers.FolderPicker();
            var window = Microsoft.Maui.Controls.Application.Current?.Windows?.FirstOrDefault();
            if (window?.Handler?.PlatformView != null)
            {
                var windowHandle = WinRT.Interop.WindowNative.GetWindowHandle(window.Handler.PlatformView);
                WinRT.Interop.InitializeWithWindow.Initialize(folderPicker, windowHandle);
                
                folderPicker.SuggestedStartLocation = Windows.Storage.Pickers.PickerLocationId.DocumentsLibrary;
                folderPicker.FileTypeFilter.Add("*");

                var folder = await folderPicker.PickSingleFolderAsync();
                if (folder != null)
                {
                    _storagePath = folder.Path;
                }
            }
            else
            {
                Snackbar.Add("Cannot access window for folder picker", Severity.Warning);
            }
#elif ANDROID
            // For Android, we'll use the app's local directory
            var context = Android.App.Application.Context;
            var externalFilesDir = context.GetExternalFilesDir(null)?.AbsolutePath;
            if (!string.IsNullOrEmpty(externalFilesDir))
            {
                _storagePath = Path.Combine(externalFilesDir, "HolyConnect");
                Snackbar.Add("Using app's storage directory on Android", Severity.Info);
            }
#elif IOS || MACCATALYST
            // For iOS/MacCatalyst, use documents directory
            _storagePath = Path.Combine(System.Environment.GetFolderPath(System.Environment.SpecialFolder.MyDocuments), "HolyConnect");
            Snackbar.Add("Using documents directory", Severity.Info);
#else
            Snackbar.Add("File picker not available on this platform", Severity.Warning);
#endif
        }
        catch (Exception ex)
        {
            Snackbar.Add($"Error selecting folder: {ex.Message}", Severity.Error);
        }
    }

    private async Task SaveSettings()
    {
        try
        {
            var settings = new Domain.Entities.AppSettings
            {
                IsDarkMode = ThemeProvider.IsThemeDark(_themePreset),
                StoragePath = _storagePath,
                Layout = _requestLayout,
                Theme = _themePreset
            };

            await SettingsService.SaveSettingsAsync(settings);
            await OnDarkModeToggle.InvokeAsync(settings.IsDarkMode);
            Snackbar.Add("Settings saved successfully!", Severity.Success);
        }
        catch (Exception ex)
        {
            Snackbar.Add($"Error saving settings: {ex.Message}", Severity.Error);
        }
    }
}
