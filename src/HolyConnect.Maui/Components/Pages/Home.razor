@page "/"
@inject IEnvironmentService EnvironmentService
@inject IRequestHistoryService HistoryService
@inject NavigationManager NavigationManager
@inject IDialogService DialogService
@inject ISnackbar Snackbar

<MudContainer MaxWidth="MaxWidth.Large" Class="mt-4 mb-6">
    <div class="home-logo-container">
        <img src="/holyconnect_logo.svg" alt="HolyConnect Logo" class="home-logo" />
    </div>
    <MudText Typo="Typo.h4" Class="mb-2">Welcome to HolyConnect</MudText>
    <MudText Typo="Typo.body1" Class="mb-6" Color="Color.Secondary">
        A powerful API testing tool for REST, GraphQL, and more. Get started by creating an environment or exploring your existing collections.
    </MudText>

    <MudGrid Spacing="3">
        <MudItem xs="12" md="6" lg="4">
            <MudCard Elevation="2" Class="d-flex flex-column" Style="height: 100%;">
                <MudCardContent Class="flex-grow-1">
                    <MudStack Spacing="2">
                        <MudIcon Icon="@Icons.Material.Filled.AddCircle" Color="Color.Primary" Size="Size.Large" />
                        <MudText Typo="Typo.h6">Quick Actions</MudText>
                        <MudText Typo="Typo.body2" Color="Color.Secondary">
                            Create new resources to get started quickly
                        </MudText>
                    </MudStack>
                </MudCardContent>
                <MudCardActions Class="d-flex flex-column gap-2 pa-4">
                    <MudButton Variant="Variant.Filled" 
                              Color="Color.Primary" 
                              OnClick="CreateEnvironment" 
                              FullWidth="true"
                              StartIcon="@Icons.Material.Filled.Dns">
                        Create Environment
                    </MudButton>
                    <MudButton Variant="Variant.Outlined" 
                              Color="Color.Primary" 
                              OnClick="CreateCollection" 
                              FullWidth="true"
                              StartIcon="@Icons.Material.Filled.Folder">
                        Create Collection
                    </MudButton>
                    <MudButton Variant="Variant.Outlined" 
                              Color="Color.Primary" 
                              OnClick="CreateRequest" 
                              FullWidth="true"
                              StartIcon="@Icons.Material.Filled.Http">
                        Create Request
                    </MudButton>
                    <MudButton Variant="Variant.Outlined"
                              Color="Color.Primary"
                              OnClick="CreateFlow"
                              FullWidth="true"
                              StartIcon="@Icons.Material.Filled.AccountTree">
                        Create Flow
                    </MudButton>
                </MudCardActions>
            </MudCard>
        </MudItem>

        <MudItem xs="12" md="6" lg="4">
            <MudCard Elevation="2" Style="height: 100%;">
                <MudCardContent>
                    <MudStack Row="true" Justify="Justify.SpaceBetween" AlignItems="AlignItems.Center" Class="mb-3">
                        <MudStack Row="true" AlignItems="AlignItems.Center" Spacing="2">
                            <MudIcon Icon="@Icons.Material.Filled.Dns" Color="Color.Primary" Size="Size.Large" />
                            <MudText Typo="Typo.h6">Recent Environments</MudText>
                        </MudStack>
                        @if (_environments != null && _environments.Any())
                        {
                            <MudChip T="string" Color="Color.Primary" Size="Size.Small">@_environments.Count() total</MudChip>
                        }
                    </MudStack>
                    @if (_environments != null && _environments.Any())
                    {
                        <MudStack Spacing="2">
                            @foreach (var env in _environments.Take(5))
                            {
                                <MudPaper Class="pa-3" Outlined="true">
                                    <MudGrid>
                                        <MudItem xs="12" sm="8" Class="d-flex align-center">
                                            <MudStack Row="true" AlignItems="AlignItems.Center" Spacing="2" Class="cursor-pointer flex-grow-1" @onclick="@(() => NavigateToEnvironment(env.Id))">
                                                <MudIcon Icon="@Icons.Material.Filled.Dns" Color="Color.Primary" Size="Size.Small" />
                                                <MudText Typo="Typo.body1" Class="text-truncate">
                                                    <MudTooltip Text="@env.Name">
                                                        <strong>@env.Name</strong>
                                                    </MudTooltip>
                                                </MudText>
                                            </MudStack>
                                        </MudItem>
                                        <MudItem xs="12" sm="4" Class="d-flex justify-end align-center">
                                            <MudStack Row="true" Spacing="1" @onclick:stopPropagation="true">
                                                <MudIconButton Icon="@Icons.Material.Filled.Edit" 
                                                             Size="Size.Small" 
                                                             OnClick="@(() => RenameEnvironment(env))" 
                                                             Title="Rename environment" />
                                                <MudIconButton Icon="@Icons.Material.Filled.Delete" 
                                                             Size="Size.Small" 
                                                             Color="Color.Error" 
                                                             OnClick="@(() => DeleteEnvironment(env))" 
                                                             Title="Delete environment" />
                                            </MudStack>
                                        </MudItem>
                                    </MudGrid>
                                </MudPaper>
                            }
                            @if (_environments.Count() > 5)
                            {
                                <MudText Typo="Typo.caption" Align="Align.Center" Color="Color.Secondary">
                                    And @(_environments.Count() - 5) more...
                                </MudText>
                            }
                        </MudStack>
                    }
                    else
                    {
                        <MudAlert Severity="Severity.Info" Variant="Variant.Outlined">
                            No environments yet. Create one to get started!
                        </MudAlert>
                    }
                </MudCardContent>
            </MudCard>
        </MudItem>

        <MudItem xs="12" md="6" lg="4">
            <MudCard Elevation="2" Style="height: 100%;">
                <MudCardContent>
                    <MudStack Row="true" Justify="Justify.SpaceBetween" AlignItems="AlignItems.Center" Class="mb-3">
                        <MudStack Row="true" AlignItems="AlignItems.Center" Spacing="2">
                            <MudIcon Icon="@Icons.Material.Filled.History" Color="Color.Primary" Size="Size.Large" />
                            <MudText Typo="Typo.h6">Recent Requests</MudText>
                        </MudStack>
                        @if (_historyEntries != null && _historyEntries.Any())
                        {
                            <MudChip T="string" Color="Color.Primary" Size="Size.Small">Last @_historyEntries.Count()</MudChip>
                        }
                    </MudStack>
                    @if (_historyEntries != null && _historyEntries.Any())
                    {
                        <MudStack Spacing="2">
                            @foreach (var entry in _historyEntries.Take(5))
                            {
                                <MudPaper Class="pa-3" Outlined="true">
                                    <MudGrid>
                                        <MudItem xs="12" Class="d-flex align-center justify-space-between">
                                            <MudStack Spacing="1" Class="flex-grow-1">
                                                <MudStack Row="true" AlignItems="AlignItems.Center" Spacing="2">
                                                    <MudIcon Icon="@Icons.Material.Filled.Http" Color="Color.Primary" Size="Size.Small" />
                                                    <MudTooltip Text="@entry.RequestName">
                                                        <MudText Typo="Typo.body1" Class="text-truncate">
                                                            <strong>@entry.RequestName</strong>
                                                        </MudText>
                                                    </MudTooltip>
                                                </MudStack>
                                                <MudStack Row="true" AlignItems="AlignItems.Center" Spacing="1">
                                                    <MudChip T="string" Color="@GetStatusColor(entry.Response.StatusCode)" Size="Size.Small">
                                                        @entry.Response.StatusCode
                                                    </MudChip>
                                                    <MudText Typo="Typo.caption" Color="Color.Secondary">@entry.Response.ResponseTime ms</MudText>
                                                </MudStack>
                                                <MudText Typo="Typo.caption" Color="Color.Secondary">
                                                    @entry.Timestamp.ToLocalTime().ToString("MMM dd, HH:mm")
                                                </MudText>
                                            </MudStack>
                                            @if (entry.RequestId.HasValue && entry.EnvironmentId.HasValue)
                                            {
                                                <MudIconButton Icon="@Icons.Material.Filled.Launch" 
                                                             Size="Size.Small" 
                                                             Color="Color.Primary" 
                                                             OnClick="@(() => NavigateToRequest(entry))"
                                                             Title="Open request" />
                                            }
                                        </MudItem>
                                    </MudGrid>
                                </MudPaper>
                            }
                            @if (_historyEntries.Count() > 5)
                            {
                                <MudButton Variant="Variant.Text" 
                                          Color="Color.Primary" 
                                          FullWidth="true"
                                          OnClick="@(() => NavigationManager.NavigateTo("/history"))">
                                    View All History
                                </MudButton>
                            }
                        </MudStack>
                    }
                    else
                    {
                        <MudAlert Severity="Severity.Info" Variant="Variant.Outlined">
                            No requests executed yet. Execute a request to see history!
                        </MudAlert>
                    }
                </MudCardContent>
            </MudCard>
        </MudItem>

        <MudItem xs="12">
            <MudCard Elevation="2">
                <MudCardContent>
                    <MudStack Row="true" AlignItems="AlignItems.Center" Spacing="2" Class="mb-4">
                        <MudIcon Icon="@Icons.Material.Filled.Star" Color="Color.Primary" Size="Size.Large" />
                        <MudText Typo="Typo.h6">Features</MudText>
                    </MudStack>
                    <MudGrid Spacing="3">
                        <MudItem xs="12" sm="6" md="4">
                            <MudPaper Class="pa-4" Outlined="true">
                                <MudStack Spacing="2">
                                    <MudIcon Icon="@Icons.Material.Filled.Http" Color="Color.Primary" Size="Size.Large" />
                                    <MudText Typo="Typo.subtitle1"><strong>REST API Support</strong></MudText>
                                    <MudText Typo="Typo.body2" Color="Color.Secondary">
                                        Send GET, POST, PUT, DELETE, and other HTTP requests with full header and body control
                                    </MudText>
                                </MudStack>
                            </MudPaper>
                        </MudItem>
                        <MudItem xs="12" sm="6" md="4">
                            <MudPaper Class="pa-4" Outlined="true">
                                <MudStack Spacing="2">
                                    <MudIcon Icon="@Icons.Material.Filled.GraphicEq" Color="Color.Secondary" Size="Size.Large" />
                                    <MudText Typo="Typo.subtitle1"><strong>GraphQL Support</strong></MudText>
                                    <MudText Typo="Typo.body2" Color="Color.Secondary">
                                        Test GraphQL queries and mutations with ease, including variables support
                                    </MudText>
                                </MudStack>
                            </MudPaper>
                        </MudItem>
                        <MudItem xs="12" sm="6" md="4">
                            <MudPaper Class="pa-4" Outlined="true">
                                <MudStack Spacing="2">
                                    <MudIcon Icon="@Icons.Material.Filled.Folder" Color="Color.Info" Size="Size.Large" />
                                    <MudText Typo="Typo.subtitle1"><strong>Organization</strong></MudText>
                                    <MudText Typo="Typo.body2" Color="Color.Secondary">
                                        Organize requests in collections and environments with variables support
                                    </MudText>
                                </MudStack>
                            </MudPaper>
                        </MudItem>
                    </MudGrid>
                </MudCardContent>
            </MudCard>
        </MudItem>
    </MudGrid>
</MudContainer>

@code {
    private IEnumerable<Domain.Entities.Environment>? _environments;
    private IEnumerable<RequestHistoryEntry>? _historyEntries;

    protected override async Task OnInitializedAsync()
    {
        await LoadEnvironments();
        await LoadHistory();
    }

    private async Task LoadEnvironments()
    {
        _environments = await EnvironmentService.GetAllEnvironmentsAsync();
    }

    private async Task LoadHistory()
    {
        _historyEntries = await HistoryService.GetHistoryAsync(10);
    }

    private void CreateEnvironment()
    {
        NavigationManager.NavigateTo("/environment/create");
    }

    private void CreateCollection()
    {
        NavigationManager.NavigateTo("/collection/create");
    }

    private void CreateRequest()
    {
        NavigationManager.NavigateTo("/request/create");
    }

    private void CreateFlow()
    {
        NavigationManager.NavigateTo("/flow/create");
    }

    private void NavigateToEnvironment(Guid id)
    {
        NavigationManager.NavigateTo($"/environment/{id}");
    }

    private async Task RenameEnvironment(Domain.Entities.Environment environment)
    {
        var parameters = new DialogParameters
        {
            ["CurrentName"] = environment.Name
        };

        var dialog = await DialogService.ShowAsync<RenameDialog>("Rename Environment", parameters);
        var result = await dialog.Result;

        if (!result.Canceled && result.Data is string newName && !string.IsNullOrWhiteSpace(newName))
        {
            environment.Name = newName;
            await EnvironmentService.UpdateEnvironmentAsync(environment);
            Snackbar.Add("Environment renamed successfully", Severity.Success);
            await LoadEnvironments();
            StateHasChanged();
        }
    }

    private async Task DeleteEnvironment(Domain.Entities.Environment environment)
    {
        var parameters = new DialogParameters
        {
            ["ContentText"] = $"Are you sure you want to delete the environment '{environment.Name}'? This will also delete all collections and requests within it. This action cannot be undone.",
            ["ButtonText"] = "Delete",
            ["Color"] = Color.Error
        };

        var dialog = await DialogService.ShowAsync<ConfirmDialog>("Delete Environment", parameters);
        var result = await dialog.Result;

        if (!result.Canceled)
        {
            await EnvironmentService.DeleteEnvironmentAsync(environment.Id);
            Snackbar.Add("Environment deleted successfully", Severity.Success);
            await LoadEnvironments();
            StateHasChanged();
        }
    }

    private Color GetStatusColor(int statusCode)
    {
        return statusCode switch
        {
            >= 200 and < 300 => Color.Success,
            >= 300 and < 400 => Color.Info,
            >= 400 and < 500 => Color.Warning,
            >= 500 => Color.Error,
            _ => Color.Default
        };
    }

    private void NavigateToRequest(RequestHistoryEntry entry)
    {
        if (entry.RequestId.HasValue && entry.EnvironmentId.HasValue)
        {
            NavigationManager.NavigateTo($"/environment/{entry.EnvironmentId}?requestId={entry.RequestId}");
        }
    }
}
