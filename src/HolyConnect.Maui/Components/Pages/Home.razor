@page "/"
@inject IEnvironmentService EnvironmentService
@inject NavigationManager NavigationManager
@inject IDialogService DialogService
@inject ISnackbar Snackbar

<MudContainer MaxWidth="MaxWidth.Large" Class="mt-4">
    <MudStack AlignItems="AlignItems.Center" Class="mb-4">
        <MudImage Src="holyconnect-logo.svg" Alt="HolyConnect Logo" Height="120" Class="mb-2" />
        <MudText Typo="Typo.h4">Welcome to HolyConnect</MudText>
    </MudStack>
    <MudText Typo="Typo.body1" Class="mb-6" Align="Align.Center">
        A powerful API testing tool for REST, GraphQL, and more. Get started by creating an environment or exploring your existing collections.
    </MudText>

    <MudGrid>
        <MudItem xs="12" md="6">
            <MudCard>
                <MudCardContent>
                    <MudText Typo="Typo.h6" Class="mb-2">Quick Actions</MudText>
                    <MudButton Variant="Variant.Filled" Color="Color.Primary" Class="mt-2" OnClick="CreateEnvironment" FullWidth="true">
                        Create New Environment
                    </MudButton>
                    <MudButton Variant="Variant.Outlined" Color="Color.Secondary" Class="mt-2" OnClick="CreateRequest" FullWidth="true">
                        Create New Request
                    </MudButton>
                </MudCardContent>
            </MudCard>
        </MudItem>

        <MudItem xs="12" md="6">
            <MudCard>
                <MudCardContent>
                    <MudText Typo="Typo.h6" Class="mb-2">Recent Environments</MudText>
                    @if (_environments != null && _environments.Any())
                    {
                        <MudStack Spacing="2">
                            @foreach (var env in _environments.Take(5))
                            {
                                <MudPaper Class="pa-2">
                                    <MudStack Row="true" Justify="Justify.SpaceBetween" AlignItems="AlignItems.Center">
                                        <MudText Class="cursor-pointer flex-grow-1" @onclick="@(() => NavigateToEnvironment(env.Id))">
                                            <MudIcon Icon="@Icons.Material.Filled.Dns" Size="Size.Small" /> @env.Name
                                        </MudText>
                                        <MudStack Row="true" Spacing="1" @onclick:stopPropagation="true">
                                            <MudIconButton Icon="@Icons.Material.Filled.Edit" Size="Size.Small" OnClick="@(() => RenameEnvironment(env))" aria-label="Rename environment" />
                                            <MudIconButton Icon="@Icons.Material.Filled.Delete" Size="Size.Small" Color="Color.Error" OnClick="@(() => DeleteEnvironment(env))" aria-label="Delete environment" />
                                        </MudStack>
                                    </MudStack>
                                </MudPaper>
                            }
                        </MudStack>
                    }
                    else
                    {
                        <MudText Typo="Typo.body2" Color="Color.Default">No environments yet. Create one to get started!</MudText>
                    }
                </MudCardContent>
            </MudCard>
        </MudItem>

        <MudItem xs="12">
            <MudCard>
                <MudCardContent>
                    <MudText Typo="Typo.h6" Class="mb-2">Features</MudText>
                    <MudGrid>
                        <MudItem xs="12" md="4">
                            <MudText Typo="Typo.subtitle2"><MudIcon Icon="@Icons.Material.Filled.Http" Size="Size.Small" /> REST API Support</MudText>
                            <MudText Typo="Typo.body2">Send GET, POST, PUT, DELETE, and other HTTP requests</MudText>
                        </MudItem>
                        <MudItem xs="12" md="4">
                            <MudText Typo="Typo.subtitle2"><MudIcon Icon="@Icons.Material.Filled.GraphicEq" Size="Size.Small" /> GraphQL Support</MudText>
                            <MudText Typo="Typo.body2">Test GraphQL queries and mutations with ease</MudText>
                        </MudItem>
                        <MudItem xs="12" md="4">
                            <MudText Typo="Typo.subtitle2"><MudIcon Icon="@Icons.Material.Filled.Folder" Size="Size.Small" /> Organization</MudText>
                            <MudText Typo="Typo.body2">Organize requests in collections and environments</MudText>
                        </MudItem>
                    </MudGrid>
                </MudCardContent>
            </MudCard>
        </MudItem>
    </MudGrid>
</MudContainer>

@code {
    private IEnumerable<Domain.Entities.Environment>? _environments;

    protected override async Task OnInitializedAsync()
    {
        await LoadEnvironments();
    }

    private async Task LoadEnvironments()
    {
        _environments = await EnvironmentService.GetAllEnvironmentsAsync();
    }

    private void CreateEnvironment()
    {
        NavigationManager.NavigateTo("/environment/create");
    }

    private void CreateRequest()
    {
        NavigationManager.NavigateTo("/request/create");
    }

    private void NavigateToEnvironment(Guid id)
    {
        NavigationManager.NavigateTo($"/environment/{id}");
    }

    private async Task RenameEnvironment(Domain.Entities.Environment environment)
    {
        var parameters = new DialogParameters
        {
            ["CurrentName"] = environment.Name
        };

        var dialog = await DialogService.ShowAsync<RenameDialog>("Rename Environment", parameters);
        var result = await dialog.Result;

        if (!result.Canceled && result.Data is string newName && !string.IsNullOrWhiteSpace(newName))
        {
            environment.Name = newName;
            await EnvironmentService.UpdateEnvironmentAsync(environment);
            Snackbar.Add("Environment renamed successfully", Severity.Success);
            await LoadEnvironments();
            StateHasChanged();
        }
    }

    private async Task DeleteEnvironment(Domain.Entities.Environment environment)
    {
        var parameters = new DialogParameters
        {
            ["ContentText"] = $"Are you sure you want to delete the environment '{environment.Name}'? This will also delete all collections and requests within it. This action cannot be undone.",
            ["ButtonText"] = "Delete",
            ["Color"] = Color.Error
        };

        var dialog = await DialogService.ShowAsync<ConfirmDialog>("Delete Environment", parameters);
        var result = await dialog.Result;

        if (!result.Canceled)
        {
            await EnvironmentService.DeleteEnvironmentAsync(environment.Id);
            Snackbar.Add("Environment deleted successfully", Severity.Success);
            await LoadEnvironments();
            StateHasChanged();
        }
    }
}
