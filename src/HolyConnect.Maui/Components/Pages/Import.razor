@page "/import"
@inject IImportService ImportService
@inject ICollectionService CollectionService
@inject NavigationManager NavigationManager
@inject ISnackbar Snackbar

<MudContainer MaxWidth="MaxWidth.Large" Class="mt-4">
    <MudText Typo="Typo.h4" Class="mb-4">Import Request</MudText>
    <MudText Typo="Typo.body1" Class="mb-6" Color="Color.Secondary">
        Import requests from curl commands or Bruno files.
    </MudText>

    <MudPaper Class="pa-6" Elevation="2">
        <MudForm @ref="_form">
            <MudStack Spacing="4">
                <!-- Import Source Selection -->
                <MudSelect T="ImportSource" 
                          Label="Import Source" 
                          @bind-Value="_selectedSource"
                          Variant="Variant.Outlined">
                    <MudSelectItem Value="ImportSource.Curl">curl Command</MudSelectItem>
                    <MudSelectItem Value="ImportSource.Bruno">Bruno File (.bru)</MudSelectItem>
                </MudSelect>

                <!-- Collection Selection (Optional) -->
                <MudSelect T="Guid?" 
                          Label="Target Collection (Optional)" 
                          @bind-Value="_selectedCollectionId"
                          Variant="Variant.Outlined"
                          Clearable="true"
                          HelperText="Import to a specific collection, or leave empty to import at root level">
                    @if (_collections != null && _collections.Any())
                    {
                        @foreach (var collection in _collections)
                        {
                            <MudSelectItem Value="@((Guid?)collection.Id)">@collection.Name</MudSelectItem>
                        }
                    }
                    else
                    {
                        <MudSelectItem Value="@((Guid?)null)" Disabled="true">No collections available</MudSelectItem>
                    }
                </MudSelect>

                <!-- curl Command Input -->
                @if (_selectedSource == ImportSource.Curl)
                {
                    <MudTextField T="string" 
                                 Label="curl Command" 
                                 @bind-Value="_curlCommand"
                                 Variant="Variant.Outlined"
                                 Lines="10"
                                 Required="true"
                                 RequiredError="Please enter a curl command"
                                 Placeholder="curl 'https://api.example.com/users' -H 'Authorization: Bearer token123'"
                                 HelperText="Paste your curl command here. Multi-line commands are supported." />
                    
                    <!-- Request Name Input -->
                    <MudTextField T="string" 
                                 Label="Request Name (Optional)" 
                                 @bind-Value="_requestName"
                                 Variant="Variant.Outlined"
                                 Placeholder="Leave empty to auto-generate from URL"
                                 HelperText="Specify a custom name for the imported request, or leave empty to auto-generate." />
                }

                <!-- Bruno File Input -->
                @if (_selectedSource == ImportSource.Bruno)
                {
                    <MudStack Spacing="2">
                        <!-- Import Mode Selection -->
                        <MudRadioGroup T="bool" @bind-Value="_importFolder">
                            <MudRadio T="bool" Value="false" Color="Color.Primary">Import Single File</MudRadio>
                            <MudRadio T="bool" Value="true" Color="Color.Primary">Import Folder (with subfolders)</MudRadio>
                        </MudRadioGroup>

                        @if (!_importFolder)
                        {
                            <!-- Single File Import -->
                            <MudButton Variant="Variant.Outlined" 
                                      Color="Color.Primary"
                                      StartIcon="@Icons.Material.Filled.Upload"
                                      OnClick="BrowseBrunoFile">
                                Browse File
                            </MudButton>
                            
                            @if (!string.IsNullOrEmpty(_selectedFileName))
                            {
                                <MudChip T="string" Color="Color.Info" Icon="@Icons.Material.Filled.Description">
                                    @_selectedFileName
                                </MudChip>
                            }
                            
                            @if (!string.IsNullOrEmpty(_brunoFileContent))
                            {
                                <MudTextField T="string" 
                                             Label="Bruno File Content (Preview)" 
                                             Value="_brunoFileContent"
                                             Variant="Variant.Outlined"
                                             Lines="10"
                                             ReadOnly="true"
                                             HelperText="Preview of the selected Bruno file" />
                            }
                            
                            <!-- Request Name Input -->
                            <MudTextField T="string" 
                                         Label="Request Name (Optional)" 
                                         @bind-Value="_requestName"
                                         Variant="Variant.Outlined"
                                         Placeholder="Leave empty to use name from file"
                                         HelperText="Specify a custom name for the imported request, or leave empty to use the name from the Bruno file." />
                        }
                        else
                        {
                            <!-- Folder Import -->
                            <MudTextField T="string" 
                                         Label="Folder Path" 
                                         @bind-Value="_brunoFolderPath"
                                         Variant="Variant.Outlined"
                                         Required="true"
                                         RequiredError="Please enter a folder path"
                                         Placeholder="e.g., /path/to/bruno/collection"
                                         HelperText="Enter the full path to the folder containing Bruno files. All .bru files in this folder and its subfolders will be imported." />
                            
                            @if (!string.IsNullOrEmpty(_brunoFolderPath))
                            {
                                <MudAlert Severity="Severity.Info" Variant="Variant.Outlined">
                                    <MudText Typo="Typo.body2">
                                        <strong>Folder structure will be preserved:</strong><br/>
                                        • Each folder will become a collection<br/>
                                        • Each subfolder will become a subcollection<br/>
                                        • Each .bru file will become a request in its parent folder's collection
                                    </MudText>
                                </MudAlert>
                            }
                        }
                    </MudStack>
                }

                <!-- Import Button -->
                <MudStack Row="true" Justify="Justify.FlexEnd" Spacing="2">
                    <MudButton Variant="Variant.Outlined" 
                              OnClick="Cancel">
                        Cancel
                    </MudButton>
                    <MudButton Variant="Variant.Filled" 
                              Color="Color.Primary" 
                              OnClick="ImportRequest"
                              Disabled="@_isImporting">
                        @if (_isImporting)
                        {
                            <MudProgressCircular Size="Size.Small" Indeterminate="true" />
                            <MudText Class="ml-2">Importing...</MudText>
                        }
                        else
                        {
                            <MudIcon Icon="@Icons.Material.Filled.Upload" Class="mr-2" />
                            <span>Import</span>
                        }
                    </MudButton>
                </MudStack>

                <!-- Result Message -->
                @if (!string.IsNullOrEmpty(_resultMessage))
                {
                    <MudAlert Severity="@(_importSuccess ? Severity.Success : Severity.Error)" 
                             Variant="Variant.Filled"
                             Class="mt-4">
                        @_resultMessage
                    </MudAlert>
                }

                <!-- Warnings -->
                @if (_warnings.Any())
                {
                    <MudAlert Severity="Severity.Warning" Variant="Variant.Outlined" Class="mt-2">
                        <MudText Typo="Typo.subtitle2" Class="mb-2">Warnings:</MudText>
                        <MudList T="string" Dense="true">
                            @foreach (var warning in _warnings)
                            {
                                <MudListItem T="string">@warning</MudListItem>
                            }
                        </MudList>
                    </MudAlert>
                }
            </MudStack>
        </MudForm>
    </MudPaper>

    <!-- Example Section -->
    <MudPaper Class="pa-6 mt-6" Elevation="1">
        <MudText Typo="Typo.h6" Class="mb-3">
            <MudIcon Icon="@Icons.Material.Filled.Info" Class="mr-2" />
            @if (_selectedSource == ImportSource.Curl)
            {
                <text>Example curl Commands</text>
            }
            else
            {
                <text>Example Bruno Files</text>
            }
        </MudText>
        
        @if (_selectedSource == ImportSource.Curl)
        {
            <MudStack Spacing="3">
                <div>
                    <MudText Typo="Typo.subtitle2" Class="mb-2">Simple GET request:</MudText>
                    <MudPaper Class="pa-3" Outlined="true">
                        <code class="code-example">curl 'https://api.github.com/users/octocat'</code>
                    </MudPaper>
                </div>
                <div>
                    <MudText Typo="Typo.subtitle2" Class="mb-2">POST request with JSON body:</MudText>
                    <MudPaper Class="pa-3" Outlined="true">
                        <code class="code-example">curl -X POST 'https://api.example.com/users' -H 'Content-Type: application/json' -d '{"name":"John","email":"john@example.com"}'</code>
                    </MudPaper>
                </div>
                <div>
                    <MudText Typo="Typo.subtitle2" Class="mb-2">Request with Bearer token:</MudText>
                    <MudPaper Class="pa-3" Outlined="true">
                        <code class="code-example">curl 'https://api.example.com/protected' -H 'Authorization: Bearer your-token-here'</code>
                    </MudPaper>
                </div>
                <div>
                    <MudText Typo="Typo.subtitle2" Class="mb-2">Request with Basic authentication:</MudText>
                    <MudPaper Class="pa-3" Outlined="true">
                        <code class="code-example">curl -u username:password 'https://api.example.com/protected'</code>
                    </MudPaper>
                </div>
            </MudStack>
        }
        else
        {
            <MudStack Spacing="3">
                <div>
                    <MudText Typo="Typo.subtitle2" Class="mb-2">Simple GET request:</MudText>
                    <MudPaper Class="pa-3" Outlined="true">
                        <pre class="code-example">meta {
  name: Get Users
  type: http
}

get {
  url: https://api.example.com/users
  body: none
  auth: none
}</pre>
                    </MudPaper>
                </div>
                <div>
                    <MudText Typo="Typo.subtitle2" Class="mb-2">POST request with JSON body:</MudText>
                    <MudPaper Class="pa-3" Outlined="true">
                        <pre class="code-example">meta {
  name: Create User
  type: http
}

post {
  url: https://api.example.com/users
  body: json
}

body:json {
  {
    "name": "John Doe",
    "email": "john@example.com"
  }
}</pre>
                    </MudPaper>
                </div>
                <div>
                    <MudText Typo="Typo.subtitle2" Class="mb-2">Request with Bearer token:</MudText>
                    <MudPaper Class="pa-3" Outlined="true">
                        <pre class="code-example">meta {
  name: Get Protected Data
  type: http
}

get {
  url: https://api.example.com/protected
  auth: bearer
}

auth:bearer {
  token: your-token-here
}</pre>
                    </MudPaper>
                </div>
                <div>
                    <MudText Typo="Typo.subtitle2" Class="mb-2">GraphQL query:</MudText>
                    <MudPaper Class="pa-3" Outlined="true">
                        <pre class="code-example">meta {
  name: Get User
  type: graphql
}

post {
  url: https://api.example.com/graphql
  body: graphql
}

body:graphql {
  query GetUser($id: ID!) {
    user(id: $id) {
      id
      name
      email
    }
  }
}

body:graphql:vars {
  {
    "id": "123"
  }
}</pre>
                    </MudPaper>
                </div>
            </MudStack>
        }
    </MudPaper>
</MudContainer>

@code {
    private MudForm? _form;
    private IEnumerable<Collection>? _collections;
    
    private ImportSource _selectedSource = ImportSource.Curl;
    private Guid? _selectedCollectionId;
    private string _curlCommand = string.Empty;
    private string _brunoFileContent = string.Empty;
    private string? _selectedFileName;
    private string? _requestName;
    private bool _importFolder = false;
    private string _brunoFolderPath = string.Empty;
    
    private bool _isImporting;
    private bool _importSuccess;
    private string? _resultMessage;
    private List<string> _warnings = new();

    protected override async Task OnInitializedAsync()
    {
        await LoadCollections();
    }

    private async Task LoadCollections()
    {
        _collections = await CollectionService.GetAllCollectionsAsync();
        StateHasChanged();
    }

    private async Task BrowseBrunoFile()
    {
        try
        {
            var fileTypes = new FilePickerFileType(new Dictionary<DevicePlatform, IEnumerable<string>>
            {
                { DevicePlatform.iOS, new[] { "public.data" } },
                { DevicePlatform.Android, new[] { "application/octet-stream", "*/*" } },
                { DevicePlatform.WinUI, new[] { ".bru" } },
                { DevicePlatform.MacCatalyst, new[] { "bru" } },
            });

            var options = new PickOptions
            {
                FileTypes = fileTypes,
                PickerTitle = "Select a Bruno file (.bru)"
            };

            var result = await FilePicker.Default.PickAsync(options);
            
            if (result != null)
            {
                _selectedFileName = result.FileName;
                
                // Read file content
                using var stream = await result.OpenReadAsync();
                using var reader = new StreamReader(stream);
                _brunoFileContent = await reader.ReadToEndAsync();
                
                StateHasChanged();
            }
        }
        catch (Exception ex)
        {
            Snackbar.Add($"Error reading file: {ex.Message}", Severity.Error);
        }
    }

    private async Task ImportRequest()
    {
        if (_form == null)
            return;

        await _form.Validate();
        if (!_form.IsValid)
            return;

        if (!_selectedEnvironmentId.HasValue)
        {
            Snackbar.Add("Please select an environment", Severity.Error);
            return;
        }

        if (_selectedSource == ImportSource.Curl && string.IsNullOrWhiteSpace(_curlCommand))
        {
            Snackbar.Add("Please enter a curl command", Severity.Error);
            return;
        }

        if (_selectedSource == ImportSource.Bruno)
        {
            if (_importFolder && string.IsNullOrWhiteSpace(_brunoFolderPath))
            {
                Snackbar.Add("Please enter a folder path", Severity.Error);
                return;
            }
            
            if (!_importFolder && string.IsNullOrWhiteSpace(_brunoFileContent))
            {
                Snackbar.Add("Please select a Bruno file", Severity.Error);
                return;
            }
        }

        _isImporting = true;
        _resultMessage = null;
        _warnings.Clear();
        StateHasChanged();

        try
        {
            ImportResult result;

            if (_selectedSource == ImportSource.Curl)
            {
                result = await ImportService.ImportFromCurlAsync(_curlCommand, _selectedCollectionId, _requestName);
            }
            else if (_selectedSource == ImportSource.Bruno)
            {
                if (_importFolder)
                {
                    result = await ImportService.ImportFromBrunoFolderAsync(_brunoFolderPath, _selectedCollectionId);
                }
                else
                {
                    result = await ImportService.ImportFromBrunoAsync(_brunoFileContent, _selectedCollectionId, _requestName);
                }
            }
            else
            {
                result = new ImportResult
                {
                    Success = false,
                    ErrorMessage = "This import source is not yet supported"
                };
            }

            _importSuccess = result.Success;
            _warnings = result.Warnings;

            if (result.Success)
            {
                // Handle folder import results
                if (result.ImportedRequests.Count > 0)
                {
                    _resultMessage = $"Successfully imported {result.SuccessfulImports} request(s) from {result.TotalFilesProcessed} file(s)";
                    if (result.ImportedCollections.Count > 0)
                    {
                        _resultMessage += $" and created {result.ImportedCollections.Count} collection(s)";
                    }
                    Snackbar.Add(_resultMessage, Severity.Success);
                    
                    // Navigate to home after a short delay
                    await Task.Delay(1500);
                    NavigationManager.NavigateTo("/");
                }
                // Handle single file import results
                else if (result.ImportedRequest != null)
                {
                    _resultMessage = $"Successfully imported request: {result.ImportedRequest.Name}";
                    Snackbar.Add(_resultMessage, Severity.Success);
                    
                    // Navigate to home after a short delay
                    await Task.Delay(1500);
                    NavigationManager.NavigateTo("/");
                }
                else
                {
                    _resultMessage = result.ErrorMessage ?? "Import completed but no requests were imported";
                    Snackbar.Add(_resultMessage, Severity.Warning);
                }
            }
            else
            {
                _resultMessage = result.ErrorMessage ?? "Failed to import request";
                Snackbar.Add(_resultMessage, Severity.Error);
            }
        }
        catch (Exception ex)
        {
            _importSuccess = false;
            _resultMessage = $"Error: {ex.Message}";
            Snackbar.Add(_resultMessage, Severity.Error);
        }
        finally
        {
            _isImporting = false;
            StateHasChanged();
        }
    }

    private void Cancel()
    {
        NavigationManager.NavigateTo("/");
    }
}
