@page "/variables/matrix"
@inject IEnvironmentService EnvironmentService
@inject IActiveEnvironmentService ActiveEnvironmentService
@inject ISecretVariablesService SecretVariablesService
@inject ISettingsService SettingsService
@inject NavigationManager NavigationManager
@inject ISnackbar Snackbar

<MudContainer MaxWidth="MaxWidth.ExtraLarge" Class="mt-4">
    <MudStack Spacing="4">
        <MudStack Row="true" Justify="Justify.SpaceBetween" AlignItems="AlignItems.Center">
            <div>
                <MudText Typo="Typo.h4">Variable Matrix</MudText>
                <MudText Typo="Typo.body1" Color="Color.Secondary">
                    Manage the same variables across all environments in one place
                </MudText>
            </div>
            <MudStack Row="true" Spacing="2">
                <MudButton Variant="Variant.Outlined" 
                          Color="Color.Primary" 
                          StartIcon="@Icons.Material.Filled.Add"
                          OnClick="AddVariable">
                    Add Variable
                </MudButton>
                <MudButton Variant="Variant.Filled" 
                          Color="Color.Success" 
                          StartIcon="@Icons.Material.Filled.Save"
                          OnClick="SaveChanges"
                          Disabled="@(!_hasChanges)">
                    Save All Changes
                </MudButton>
            </MudStack>
        </MudStack>

        @if (_environments == null)
        {
            <MudProgressCircular Indeterminate="true" />
        }
        else if (!_environments.Any())
        {
            <MudAlert Severity="Severity.Info">
                No environments exist. Create at least one environment to manage variables.
            </MudAlert>
            <MudButton Variant="Variant.Filled" Color="Color.Primary" OnClick="@(() => NavigationManager.NavigateTo("/environment/create"))">
                Create Environment
            </MudButton>
        }
        else
        {
            <MudPaper Elevation="2" Class="pa-4">
                <MudAlert Severity="Severity.Info" Class="mb-4">
                    Drag and drop the environment column headers to reorder them. The order will be saved automatically.
                </MudAlert>
                
                <MudDropContainer T="EnvironmentDropItem" Items="@_environmentDropItems" ItemsSelector="@((item, dropzone) => true)" ItemDropped="OnEnvironmentDropped" Class="mb-4">
                    <ChildContent>
                        <MudStack Row="true" Spacing="2" Class="mb-3">
                            <MudPaper Class="pa-2" Style="width: 200px;">
                                <MudText Typo="Typo.body2"><strong>Variable Key</strong></MudText>
                            </MudPaper>
                            <MudDropZone T="EnvironmentDropItem" Identifier="environments" Class="flex-grow-1">
                                <MudStack Row="true" Spacing="2">
                                    @foreach (var envItem in _environmentDropItems.OrderBy(e => e.Order))
                                    {
                                        <MudPaper Class="pa-2 cursor-move" Style="min-width: 180px;" Elevation="1">
                                            <MudStack Spacing="1">
                                                <MudStack Row="true" AlignItems="AlignItems.Center" Spacing="1" Justify="Justify.SpaceBetween">
                                                    <MudStack Row="true" AlignItems="AlignItems.Center" Spacing="1">
                                                        <MudIcon Icon="@Icons.Material.Filled.DragIndicator" Size="Size.Small" Color="Color.Default" />
                                                        @if (envItem.Environment.Id == _activeEnvironmentId)
                                                        {
                                                            <MudIcon Icon="@Icons.Material.Filled.CheckCircle" Size="Size.Small" Color="Color.Success" />
                                                        }
                                                        <MudText Typo="Typo.body2"><strong>@envItem.Environment.Name</strong></MudText>
                                                    </MudStack>
                                                </MudStack>
                                            </MudStack>
                                        </MudPaper>
                                    }
                                </MudStack>
                            </MudDropZone>
                            <MudPaper Class="pa-2" Style="width: 80px;">
                                <MudText Typo="Typo.body2"><strong>Actions</strong></MudText>
                            </MudPaper>
                        </MudStack>
                    </ChildContent>
                </MudDropContainer>
                
                <MudTable Items="@_variableRows" Hover="true" Dense="true" Striped="true">
                    <HeaderContent>
                        <MudTh Style="width: 200px;">Variable Key</MudTh>
                        @foreach (var envItem in _environmentDropItems.OrderBy(e => e.Order))
                        {
                            <MudTh>@envItem.Environment.Name</MudTh>
                        }
                        <MudTh Style="width: 80px;">Actions</MudTh>
                    </HeaderContent>
                    <RowTemplate>
                        <MudTd DataLabel="Variable Key">
                            <MudTextField @bind-Value="context.Key" 
                                        Variant="Variant.Outlined" 
                                        Margin="Margin.Dense"
                                        Placeholder="VARIABLE_KEY"
                                        OnKeyUp="@(() => MarkChanged())" />
                        </MudTd>
                        @foreach (var envItem in _environmentDropItems.OrderBy(e => e.Order))
                        {
                            <MudTd DataLabel="@envItem.Environment.Name">
                                @{
                                    var value = context.Values.GetValueOrDefault(envItem.Environment.Id, "");
                                    var isSecret = context.SecretFlags.GetValueOrDefault(envItem.Environment.Id, false);
                                }
                                <MudStack Row="true" Spacing="1" AlignItems="AlignItems.Center">
                                    <MudTextField @bind-Value="@context.Values[envItem.Environment.Id]" 
                                                Variant="Variant.Outlined" 
                                                Margin="Margin.Dense"
                                                Placeholder="value"
                                                InputType="@(isSecret ? InputType.Password : InputType.Text)"
                                                OnKeyUp="@(() => MarkChanged())"
                                                Class="flex-grow-1" />
                                    <MudIconButton Icon="@(isSecret ? Icons.Material.Filled.Lock : Icons.Material.Filled.LockOpen)" 
                                                 Size="Size.Small"
                                                 Color="@(isSecret ? Color.Warning : Color.Default)"
                                                 OnClick="@(() => ToggleSecret(context, envItem.Environment.Id))"
                                                 Title="@(isSecret ? "Secret variable" : "Regular variable")" />
                                </MudStack>
                            </MudTd>
                        }
                        <MudTd>
                            <MudIconButton Icon="@Icons.Material.Filled.Delete" 
                                         Color="Color.Error" 
                                         Size="Size.Small"
                                         OnClick="@(() => RemoveVariable(context))" />
                        </MudTd>
                    </RowTemplate>
                </MudTable>
                
                @if (_hasChanges)
                {
                    <MudAlert Severity="Severity.Warning" Class="mt-4">
                        You have unsaved changes. Click "Save All Changes" to apply them.
                    </MudAlert>
                }
            </MudPaper>
        }
    </MudStack>
</MudContainer>

@code {
    private IEnumerable<Domain.Entities.Environment>? _environments;
    private Guid? _activeEnvironmentId;
    private List<VariableRow> _variableRows = new();
    private List<EnvironmentDropItem> _environmentDropItems = new();
    private bool _hasChanges = false;

    protected override async Task OnInitializedAsync()
    {
        await LoadData();
    }

    private async Task LoadData()
    {
        _environments = await EnvironmentService.GetAllEnvironmentsAsync();
        _activeEnvironmentId = await ActiveEnvironmentService.GetActiveEnvironmentIdAsync();
        
        if (_environments != null && _environments.Any())
        {
            // Load secrets for each environment to ensure values are populated
            foreach (var env in _environments)
            {
                var secrets = await SecretVariablesService.GetEnvironmentSecretsAsync(env.Id);
                foreach (var secret in secrets)
                {
                    env.Variables[secret.Key] = secret.Value;
                }
            }
            
            // Load environment order from settings
            var settings = await SettingsService.GetSettingsAsync();
            var orderedEnvironments = OrderEnvironments(_environments, settings.EnvironmentOrder);
            
            // Create drop items with order
            _environmentDropItems = orderedEnvironments.Select((env, index) => new EnvironmentDropItem
            {
                Environment = env,
                Order = index
            }).ToList();
            
            var allKeys = _environments
                .SelectMany(e => e.Variables.Keys)
                .Distinct()
                .OrderBy(k => k);

            _variableRows = allKeys.Select(key => 
            {
                var row = new VariableRow { Key = key };
                foreach (var env in _environments)
                {
                    row.Values[env.Id] = env.Variables.GetValueOrDefault(key, "");
                    row.SecretFlags[env.Id] = env.SecretVariableNames.Contains(key);
                }
                return row;
            }).ToList();
        }
        
        _hasChanges = false;
    }

    private List<Domain.Entities.Environment> OrderEnvironments(IEnumerable<Domain.Entities.Environment> environments, List<Guid> order)
    {
        if (order == null || !order.Any())
        {
            // Default to alphabetical order by name
            return environments.OrderBy(e => e.Name).ToList();
        }
        
        var envDict = environments.ToDictionary(e => e.Id);
        var orderedEnvs = new List<Domain.Entities.Environment>();
        
        // Add environments in the saved order
        foreach (var id in order)
        {
            if (envDict.TryGetValue(id, out var env))
            {
                orderedEnvs.Add(env);
                envDict.Remove(id);
            }
        }
        
        // Add any new environments that weren't in the saved order (alphabetically)
        orderedEnvs.AddRange(envDict.Values.OrderBy(e => e.Name));
        
        return orderedEnvs;
    }

    private async Task OnEnvironmentDropped(MudItemDropInfo<EnvironmentDropItem> dropInfo)
    {
        if (dropInfo.Item == null) return;
        
        // Remove the dropped item from its current position
        _environmentDropItems.Remove(dropInfo.Item);
        
        // Insert at the new position
        var newIndex = dropInfo.IndexInZone;
        if (newIndex >= _environmentDropItems.Count)
        {
            _environmentDropItems.Add(dropInfo.Item);
        }
        else
        {
            _environmentDropItems.Insert(newIndex, dropInfo.Item);
        }
        
        // Update order values
        for (int i = 0; i < _environmentDropItems.Count; i++)
        {
            _environmentDropItems[i].Order = i;
        }
        
        // Save the new order to settings
        await SaveEnvironmentOrder();
        
        StateHasChanged();
    }

    private async Task SaveEnvironmentOrder()
    {
        var settings = await SettingsService.GetSettingsAsync();
        settings.EnvironmentOrder = _environmentDropItems.OrderBy(e => e.Order).Select(e => e.Environment.Id).ToList();
        await SettingsService.SaveSettingsAsync(settings);
        // Order is saved silently - no notification to avoid spam during multiple reorderings
    }

    private void AddVariable()
    {
        var newRow = new VariableRow { Key = $"NEW_VARIABLE_{_variableRows.Count + 1}" };
        
        if (_environments != null)
        {
            foreach (var env in _environments)
            {
                newRow.Values[env.Id] = "";
                newRow.SecretFlags[env.Id] = false;
            }
        }
        
        _variableRows.Add(newRow);
        MarkChanged();
    }

    private void RemoveVariable(VariableRow row)
    {
        _variableRows.Remove(row);
        MarkChanged();
    }

    private void ToggleSecret(VariableRow row, Guid envId)
    {
        row.SecretFlags[envId] = !row.SecretFlags[envId];
        MarkChanged();
    }

    private void MarkChanged()
    {
        _hasChanges = true;
    }

    private async Task SaveChanges()
    {
        try
        {
            if (_environments == null) return;

            foreach (var env in _environments)
            {
                env.Variables.Clear();
                env.SecretVariableNames.Clear();

                foreach (var row in _variableRows.Where(r => !string.IsNullOrWhiteSpace(r.Key)))
                {
                    var value = row.Values.GetValueOrDefault(env.Id, "");
                    // Always save the variable, even if empty, to preserve secret flags
                    env.Variables[row.Key] = value;
                    if (row.SecretFlags.GetValueOrDefault(env.Id, false))
                    {
                        env.SecretVariableNames.Add(row.Key);
                    }
                }

                await EnvironmentService.UpdateEnvironmentAsync(env);
            }

            _hasChanges = false;
            Snackbar.Add("All variables saved successfully", Severity.Success);
        }
        catch (Exception ex)
        {
            Snackbar.Add($"Error saving variables: {ex.Message}", Severity.Error);
        }
    }

    private class VariableRow
    {
        public string Key { get; set; } = string.Empty;
        public Dictionary<Guid, string> Values { get; set; } = new();
        public Dictionary<Guid, bool> SecretFlags { get; set; } = new();
    }
    
    private class EnvironmentDropItem
    {
        public Domain.Entities.Environment Environment { get; set; } = null!;
        public int Order { get; set; }
    }
}
