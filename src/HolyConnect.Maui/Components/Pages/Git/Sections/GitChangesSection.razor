@using HolyConnect.Infrastructure.Services
@using HolyConnect.Application.Interfaces

<!-- Commit Changes -->
<MudCard Class="mb-4">
    <MudCardContent>
        <MudText Typo="Typo.h6" Class="mb-3">Commit Changes</MudText>
        
        @if (FileChanges.Any())
        {
            <MudStack Row="true" Justify="Justify.SpaceBetween" AlignItems="AlignItems.Center" Class="mb-2">
                <MudText Typo="Typo.subtitle2">Files to Commit:</MudText>
                @if (FileChanges.Any(f => !f.IsStaged))
                {
                    <MudButton Size="Size.Small" 
                              Variant="Variant.Outlined" 
                              Color="Color.Primary"
                              OnClick="OnStageAll"
                              StartIcon="@Icons.Material.Filled.DoneAll">
                        Stage All
                    </MudButton>
                }
            </MudStack>
            <MudPaper Class="pa-3 mb-3" Outlined="true" Style="max-height: 18.75rem; overflow-y: auto;">
                <MudList T="string" Dense="true">
                    @foreach (var file in FileChanges)
                    {
                        <MudListItem T="string">
                            <MudStack Row="true" Justify="Justify.SpaceBetween" AlignItems="AlignItems.Center">
                                <div style="flex-grow: 1;">
                                    <MudText Typo="Typo.body2">
                                        <MudChip Size="Size.Small" Color="@GetFileStatusColor(file.Status)" Variant="Variant.Text">
                                            @file.Status
                                        </MudChip>
                                        @file.FilePath
                                    </MudText>
                                </div>
                                <MudStack Row="true" Spacing="1">
                                    <MudButton Size="Size.Small" 
                                              Variant="Variant.Text" 
                                              Color="Color.Info"
                                              OnClick="@(() => HandleShowDiff(file.FilePath))"
                                              StartIcon="@Icons.Material.Filled.Difference">
                                        Diff
                                    </MudButton>
                                    @if (!file.IsStaged)
                                    {
                                        <MudButton Size="Size.Small" 
                                                  Variant="Variant.Text" 
                                                  OnClick="@(() => HandleStageFile(file.FilePath))"
                                                  StartIcon="@Icons.Material.Filled.Add">
                                            Stage
                                        </MudButton>
                                    }
                                    else
                                    {
                                        <MudButton Size="Size.Small" 
                                                  Variant="Variant.Text" 
                                                  OnClick="@(() => HandleUnstageFile(file.FilePath))"
                                                  StartIcon="@Icons.Material.Filled.Remove">
                                            Unstage
                                        </MudButton>
                                    }
                                    <MudButton Size="Size.Small" 
                                              Variant="Variant.Text" 
                                              Color="Color.Error"
                                              OnClick="@(() => HandleRevertFile(file.FilePath))"
                                              StartIcon="@Icons.Material.Filled.Undo">
                                        Revert
                                    </MudButton>
                                </MudStack>
                            </MudStack>
                        </MudListItem>
                    }
                </MudList>
            </MudPaper>
        }
        
        <MudTextField @bind-Value="CommitMessage" 
                     Label="Commit Message" 
                     Variant="Variant.Outlined" 
                     Lines="3"
                     Class="mb-3" />
        
        <MudButton Variant="Variant.Filled" 
                  Color="Color.Primary" 
                  OnClick="OnCommit"
                  Disabled="@(string.IsNullOrWhiteSpace(CommitMessage) || !FileChanges.Any(f => f.IsStaged))"
                  StartIcon="@Icons.Material.Filled.Save">
            Commit Staged Changes
        </MudButton>
    </MudCardContent>
</MudCard>

@code {
    [Parameter] public IEnumerable<GitFileChange> FileChanges { get; set; } = Enumerable.Empty<GitFileChange>();
    [Parameter] public string CommitMessage { get; set; } = string.Empty;
    [Parameter] public EventCallback<string> CommitMessageChanged { get; set; }
    
    [Parameter] public EventCallback OnCommit { get; set; }
    [Parameter] public EventCallback OnStageAll { get; set; }
    [Parameter] public EventCallback<string> OnStageFile { get; set; }
    [Parameter] public EventCallback<string> OnUnstageFile { get; set; }
    [Parameter] public EventCallback<string> OnRevertFile { get; set; }
    [Parameter] public EventCallback<string> OnShowDiff { get; set; }

    private async Task HandleStageFile(string filePath)
    {
        await OnStageFile.InvokeAsync(filePath);
    }

    private async Task HandleUnstageFile(string filePath)
    {
        await OnUnstageFile.InvokeAsync(filePath);
    }

    private async Task HandleRevertFile(string filePath)
    {
        await OnRevertFile.InvokeAsync(filePath);
    }

    private async Task HandleShowDiff(string filePath)
    {
        await OnShowDiff.InvokeAsync(filePath);
    }

    private Color GetFileStatusColor(string status)
    {
        return status switch
        {
            "Added" => Color.Success,
            "Modified" => Color.Warning,
            "Deleted" => Color.Error,
            "Untracked" => Color.Info,
            "Renamed" => Color.Primary,
            _ => Color.Default
        };
    }
}
