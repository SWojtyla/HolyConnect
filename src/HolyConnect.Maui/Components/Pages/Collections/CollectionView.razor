@page "/collection/{CollectionId:guid}"
@page "/collection/{CollectionId:guid}/request/{RequestId:guid}"
@using HolyConnect.Domain.Entities
@using HolyConnect.Application.Common
@inject ICollectionService CollectionService
@inject IRequestService RequestService
@inject IActiveEnvironmentService ActiveEnvironmentService
@inject IEnvironmentService EnvironmentService
@inject NavigationManager NavigationManager
@inject ISnackbar Snackbar
@inject IDialogService DialogService
@implements IDisposable

<MudContainer MaxWidth="MaxWidth.False" Class="d-flex pa-0" Style="height: calc(100vh - 4rem);">
    <MudPaper Elevation="2" Class="overflow-y-auto flex-shrink-0" Style="width: 20rem; min-width: 20rem; border-right: 1px solid var(--mud-palette-divider);">
        @if (_collection != null)
        {
            <MudToolBar Dense="true" Class="mud-theme-primary">
                <MudTooltip Text="@_collection.Name">
                    <MudText Typo="Typo.h6" Class="text-truncate">@_collection.Name</MudText>
                </MudTooltip>
                <MudSpacer />
                <MudIconButton Icon="@Icons.Material.Filled.Edit" Size="Size.Small" OnClick="EditCollection" Title="Edit collection" Color="Color.Inherit" />
                <MudIconButton Icon="@Icons.Material.Filled.Delete" Size="Size.Small" Color="Color.Inherit" OnClick="DeleteCollection" Title="Delete collection" />
                <MudIconButton Icon="@Icons.Material.Filled.Add" Size="Size.Small" OnClick="ShowCreateMenu" Title="Add sub-collection or request" Color="Color.Inherit" />
            </MudToolBar>
            
            <div>
                @* Collection-level requests *@
                @if (_collectionRequests != null && _collectionRequests.Any())
                {
                    <MudText Typo="Typo.body2" Class="pa-2 mt-2" Color="Color.Primary"><strong>Requests</strong></MudText>
                    @foreach (var request in _collectionRequests)
                    {
                        <div class="d-flex align-center justify-space-between py-0 px-2 rounded mb-0" 
                             Style="@GetRequestStyle(request)"
                             @onclick="@(() => SelectRequest(request))">
                            <MudText Style="flex: 1;" Class="d-flex align-center cursor-pointer">
                                <MudIcon Icon="@GetRequestIcon(request.Type)" Size="Size.Small" Color="@GetRequestColor(request.Type)" Class="mr-1" />
                                <span style="font-size: 0.875rem;">@request.Name</span>
                            </MudText>
                            <div style="display: flex; gap: 0.25rem;" @onclick:stopPropagation="true">
                                <MudIconButton Icon="@Icons.Material.Filled.Edit" Size="Size.Small" OnClick="@(() => RenameRequest(request))" title="Rename request" Class="pa-1" />
                                <MudIconButton Icon="@Icons.Material.Filled.Delete" Size="Size.Small" Color="Color.Error" OnClick="@(() => DeleteRequest(request))" title="Delete request" Class="pa-1" />
                            </div>
                        </div>
                    }
                }

                @* Sub-collections *@
                @if (_subCollections != null && _subCollections.Any())
                {
                    <MudText Typo="Typo.body2" Class="pa-2 mt-3" Color="Color.Primary"><strong>Sub-Collections</strong></MudText>
                    @foreach (var subCollection in _subCollections)
                    {
                        <CollectionTreeItem Collection="@subCollection" 
                                          OnSelect="SelectSubCollection" 
                                          OnRequestSelect="SelectRequest"
                                          OnCollectionUpdated="HandleCollectionUpdated"
                                          OnRequestUpdated="HandleRequestUpdated"
                                          SelectedCollectionId="@_selectedSubCollection?.Id"
                                          SelectedRequestId="@_selectedRequest?.Id" />
                    }
                }
                
                @if ((_subCollections == null || !_subCollections.Any()) && (_collectionRequests == null || !_collectionRequests.Any()))
                {
                    <MudAlert Severity="Severity.Info" Variant="Variant.Outlined" Class="ma-4">
                        No sub-collections or requests yet. Click the + button to add one!
                    </MudAlert>
                }
            </div>
        }
    </MudPaper>

    <MudPaper Class="flex-grow-1 overflow-y-auto pa-4" Elevation="0">
        @if (_selectedSubCollection != null)
        {
            <MudBreadcrumbs Items="@GetBreadcrumbs()" Class="mb-4"></MudBreadcrumbs>
            <MudStack Row="true" Justify="Justify.SpaceBetween" AlignItems="AlignItems.Center" Class="mb-4">
                <div>
                    <MudText Typo="Typo.h5" Class="mb-2">@_selectedSubCollection.Name</MudText>
                    @if (!string.IsNullOrEmpty(_selectedSubCollection.Description))
                    {
                        <MudText Typo="Typo.body1" Color="Color.Secondary">@_selectedSubCollection.Description</MudText>
                    }
                </div>
                <MudButton Variant="Variant.Filled" Color="Color.Primary" OnClick="CreateRequest" StartIcon="@Icons.Material.Filled.Add">
                    New Request
                </MudButton>
            </MudStack>

            <MudText Typo="Typo.h6" Class="mb-3">Requests in this Collection</MudText>
            @if (_selectedSubCollection.Requests != null && _selectedSubCollection.Requests.Any())
            {
                <MudGrid Spacing="2">
                    @foreach (var request in _selectedSubCollection.Requests)
                    {
                        <MudItem xs="12" sm="6" md="4">
                            <MudPaper Class="pa-3 cursor-pointer" Outlined="true" @onclick="@(() => SelectRequest(request))">
                                <MudStack Spacing="1">
                                    <MudStack Row="true" AlignItems="AlignItems.Center" Spacing="1">
                                        <MudIcon Icon="@GetRequestIcon(request.Type)" Size="Size.Small" Color="@GetRequestColor(request.Type)" />
                                        <MudTooltip Text="@request.Name">
                                            <MudText Typo="Typo.subtitle1" Class="text-truncate"><strong>@request.Name</strong></MudText>
                                        </MudTooltip>
                                    </MudStack>
                                    <MudChip T="string" Size="Size.Small" Color="@GetRequestColor(request.Type)">@request.Type.ToString()</MudChip>
                                </MudStack>
                            </MudPaper>
                        </MudItem>
                    }
                </MudGrid>
            }
            else
            {
                <MudAlert Severity="Severity.Info" Variant="Variant.Outlined">
                    No requests in this collection. Click "New Request" to add one!
                </MudAlert>
            }
        }
        else if (_selectedRequest != null)
        {
            <RequestEditor Request="@_selectedRequest" 
                         Environment="@_activeEnvironment" 
                         Collection="@_selectedRequestCollection"
                         OnSave="HandleRequestSaved" />
        }
        else if (_collection != null)
        {
            @* Show collection overview when no sub-item is selected *@
            <MudStack Row="true" Justify="Justify.SpaceBetween" AlignItems="AlignItems.Center" Class="mb-4">
                <div>
                    <MudText Typo="Typo.h5" Class="mb-2">@_collection.Name</MudText>
                    @if (!string.IsNullOrEmpty(_collection.Description))
                    {
                        <MudText Typo="Typo.body1" Color="Color.Secondary">@_collection.Description</MudText>
                    }
                </div>
                <MudButton Variant="Variant.Filled" Color="Color.Primary" OnClick="CreateRequest" StartIcon="@Icons.Material.Filled.Add">
                    New Request
                </MudButton>
            </MudStack>

            @if (_collection.Variables != null && _collection.Variables.Any())
            {
                <MudText Typo="Typo.h6" Class="mb-3">Collection Variables</MudText>
                <MudPaper Class="pa-3 mb-4" Outlined="true">
                    @foreach (var variable in _collection.Variables)
                    {
                        <MudStack Row="true" Justify="Justify.SpaceBetween" AlignItems="AlignItems.Center" Class="mb-2">
                            <MudText Typo="Typo.body2"><strong>@variable.Key:</strong> @(_collection.SecretVariableNames.Contains(variable.Key) ? "****" : variable.Value)</MudText>
                        </MudStack>
                    }
                </MudPaper>
            }

            <MudText Typo="Typo.h6" Class="mb-3">Requests (@(_collectionRequests?.Count() ?? 0))</MudText>
            @if (_collectionRequests != null && _collectionRequests.Any())
            {
                <MudGrid Spacing="2">
                    @foreach (var request in _collectionRequests)
                    {
                        <MudItem xs="12" sm="6" md="4">
                            <MudPaper Class="pa-3 cursor-pointer" Outlined="true" @onclick="@(() => SelectRequest(request))">
                                <MudStack Spacing="1">
                                    <MudStack Row="true" AlignItems="AlignItems.Center" Spacing="1">
                                        <MudIcon Icon="@GetRequestIcon(request.Type)" Size="Size.Small" Color="@GetRequestColor(request.Type)" />
                                        <MudTooltip Text="@request.Name">
                                            <MudText Typo="Typo.subtitle1" Class="text-truncate"><strong>@request.Name</strong></MudText>
                                        </MudTooltip>
                                    </MudStack>
                                    <MudChip T="string" Size="Size.Small" Color="@GetRequestColor(request.Type)">@request.Type.ToString()</MudChip>
                                </MudStack>
                            </MudPaper>
                        </MudItem>
                    }
                </MudGrid>
            }
            else
            {
                <MudAlert Severity="Severity.Info" Variant="Variant.Outlined" Class="mt-3">
                    No requests in this collection. Click "New Request" to add one!
                </MudAlert>
            }

            @if (_subCollections != null && _subCollections.Any())
            {
                <MudText Typo="Typo.h6" Class="mb-3 mt-4">Sub-Collections (@_subCollections.Count())</MudText>
                <MudGrid Spacing="2">
                    @foreach (var subCol in _subCollections)
                    {
                        <MudItem xs="12" sm="6" md="4">
                            <MudPaper Class="pa-3 cursor-pointer" Outlined="true" @onclick="@(() => SelectSubCollection(subCol))">
                                <MudStack Spacing="1">
                                    <MudStack Row="true" AlignItems="AlignItems.Center" Spacing="1">
                                        <MudIcon Icon="@Icons.Material.Filled.Folder" Size="Size.Small" Color="Color.Info" />
                                        <MudText Typo="Typo.subtitle1"><strong>@subCol.Name</strong></MudText>
                                    </MudStack>
                                    <MudText Typo="Typo.body2" Color="Color.Secondary">@(subCol.Requests?.Count ?? 0) requests</MudText>
                                </MudStack>
                            </MudPaper>
                        </MudItem>
                    }
                </MudGrid>
            }
        }
    </MudPaper>
</MudContainer>

@code {
    [Parameter]
    public Guid CollectionId { get; set; }
    
    [Parameter]
    public Guid? RequestId { get; set; }

    private Domain.Entities.Collection? _collection;
    private IEnumerable<Domain.Entities.Collection>? _allCollections;
    private IEnumerable<Domain.Entities.Collection>? _subCollections;
    private IEnumerable<Domain.Entities.Request>? _collectionRequests;
    private Domain.Entities.Collection? _selectedSubCollection;
    private Domain.Entities.Request? _selectedRequest;
    private Domain.Entities.Collection? _selectedRequestCollection;
    private Domain.Entities.Environment? _activeEnvironment;

    protected override async Task OnInitializedAsync()
    {
        NavigationManager.LocationChanged += OnLocationChanged;
        await LoadData();
    }

    protected override async Task OnParametersSetAsync()
    {
        await LoadData();
    }

    private async void OnLocationChanged(object? sender, Microsoft.AspNetCore.Components.Routing.LocationChangedEventArgs e)
    {
        try
        {
            await LoadData();
            StateHasChanged();
        }
        catch { }
    }

    private async Task LoadData()
    {
        _collection = await CollectionService.GetCollectionByIdAsync(CollectionId);
        if (_collection == null)
        {
            Snackbar.Add("Collection not found", Severity.Error);
            NavigationManager.NavigateTo("/");
            return;
        }

        var allCollections = await CollectionService.GetAllCollectionsAsync();
        var allRequests = await RequestService.GetAllRequestsAsync();
        
        // Build hierarchy to populate SubCollections navigation property
        var hierarchicalCollections = CollectionHierarchyHelper.BuildHierarchy(allCollections);
        
        // Flatten back to get all collections with populated SubCollections
        _allCollections = CollectionHierarchyHelper.FlattenHierarchy(hierarchicalCollections);
        
        // Populate Requests navigation property for all collections
        CollectionHierarchyHelper.PopulateRequests(_allCollections, allRequests);
        
        // Find direct subcollections of the current collection
        _subCollections = _allCollections.Where(c => c.ParentCollectionId == CollectionId);
        
        // Find requests directly in this collection
        _collectionRequests = allRequests.Where(r => r.CollectionId == CollectionId);
        
        // Load the active environment with secrets for variable resolution
        var activeEnvId = await ActiveEnvironmentService.GetActiveEnvironmentIdAsync();
        if (activeEnvId.HasValue)
        {
            _activeEnvironment = await EnvironmentService.GetEnvironmentByIdAsync(activeEnvId.Value);
        }
        
        // If RequestId is provided in the URL, automatically select that request
        if (RequestId.HasValue)
        {
            var requestToSelect = allRequests.FirstOrDefault(r => r.Id == RequestId.Value);
            if (requestToSelect != null)
            {
                SelectRequest(requestToSelect);
            }
        }
    }

    private void SelectSubCollection(Domain.Entities.Collection collection)
    {
        _selectedSubCollection = collection;
        _selectedRequest = null;
        StateHasChanged();
    }

    private void SelectRequest(Domain.Entities.Request request)
    {
        _selectedRequest = request;
        _selectedSubCollection = null;
        
        // Find the collection for this request
        _selectedRequestCollection = null;
        if (request.CollectionId.HasValue && _allCollections != null)
        {
            _selectedRequestCollection = FindCollectionById(_allCollections, request.CollectionId.Value);
        }
        
        StateHasChanged();
    }
    
    private Domain.Entities.Collection? FindCollectionById(IEnumerable<Domain.Entities.Collection> collections, Guid id)
    {
        foreach (var collection in collections)
        {
            if (collection.Id == id)
            {
                return collection;
            }
            
            var found = FindCollectionById(collection.SubCollections, id);
            if (found != null)
            {
                return found;
            }
        }
        
        return null;
    }

    private void EditCollection()
    {
        NavigationManager.NavigateTo($"/collection/{_collection!.Id}/edit");
    }

    private async Task DeleteCollection()
    {
        bool? result = await DialogService.ShowMessageBox(
            "Delete Collection",
            $"Are you sure you want to delete the collection '{_collection!.Name}'? This will also delete all sub-collections and requests.",
            yesText: "Delete", cancelText: "Cancel");
        
        if (result == true)
        {
            await CollectionService.DeleteCollectionAsync(_collection.Id);
            Snackbar.Add("Collection deleted", Severity.Success);
            NavigationManager.NavigateTo("/");
        }
    }

    private async Task ShowCreateMenu()
    {
        var options = new DialogOptions { CloseOnEscapeKey = true };
        var parameters = new DialogParameters
        {
            ["Options"] = new List<string> { "New Request", "New Collection" }
        };

        var dialog = await DialogService.ShowAsync<SelectOptionDialog>("Create", parameters, options);
        var dialogResult = await dialog.Result;

        if (!dialogResult.Canceled && dialogResult.Data is string selection)
        {
            if (selection == "New Request")
            {
                CreateRequest();
            }
            else if (selection == "New Collection")
            {
                CreateSubCollection();
            }
        }
    }

    private void CreateRequest()
    {
        var targetCollectionId = _selectedSubCollection?.Id ?? CollectionId;
        NavigationManager.NavigateTo($"/collection/{targetCollectionId}/request/create");
    }

    private void CreateSubCollection()
    {
        NavigationManager.NavigateTo($"/collection/{CollectionId}/subcollection/create");
    }

    private async Task RenameRequest(Domain.Entities.Request request)
    {
        var parameters = new DialogParameters
        {
            ["CurrentName"] = request.Name
        };

        var dialog = await DialogService.ShowAsync<RenameDialog>("Rename Request", parameters);
        var result = await dialog.Result;

        if (!result.Canceled && result.Data is string newName && !string.IsNullOrWhiteSpace(newName))
        {
            request.Name = newName;
            await RequestService.UpdateRequestAsync(request);
            Snackbar.Add("Request renamed", Severity.Success);
            await LoadData();
        }
    }

    private async Task DeleteRequest(Domain.Entities.Request request)
    {
        bool? result = await DialogService.ShowMessageBox(
            "Delete Request",
            $"Are you sure you want to delete the request '{request.Name}'?",
            yesText: "Delete", cancelText: "Cancel");

        if (result == true)
        {
            await RequestService.DeleteRequestAsync(request.Id);
            Snackbar.Add("Request deleted", Severity.Success);
            
            if (_selectedRequest?.Id == request.Id)
            {
                _selectedRequest = null;
            }
            
            await LoadData();
        }
    }

    private void HandleCollectionUpdated((Guid CollectionId, string NewName, bool IsDelete) updateInfo)
    {
        Task.Run(async () =>
        {
            try
            {
                if (updateInfo.IsDelete)
                {
                    await CollectionService.DeleteCollectionAsync(updateInfo.CollectionId);
                    Snackbar.Add("Collection deleted", Severity.Success);
                }
                else if (!string.IsNullOrWhiteSpace(updateInfo.NewName))
                {
                    var collection = await CollectionService.GetCollectionByIdAsync(updateInfo.CollectionId);
                    if (collection != null)
                    {
                        collection.Name = updateInfo.NewName;
                        await CollectionService.UpdateCollectionAsync(collection);
                        Snackbar.Add("Collection renamed", Severity.Success);
                    }
                }
                
                await LoadData();
                await InvokeAsync(StateHasChanged);
            }
            catch (Exception ex)
            {
                Snackbar.Add($"Error updating collection: {ex.Message}", Severity.Error);
            }
        });
    }

    private void HandleRequestUpdated((Guid RequestId, string NewName, bool IsDelete) updateInfo)
    {
        Task.Run(async () =>
        {
            try
            {
                if (updateInfo.IsDelete)
                {
                    await RequestService.DeleteRequestAsync(updateInfo.RequestId);
                    Snackbar.Add("Request deleted", Severity.Success);
                    
                    if (_selectedRequest?.Id == updateInfo.RequestId)
                    {
                        _selectedRequest = null;
                    }
                }
                else if (!string.IsNullOrWhiteSpace(updateInfo.NewName))
                {
                    var request = await RequestService.GetRequestByIdAsync(updateInfo.RequestId);
                    if (request != null)
                    {
                        request.Name = updateInfo.NewName;
                        await RequestService.UpdateRequestAsync(request);
                        Snackbar.Add("Request renamed", Severity.Success);
                    }
                }
                
                await LoadData();
                await InvokeAsync(StateHasChanged);
            }
            catch (Exception ex)
            {
                Snackbar.Add($"Error updating request: {ex.Message}", Severity.Error);
            }
        });
    }
    
    private void HandleRequestSaved()
    {
        Task.Run(async () =>
        {
            try
            {
                if (_selectedRequest != null)
                {
                    await RequestService.UpdateRequestAsync(_selectedRequest);
                    Snackbar.Add("Request saved", Severity.Success);
                    await LoadData();
                    await InvokeAsync(StateHasChanged);
                }
            }
            catch (Exception ex)
            {
                Snackbar.Add($"Error saving request: {ex.Message}", Severity.Error);
            }
        });
    }

    private List<BreadcrumbItem> GetBreadcrumbs()
    {
        var breadcrumbs = new List<BreadcrumbItem>
        {
            new BreadcrumbItem("Collections", href: "/", icon: Icons.Material.Filled.Home),
            new BreadcrumbItem(_collection!.Name, href: $"/collection/{_collection.Id}", icon: Icons.Material.Filled.Folder)
        };

        if (_selectedSubCollection != null)
        {
            breadcrumbs.Add(new BreadcrumbItem(_selectedSubCollection.Name, href: null, disabled: true, icon: Icons.Material.Filled.Folder));
        }

        return breadcrumbs;
    }

    private string GetRequestStyle(Domain.Entities.Request request)
    {
        var isSelected = _selectedRequest?.Id == request.Id;
        return isSelected
            ? "background-color: var(--mud-palette-action-default-hover); cursor: pointer;"
            : "cursor: pointer;";
    }

    private string GetRequestIcon(RequestType requestType) => requestType switch
    {
        RequestType.Rest => Icons.Material.Filled.Http,
        RequestType.GraphQL => Icons.Material.Filled.GraphicEq,
        RequestType.WebSocket => Icons.Material.Filled.Cable,
        _ => Icons.Material.Filled.Code
    };

    private Color GetRequestColor(RequestType requestType) => requestType switch
    {
        RequestType.Rest => Color.Primary,
        RequestType.GraphQL => Color.Secondary,
        RequestType.WebSocket => Color.Tertiary,
        _ => Color.Default
    };

    public void Dispose()
    {
        NavigationManager.LocationChanged -= OnLocationChanged;
    }
}
