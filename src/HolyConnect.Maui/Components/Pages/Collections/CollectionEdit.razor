@page "/collection/{CollectionId:guid}/edit"
@using Microsoft.AspNetCore.WebUtilities
@inject ICollectionService CollectionService
@inject NavigationManager NavigationManager
@inject ISnackbar Snackbar

<MudContainer MaxWidth="MaxWidth.Large" Class="mt-4">
    <MudText Typo="Typo.h4" Class="mb-4">Edit Collection</MudText>

    @if (_collection != null)
    {
        <MudCard Class="mb-4">
            <MudCardContent>
                <MudTextField @bind-Value="_name" Label="Name" Required="true" Variant="Variant.Outlined" />
                <MudTextField @bind-Value="_description" Label="Description" Lines="3" Variant="Variant.Outlined" Class="mt-4" />
                
                <StaticVariableEditor Variables="_variables" />
            </MudCardContent>
        </MudCard>

        <DynamicVariableEditor DynamicVariables="_collection.DynamicVariables" />

        <MudCard>
            <MudCardActions>
                <MudButton Variant="Variant.Filled" Color="Color.Primary" OnClick="SaveCollection" Disabled="@(string.IsNullOrWhiteSpace(_name))">
                    Save
                </MudButton>
                <MudButton Variant="Variant.Outlined" Color="Color.Default" OnClick="Cancel">
                    Cancel
                </MudButton>
            </MudCardActions>
        </MudCard>
    }
    else
    {
        <MudText>Loading...</MudText>
    }
</MudContainer>

@code {
    [Parameter]
    public Guid CollectionId { get; set; }

    private Collection? _collection;
    private string _name = string.Empty;
    private string _description = string.Empty;
    private List<VariableModel> _variables = new();
    private Guid? _requestIdToPreserve;

    protected override async Task OnInitializedAsync()
    {
        // Extract requestId from query parameters
        var uri = new Uri(NavigationManager.Uri);
        var query = QueryHelpers.ParseQuery(uri.Query);
        if (query.TryGetValue("requestId", out var requestIdString) && Guid.TryParse(requestIdString, out var requestId))
        {
            _requestIdToPreserve = requestId;
        }
        
        _collection = await CollectionService.GetCollectionByIdAsync(CollectionId);
        
        if (_collection != null)
        {
            _name = _collection.Name;
            _description = _collection.Description ?? string.Empty;
            
            // Load existing variables
            foreach (var kvp in _collection.Variables)
            {
                _variables.Add(new VariableModel 
                { 
                    Key = kvp.Key, 
                    Value = kvp.Value,
                    IsSecret = _collection.SecretVariableNames.Contains(kvp.Key)
                });
            }
        }
    }

    private async Task SaveCollection()
    {
        if (_collection == null) return;


        try
        {
            _collection.Name = _name;
            _collection.Description = _description;
            
            // Clear and rebuild variables dictionary and secret names
            _collection.Variables.Clear();
            _collection.SecretVariableNames.Clear();
            foreach (var variable in _variables.Where(v => !string.IsNullOrWhiteSpace(v.Key)))
            {
                _collection.Variables[variable.Key] = variable.Value;
                if (variable.IsSecret)
                {
                    _collection.SecretVariableNames.Add(variable.Key);
                }
            }

            await CollectionService.UpdateCollectionAsync(_collection);
            
            Snackbar.Add($"Collection '{_name}' updated successfully", Severity.Success);
            NavigateBackWithRequest();
        }
        catch (InvalidOperationException ex) when (ex.Message.Contains("already exists"))
        {
            Snackbar.Add($"A collection with the name '{_name}' already exists. Please choose a different name.", Severity.Error);
        }
        catch (Exception ex)
        {
            Snackbar.Add($"Error updating collection: {ex.Message}", Severity.Error);
        }
    }

    private void Cancel()
    {
        NavigateBackWithRequest();
    }

    private void NavigateBackWithRequest()
    {
        if (_collection != null)
        {
            var url = $"/environment/{_collection.EnvironmentId}";
            if (_requestIdToPreserve.HasValue)
            {
                url += $"?requestId={_requestIdToPreserve.Value}";
            }
            NavigationManager.NavigateTo(url);
        }
        else
        {
            NavigationManager.NavigateTo("/");
        }
    }
}
