@page "/collection/create"
@page "/collection/{ParentCollectionId:guid}/subcollection/create"
@inject ICollectionService CollectionService
@inject NavigationManager NavigationManager
@inject ISnackbar Snackbar

<MudContainer MaxWidth="MaxWidth.Medium" Class="mt-4">
    <MudPaper Elevation="0" Class="pa-6">
        <MudStack Spacing="4">
            <MudStack Row="true" AlignItems="AlignItems.Center" Spacing="3">
                <MudIcon Icon="@(ParentCollectionId.HasValue ? Icons.Material.Filled.SubdirectoryArrowRight : Icons.Material.Filled.Folder)" 
                        Size="Size.Large" 
                        Color="Color.Primary" />
                <div>
                    <MudText Typo="Typo.h4" Color="Color.Primary">@(ParentCollectionId.HasValue ? "Create Sub-Collection" : "Create Collection")</MudText>
                    <MudText Typo="Typo.body2" Color="Color.Secondary">Organize your requests into @(ParentCollectionId.HasValue ? "a nested" : "a new") collection</MudText>
                </div>
            </MudStack>

            <MudDivider />

            <MudCard Elevation="2">
                <MudCardContent>
                    <MudStack Spacing="3">
                        <MudTextField @bind-Value="_name" 
                                     Label="Collection Name" 
                                     Required="true" 
                                     Variant="Variant.Outlined"
                                     Adornment="Adornment.Start"
                                     AdornmentIcon="@Icons.Material.Filled.Label"
                                     Placeholder="Auth, Users, Products, etc." />
                        
                        <MudTextField @bind-Value="_description" 
                                     Label="Description" 
                                     Lines="3" 
                                     Variant="Variant.Outlined"
                                     Adornment="Adornment.Start"
                                     AdornmentIcon="@Icons.Material.Filled.Description"
                                     Placeholder="Describe the collection's purpose" />
                        
                        <MudDivider Class="my-2" />
                        
                        <MudStack Row="true" AlignItems="AlignItems.Center" Spacing="2">
                            <MudIcon Icon="@Icons.Material.Filled.Code" Color="Color.Success" />
                            <MudText Typo="Typo.h6" Color="Color.Success">Collection Variables</MudText>
                        </MudStack>
                        <MudAlert Severity="Severity.Info" Variant="Variant.Outlined" Dense="true">
                            Collection variables override environment variables for all requests in this collection
                        </MudAlert>
                        
                        @if (_variables.Any())
                        {
                            @foreach (var variable in _variables)
                            {
                                <MudPaper Outlined="true" Class="pa-3">
                                    <MudGrid Spacing="2">
                                        <MudItem xs="5">
                                            <MudTextField @bind-Value="variable.Key" 
                                                        Label="Key" 
                                                        Variant="Variant.Outlined"
                                                        Placeholder="BASE_URL" />
                                        </MudItem>
                                        <MudItem xs="5">
                                            <MudTextField @bind-Value="variable.Value" 
                                                        Label="Value" 
                                                        Variant="Variant.Outlined"
                                                        Placeholder="/api/v1" />
                                        </MudItem>
                                        <MudItem xs="2" Class="d-flex align-center justify-center">
                                            <MudIconButton Icon="@Icons.Material.Filled.Delete" 
                                                         Color="Color.Error" 
                                                         OnClick="@(() => RemoveVariable(variable))"
                                                         Size="Size.Medium" />
                                        </MudItem>
                                    </MudGrid>
                                </MudPaper>
                            }
                        }
                        else
                        {
                            <MudAlert Severity="Severity.Info" Variant="Variant.Outlined" Dense="true">
                                No variables yet. Add variables to override environment settings
                            </MudAlert>
                        }
                        
                        <MudButton Variant="Variant.Outlined" 
                                  Color="Color.Success" 
                                  OnClick="AddVariable" 
                                  StartIcon="@Icons.Material.Filled.Add"
                                  Size="Size.Medium">
                            Add Variable
                        </MudButton>
                    </MudStack>
                </MudCardContent>
                <MudCardActions>
                    <MudStack Row="true" Spacing="2" Class="px-4 pb-4">
                        <MudButton Variant="Variant.Filled" 
                                  Color="Color.Primary" 
                                  OnClick="SaveCollection" 
                                  StartIcon="@Icons.Material.Filled.Check"
                                  Disabled="@(string.IsNullOrWhiteSpace(_name))">
                            Create @(ParentCollectionId.HasValue ? "Sub-Collection" : "Collection")
                        </MudButton>
                        <MudButton Variant="Variant.Outlined" 
                                  Color="Color.Default" 
                                  OnClick="Cancel"
                                  StartIcon="@Icons.Material.Filled.Close">
                            Cancel
                        </MudButton>
                    </MudStack>
                </MudCardActions>
            </MudCard>
        </MudStack>
    </MudPaper>
</MudContainer>

@code {
    [Parameter]
    public Guid? ParentCollectionId { get; set; }

    private string _name = string.Empty;
    private string _description = string.Empty;
    private List<VariableModel> _variables = new();

    private class VariableModel
    {
        public string Key { get; set; } = string.Empty;
        public string Value { get; set; } = string.Empty;
    }

    private void AddVariable()
    {
        _variables.Add(new VariableModel());
    }

    private void RemoveVariable(VariableModel variable)
    {
        _variables.Remove(variable);
    }

    private async Task SaveCollection()
    {
        try
        {
            var collection = await CollectionService.CreateCollectionAsync(_name, ParentCollectionId, _description);
            
            // Add variables to collection
            foreach (var variable in _variables.Where(v => !string.IsNullOrWhiteSpace(v.Key)))
            {
                collection.Variables[variable.Key] = variable.Value;
            }

            await CollectionService.UpdateCollectionAsync(collection);
            
            var collectionType = ParentCollectionId.HasValue ? "Sub-collection" : "Collection";
            Snackbar.Add($"{collectionType} '{_name}' created successfully", Severity.Success);
            NavigationManager.NavigateTo("/");
        }
        catch (InvalidOperationException ex) when (ex.Message.Contains("already exists"))
        {
            var collectionType = ParentCollectionId.HasValue ? "sub-collection" : "collection";
            Snackbar.Add($"A {collectionType} with the name '{_name}' already exists. Please choose a different name.", Severity.Error);
        }
        catch (Exception ex)
        {
            Snackbar.Add($"Error creating collection: {ex.Message}", Severity.Error);
        }
    }

    private void Cancel()
    {
        NavigationManager.NavigateTo("/");
    }
}
