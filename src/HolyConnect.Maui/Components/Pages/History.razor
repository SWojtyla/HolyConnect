@page "/history"
@inject IRequestHistoryService HistoryService
@inject ISnackbar Snackbar
@inject IDialogService DialogService
@inject NavigationManager NavigationManager

<MudContainer MaxWidth="MaxWidth.Large" Class="mt-4 mb-6">
    <MudStack Row="true" Justify="Justify.SpaceBetween" AlignItems="AlignItems.Center" Class="mb-4">
        <div>
            <MudText Typo="Typo.h4" Class="mb-2">Request History</MudText>
            <MudText Typo="Typo.body1" Color="Color.Secondary">View the last 10 executed requests and their responses</MudText>
        </div>
        @if (_historyEntries != null && _historyEntries.Any())
        {
            <MudButton Variant="Variant.Outlined" Color="Color.Error" OnClick="ClearHistory" StartIcon="@Icons.Material.Filled.DeleteSweep">
                Clear History
            </MudButton>
        }
    </MudStack>
    
    @if (_historyEntries != null && _historyEntries.Any())
    {

        @foreach (var entry in _historyEntries)
        {
            <MudCard Class="mb-3" Elevation="2">
                <MudCardHeader Class="pb-2">
                    <CardHeaderContent>
                        <MudGrid>
                            <MudItem xs="12" md="8" Class="d-flex align-center">
                                <MudStack Row="true" AlignItems="AlignItems.Center" Spacing="2">
                                    <MudTooltip Text="@entry.RequestName">
                                        <MudText Typo="Typo.h6" Class="text-truncate">@entry.RequestName</MudText>
                                    </MudTooltip>
                                    @if (entry.RequestId.HasValue && entry.EnvironmentId.HasValue)
                                    {
                                        <MudIconButton Icon="@Icons.Material.Filled.Launch" 
                                                     Size="Size.Small" 
                                                     Color="Color.Primary" 
                                                     OnClick="@(() => NavigateToRequest(entry))"
                                                     Title="Open request" />
                                    }
                                </MudStack>
                            </MudItem>
                            <MudItem xs="12" md="4" Class="d-flex align-center justify-end">
                                <MudChip T="RequestHistoryEntry" Color="@GetStatusColor(entry.Response.StatusCode)" Size="Size.Small">
                                    @entry.Response.StatusCode - @entry.Response.StatusMessage
                                </MudChip>
                            </MudItem>
                        </MudGrid>
                        <MudText Typo="Typo.caption" Color="Color.Secondary">@entry.Timestamp.ToLocalTime().ToString("yyyy-MM-dd HH:mm:ss")</MudText>
                    </CardHeaderContent>
                </MudCardHeader>
                <MudCardContent Class="pt-2">
                    <MudGrid Spacing="2">
                        <MudItem xs="12" sm="6" md="3">
                            <MudText Typo="Typo.caption" Color="Color.Secondary">Method</MudText>
                            <MudText Typo="Typo.body2"><strong>@entry.SentRequest.Method</strong></MudText>
                        </MudItem>
                        <MudItem xs="12" sm="6" md="3">
                            <MudText Typo="Typo.caption" Color="Color.Secondary">Response Time</MudText>
                            <MudText Typo="Typo.body2"><strong>@entry.Response.ResponseTime ms</strong></MudText>
                        </MudItem>
                        <MudItem xs="12" sm="6" md="3">
                            <MudText Typo="Typo.caption" Color="Color.Secondary">Size</MudText>
                            <MudText Typo="Typo.body2"><strong>@entry.Response.Size bytes</strong></MudText>
                        </MudItem>
                        <MudItem xs="12" sm="6" md="3">
                            <MudText Typo="Typo.caption" Color="Color.Secondary">Status</MudText>
                            <MudText Typo="Typo.body2"><strong>@entry.Response.StatusCode</strong></MudText>
                        </MudItem>
                    </MudGrid>
                    <MudDivider Class="my-3" />
                    <MudText Typo="Typo.caption" Color="Color.Secondary">URL</MudText>
                    <MudTooltip Text="@entry.SentRequest.Url">
                        <MudText Typo="Typo.body2" Class="text-truncate"><strong>@entry.SentRequest.Url</strong></MudText>
                    </MudTooltip>

                    <MudExpansionPanels Class="mt-3">
                        <MudExpansionPanel Text="Request Details">
                            <MudText Typo="Typo.subtitle2" Class="mb-2"><strong>Headers:</strong></MudText>
                            @if (entry.SentRequest.Headers.Any())
                            {
                                @foreach (var header in entry.SentRequest.Headers)
                                {
                                    <MudText Typo="Typo.body2" Style="word-break: break-all; white-space: normal;">@header.Key: @header.Value</MudText>
                                }
                            }
                            else
                            {
                                <MudText Typo="Typo.body2" Color="Color.Default">No headers</MudText>
                            }

                            @if (entry.SentRequest.QueryParameters.Any())
                            {
                                <MudText Typo="Typo.subtitle2" Class="mt-3 mb-2"><strong>Query Parameters:</strong></MudText>
                                @foreach (var param in entry.SentRequest.QueryParameters)
                                {
                                    <MudText Typo="Typo.body2">@param.Key: @param.Value</MudText>
                                }
                            }

                            @if (!string.IsNullOrEmpty(entry.SentRequest.Body))
                            {
                                <MudText Typo="Typo.subtitle2" Class="mt-3 mb-2"><strong>Body:</strong></MudText>
                                <MudTextField Value="@entry.SentRequest.Body" Lines="10" Variant="Variant.Outlined" ReadOnly="true" />
                            }
                        </MudExpansionPanel>

                        <MudExpansionPanel Text="Response Details">
                            <MudText Typo="Typo.subtitle2" Class="mb-2"><strong>Headers:</strong></MudText>
                            @if (entry.Response.Headers.Any())
                            {
                                @foreach (var header in entry.Response.Headers)
                                {
                                    <MudText Typo="Typo.body2" Style="word-break: break-all; white-space: normal;">@header.Key: @header.Value</MudText>
                                }
                            }
                            else
                            {
                                <MudText Typo="Typo.body2" Color="Color.Default">No headers</MudText>
                            }

                            @if (!string.IsNullOrEmpty(entry.Response.Body))
                            {
                                <MudText Typo="Typo.subtitle2" Class="mt-3 mb-2"><strong>Body:</strong></MudText>
                                <MudTextField Value="@entry.Response.Body" Lines="15" Variant="Variant.Outlined" ReadOnly="true" />
                            }
                        </MudExpansionPanel>
                    </MudExpansionPanels>
                </MudCardContent>
            </MudCard>
        }
    }
    else
    {
        <MudAlert Severity="Severity.Info">No history entries yet. Execute some requests to see them here.</MudAlert>
    }
</MudContainer>

@code {
    private IEnumerable<RequestHistoryEntry>? _historyEntries;

    protected override async Task OnInitializedAsync()
    {
        await LoadHistory();
    }

    private async Task LoadHistory()
    {
        _historyEntries = await HistoryService.GetHistoryAsync();
    }

    private async Task ClearHistory()
    {
        var parameters = new DialogParameters
        {
            ["ContentText"] = "Are you sure you want to clear all history entries? This action cannot be undone.",
            ["ButtonText"] = "Clear",
            ["Color"] = Color.Error
        };

        var dialog = await DialogService.ShowAsync<ConfirmDialog>("Clear History", parameters);
        var result = await dialog.Result;

        if (!result.Canceled)
        {
            await HistoryService.ClearHistoryAsync();
            Snackbar.Add("History cleared successfully", Severity.Success);
            await LoadHistory();
            StateHasChanged();
        }
    }

    private Color GetStatusColor(int statusCode)
    {
        return statusCode switch
        {
            >= 200 and < 300 => Color.Success,
            >= 300 and < 400 => Color.Info,
            >= 400 and < 500 => Color.Warning,
            >= 500 => Color.Error,
            _ => Color.Default
        };
    }

    private void NavigateToRequest(RequestHistoryEntry entry)
    {
        if (entry.RequestId.HasValue && entry.EnvironmentId.HasValue)
        {
            NavigationManager.NavigateTo($"/environment/{entry.EnvironmentId}?requestId={entry.RequestId}");
        }
    }
}
