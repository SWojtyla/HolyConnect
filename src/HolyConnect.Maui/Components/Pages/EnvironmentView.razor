@page "/environment/{EnvironmentId:guid}"
@using Microsoft.AspNetCore.WebUtilities
@inject EnvironmentService EnvironmentService
@inject CollectionService CollectionService
@inject RequestService RequestService
@inject NavigationManager NavigationManager
@inject ISnackbar Snackbar
@inject IDialogService DialogService
@implements IDisposable

<MudContainer MaxWidth="MaxWidth.False" Style="height: calc(100vh - 64px); display: flex; padding: 0;">
    <MudPaper Elevation="2" Style="width: 300px; overflow-y: auto; border-right: 1px solid #e0e0e0;">
        @if (_environment != null)
        {
            <MudToolBar Dense="true">
                <MudText Typo="Typo.h6">@_environment.Name</MudText>
                <MudSpacer />
                <MudIconButton Icon="@Icons.Material.Filled.Edit" Size="Size.Small" OnClick="EditEnvironment" aria-label="Edit environment" />
                <MudIconButton Icon="@Icons.Material.Filled.Delete" Size="Size.Small" Color="Color.Error" OnClick="DeleteEnvironment" aria-label="Delete environment" />
                <MudIconButton Icon="@Icons.Material.Filled.Add" Size="Size.Small" OnClick="ShowCreateMenu" aria-label="Add collection or request" />
            </MudToolBar>
            
            <div>
                @* Environment-level requests *@
                @if (_environmentRequests != null && _environmentRequests.Any())
                {
                    <MudText Typo="Typo.body2" Color="Color.Default" Class="pa-2 mt-2" Style="font-weight: 500;">Requests</MudText>
                    @foreach (var request in _environmentRequests)
                    {
                        <MudPaper Class="pa-2 mb-1 ml-2" Style="display: flex; align-items: center; justify-content: space-between;">
                            <MudText Style="flex: 1; cursor: pointer;" @onclick="@(() => SelectRequest(request))">
                                <MudIcon Icon="@GetRequestIcon(request.Type)" Size="Size.Small" Color="@GetRequestColor(request.Type)" /> @request.Name
                            </MudText>
                            <div style="display: flex; gap: 4px;" @onclick:stopPropagation="true">
                                <MudIconButton Icon="@Icons.Material.Filled.Edit" Size="Size.Small" OnClick="@(() => RenameRequest(request))" aria-label="Rename request" />
                                <MudIconButton Icon="@Icons.Material.Filled.Delete" Size="Size.Small" Color="Color.Error" OnClick="@(() => DeleteRequest(request))" aria-label="Delete request" />
                            </div>
                        </MudPaper>
                    }
                }

                @* Collections *@
                @if (_collections != null && _collections.Any())
                {
                    <MudText Typo="Typo.body2" Color="Color.Default" Class="pa-2 mt-2" Style="font-weight: 500;">Collections</MudText>
                    @foreach (var collection in _collections.Where(c => c.ParentCollectionId == null))
                    {
                        <CollectionTreeItem Collection="@collection" 
                                          OnSelect="SelectCollection" 
                                          OnRequestSelect="SelectRequest"
                                          OnCollectionUpdated="HandleCollectionUpdated"
                                          OnRequestUpdated="HandleRequestUpdated" />
                    }
                }
                
                @if ((_collections == null || !_collections.Any()) && (_environmentRequests == null || !_environmentRequests.Any()))
                {
                    <MudText Typo="Typo.body2" Color="Color.Default" Class="pa-4">No collections or requests yet</MudText>
                }
            </div>
        }
    </MudPaper>

    <MudPaper Style="flex: 1; overflow-y: auto; padding: 16px;">
        @if (_selectedCollection != null)
        {
            <MudText Typo="Typo.h5" Class="mb-4">@_selectedCollection.Name</MudText>
            <MudText Typo="Typo.body1" Class="mb-4">@_selectedCollection.Description</MudText>
            
            <MudButton Variant="Variant.Filled" Color="Color.Primary" OnClick="CreateRequest" StartIcon="@Icons.Material.Filled.Add">
                New Request
            </MudButton>

            <MudText Typo="Typo.h6" Class="mt-4 mb-2">Requests</MudText>
            @if (_selectedCollection.Requests != null && _selectedCollection.Requests.Any())
            {
                <div>
                    @foreach (var request in _selectedCollection.Requests)
                    {
                        <MudPaper Class="pa-2 mb-2" Style="cursor: pointer;" @onclick="@(() => SelectRequest(request))">
                            <MudText>@request.Name</MudText>
                            <MudText Typo="Typo.body2" Color="Color.Default">@request.Type</MudText>
                        </MudPaper>
                    }
                </div>
            }
            else
            {
                <MudText Typo="Typo.body2" Color="Color.Default">No requests in this collection</MudText>
            }
        }
        else if (_selectedRequest != null)
        {
            <RequestEditor Request="@_selectedRequest" OnSave="SaveRequest" OnCancel="CancelRequestEdit" />
        }
        else
        {
            <MudText Typo="Typo.h6">Select a collection to view its requests</MudText>
        }
    </MudPaper>
</MudContainer>

@code {
    [Parameter]
    public Guid EnvironmentId { get; set; }

    private Domain.Entities.Environment? _environment;
    private IEnumerable<Collection>? _collections;
    private IEnumerable<Request>? _environmentRequests;
    private Collection? _selectedCollection;
    private Request? _selectedRequest;

    protected override async Task OnInitializedAsync()
    {
        // Subscribe to navigation changes to refresh data when coming back from create pages
        NavigationManager.LocationChanged += OnLocationChanged;
        await LoadData();
        await HandleQueryParameters();
    }

    protected override async Task OnParametersSetAsync()
    {
        // Reload data when parameters change (e.g., navigating back from create pages)
        await LoadData();
        await HandleQueryParameters();
    }

    private async Task HandleQueryParameters()
    {
        // Check if there's a requestId query parameter to auto-select a request
        var uri = new Uri(NavigationManager.Uri);
        var query = QueryHelpers.ParseQuery(uri.Query);
        if (query.TryGetValue("requestId", out var requestIdString) && Guid.TryParse(requestIdString, out var requestId))
        {
            var request = await RequestService.GetRequestByIdAsync(requestId);
            if (request != null)
            {
                SelectRequest(request);
            }
        }
    }

    private async void OnLocationChanged(object? sender, Microsoft.AspNetCore.Components.Routing.LocationChangedEventArgs e)
    {
        try
        {
            // Reload data when location changes
            if (EnvironmentId != Guid.Empty && e.Location.Contains($"/environment/{EnvironmentId}"))
            {
                await LoadData();
                StateHasChanged();
            }
        }
        catch (Exception ex)
        {
            Console.WriteLine($"Error reloading data on location change: {ex.Message}");
        }
    }

    public void Dispose()
    {
        NavigationManager.LocationChanged -= OnLocationChanged;
    }

    private async Task LoadData()
    {
        _environment = await EnvironmentService.GetEnvironmentByIdAsync(EnvironmentId);
        if (_environment != null)
        {
            var allCollections = await CollectionService.GetAllCollectionsAsync();
            var environmentCollections = allCollections.Where(c => c.EnvironmentId == EnvironmentId).ToList();
            
            // Build collection hierarchy efficiently in a single pass
            var collectionDict = new Dictionary<Guid, Collection>();
            var rootCollections = new List<Collection>();
            
            // First pass: clear existing sub-collections and index all collections
            foreach (var collection in environmentCollections)
            {
                collection.SubCollections.Clear();
                collectionDict[collection.Id] = collection;
            }
            
            // Second pass: build hierarchy and identify roots
            foreach (var collection in environmentCollections)
            {
                if (collection.ParentCollectionId.HasValue)
                {
                    if (collectionDict.TryGetValue(collection.ParentCollectionId.Value, out var parent))
                    {
                        parent.SubCollections.Add(collection);
                    }
                }
                else
                {
                    rootCollections.Add(collection);
                }
            }
            
            _collections = rootCollections;
            
            // Load requests for each collection (load once and group to avoid N+1 queries)
            var allRequests = await RequestService.GetAllRequestsAsync();
            var collectionIds = environmentCollections.Select(c => c.Id).ToHashSet();
            var requestsByCollection = allRequests
                .Where(r => r.CollectionId.HasValue && collectionIds.Contains(r.CollectionId.Value))
                .GroupBy(r => r.CollectionId!.Value)
                .ToDictionary(g => g.Key, g => g.ToList());
            
            foreach (var collection in environmentCollections)
            {
                collection.Requests = requestsByCollection.TryGetValue(collection.Id, out var requests) ? requests : new List<Request>();
            }
            
            // Load environment-level requests (requests without a collection)
            _environmentRequests = await RequestService.GetRequestsByEnvironmentIdAsync(EnvironmentId);
        }
    }

    private void SelectCollection(Collection collection)
    {
        _selectedCollection = collection;
        _selectedRequest = null;
        StateHasChanged();
    }

    private void SelectRequest(Request request)
    {
        _selectedRequest = request;
        _selectedCollection = null;
        StateHasChanged();
    }

    private async Task ShowCreateMenu()
    {
        var options = new List<string> { "New Collection", "New Request" };
        var parameters = new DialogParameters
        {
            ["Options"] = options
        };

        var dialog = await DialogService.ShowAsync<SelectOptionDialog>("Create", parameters);
        var result = await dialog.Result;

        if (!result.Canceled && result.Data is string selectedOption)
        {
            if (selectedOption == "New Collection")
            {
                CreateCollection();
            }
            else if (selectedOption == "New Request")
            {
                CreateEnvironmentRequest();
            }
        }
    }

    private void CreateCollection()
    {
        NavigationManager.NavigateTo($"/environment/{EnvironmentId}/collection/create");
    }

    private void CreateEnvironmentRequest()
    {
        NavigationManager.NavigateTo($"/environment/{EnvironmentId}/request/create");
    }

    private void CreateRequest()
    {
        if (_selectedCollection != null)
        {
            NavigationManager.NavigateTo($"/collection/{_selectedCollection.Id}/request/create");
        }
    }

    private async Task SaveRequest()
    {
        if (_selectedRequest != null)
        {
            await RequestService.UpdateRequestAsync(_selectedRequest);
            Snackbar.Add("Request saved", Severity.Success);          
            await LoadData();
        }
    }

    private void CancelRequestEdit()
    {
        _selectedRequest = null;
        StateHasChanged();
    }

    private async Task HandleCollectionUpdated((Guid CollectionId, string NewName, bool IsDelete) updateInfo)
    {
        if (updateInfo.IsDelete)
        {
            await CollectionService.DeleteCollectionAsync(updateInfo.CollectionId);
            Snackbar.Add("Collection deleted successfully", Severity.Success);
        }
        else
        {
            var collection = await CollectionService.GetCollectionByIdAsync(updateInfo.CollectionId);
            if (collection != null)
            {
                collection.Name = updateInfo.NewName;
                await CollectionService.UpdateCollectionAsync(collection);
                Snackbar.Add("Collection renamed successfully", Severity.Success);
            }
        }
        
        await LoadData();
        StateHasChanged();
    }

    private async Task HandleRequestUpdated((Guid RequestId, string NewName, bool IsDelete) updateInfo)
    {
        if (updateInfo.IsDelete)
        {
            await RequestService.DeleteRequestAsync(updateInfo.RequestId);
            Snackbar.Add("Request deleted successfully", Severity.Success);
        }
        else
        {
            var request = await RequestService.GetRequestByIdAsync(updateInfo.RequestId);
            if (request != null)
            {
                request.Name = updateInfo.NewName;
                await RequestService.UpdateRequestAsync(request);
                Snackbar.Add("Request renamed successfully", Severity.Success);
            }
        }
        
        await LoadData();
        StateHasChanged();
    }

    private void EditEnvironment()
    {
        if (_environment == null) return;
        NavigationManager.NavigateTo($"/environment/{_environment.Id}/edit");
    }

    private async Task DeleteEnvironment()
    {
        if (_environment == null) return;

        var parameters = new DialogParameters
        {
            ["ContentText"] = $"Are you sure you want to delete the environment '{_environment.Name}'? This will also delete all collections and requests within it. This action cannot be undone.",
            ["ButtonText"] = "Delete",
            ["Color"] = Color.Error
        };

        var dialog = await DialogService.ShowAsync<ConfirmDialog>("Delete Environment", parameters);
        var result = await dialog.Result;

        if (!result.Canceled)
        {
            await EnvironmentService.DeleteEnvironmentAsync(_environment.Id);
            Snackbar.Add("Environment deleted successfully", Severity.Success);
            NavigationManager.NavigateTo("/");
        }
    }

    private string GetRequestIcon(RequestType type) => type switch
    {
        RequestType.Rest => Icons.Material.Filled.Http,
        RequestType.GraphQL => Icons.Material.Filled.GraphicEq,
        _ => Icons.Material.Filled.Article
    };

    private Color GetRequestColor(RequestType type) => type switch
    {
        RequestType.Rest => Color.Primary,
        RequestType.GraphQL => Color.Secondary,
        _ => Color.Default
    };

    private async Task RenameRequest(Request request)
    {
        var parameters = new DialogParameters
        {
            ["CurrentName"] = request.Name
        };

        var dialog = await DialogService.ShowAsync<RenameDialog>("Rename Request", parameters);
        var result = await dialog.Result;

        if (!result.Canceled && result.Data is string newName && !string.IsNullOrWhiteSpace(newName))
        {
            request.Name = newName;
            await RequestService.UpdateRequestAsync(request);
            Snackbar.Add("Request renamed successfully", Severity.Success);
            await LoadData();
            StateHasChanged();
        }
    }

    private async Task DeleteRequest(Request request)
    {
        var parameters = new DialogParameters
        {
            ["ContentText"] = $"Are you sure you want to delete the request '{request.Name}'? This action cannot be undone.",
            ["ButtonText"] = "Delete",
            ["Color"] = Color.Error
        };

        var dialog = await DialogService.ShowAsync<ConfirmDialog>("Delete Request", parameters);
        var result = await dialog.Result;

        if (!result.Canceled)
        {
            await RequestService.DeleteRequestAsync(request.Id);
            Snackbar.Add("Request deleted successfully", Severity.Success);
            await LoadData();
            StateHasChanged();
        }
    }
}
