@page "/environment/{EnvironmentId:guid}"
@using Microsoft.AspNetCore.WebUtilities
@inject IEnvironmentService EnvironmentService
@inject ICollectionService CollectionService
@inject IRequestService RequestService
@inject IFlowService FlowService
@inject NavigationManager NavigationManager
@inject ISnackbar Snackbar
@inject IDialogService DialogService
@implements IDisposable

<MudContainer MaxWidth="MaxWidth.False" Class="d-flex pa-0" Style="height: calc(100vh - 64px);">
    <MudPaper Elevation="2" Class="overflow-y-auto flex-shrink-0" Style="width: 280px; min-width: 280px; border-right: 1px solid var(--mud-palette-divider);">
        @if (_environment != null)
        {
            <MudToolBar Dense="true" Class="mud-theme-primary">
                <MudTooltip Text="@_environment.Name">
                    <MudText Typo="Typo.h6" Class="text-truncate">@_environment.Name</MudText>
                </MudTooltip>
                <MudSpacer />
                <MudIconButton Icon="@Icons.Material.Filled.Edit" Size="Size.Small" OnClick="EditEnvironment" Title="Edit environment" Color="Color.Inherit" />
                <MudIconButton Icon="@Icons.Material.Filled.Delete" Size="Size.Small" Color="Color.Inherit" OnClick="DeleteEnvironment" Title="Delete environment" />
                <MudIconButton Icon="@Icons.Material.Filled.Add" Size="Size.Small" OnClick="ShowCreateMenu" Title="Add collection or request" Color="Color.Inherit" />
            </MudToolBar>
            
            <div>
                @* Environment-level requests *@
                @if (_environmentRequests != null && _environmentRequests.Any())
                {
                    <MudText Typo="Typo.body2" Class="pa-2 mt-2" Color="Color.Primary"><strong>Requests</strong></MudText>
                    @foreach (var request in _environmentRequests)
                    {
                        <MudPaper Class="@($"pa-3 mb-1 mx-2 cursor-pointer {(request.Id == _selectedRequest?.Id ? "mud-theme-primary" : "")}")" 
                                 Outlined="true"
                                 Style="@(request.Id == _selectedRequest?.Id ? "border-color: var(--mud-palette-primary);" : "")"
                                 @onclick="@(() => SelectRequest(request))">
                            <MudStack Row="true" Justify="Justify.SpaceBetween" AlignItems="AlignItems.Center">
                                <MudStack Row="true" AlignItems="AlignItems.Center" Spacing="1" Class="flex-grow-1" Style="min-width: 0;">
                                    <MudIcon Icon="@GetRequestIcon(request.Type)" Size="Size.Small" Color="@GetRequestColor(request.Type)" />
                                    <MudTooltip Text="@request.Name">
                                        <MudText Class="text-truncate">@request.Name</MudText>
                                    </MudTooltip>
                                </MudStack>
                                <MudStack Row="true" Spacing="0" @onclick:stopPropagation="true" Class="flex-shrink-0">
                                    <MudIconButton Icon="@Icons.Material.Filled.Edit" Size="Size.Small" OnClick="@(() => RenameRequest(request))" Title="Rename request" />
                                    <MudIconButton Icon="@Icons.Material.Filled.Delete" Size="Size.Small" Color="Color.Error" OnClick="@(() => DeleteRequest(request))" Title="Delete request" />
                                </MudStack>
                            </MudStack>
                        </MudPaper>
                    }
                }

                @* Flows *@
                @if (_flows != null && _flows.Any())
                {
                    <MudText Typo="Typo.body2" Class="pa-2 mt-3" Color="Color.Primary"><strong>Flows</strong></MudText>
                    @foreach (var flow in _flows)
                    {
                        <MudPaper Class="@($"pa-3 mb-1 mx-2 cursor-pointer {(flow.Id == _selectedFlow?.Id ? "mud-theme-primary" : "")}")" 
                                 Outlined="true"
                                 Style="@(flow.Id == _selectedFlow?.Id ? "border-color: var(--mud-palette-primary);" : "")"
                                 @onclick="@(() => SelectFlow(flow))">
                            <MudStack Row="true" Justify="Justify.SpaceBetween" AlignItems="AlignItems.Center">
                                <MudStack Row="true" AlignItems="AlignItems.Center" Spacing="1" Class="flex-grow-1" Style="min-width: 0;">
                                    <MudIcon Icon="@Icons.Material.Filled.AccountTree" Size="Size.Small" Color="Color.Success" />
                                    <MudTooltip Text="@flow.Name">
                                        <MudText Class="text-truncate">@flow.Name</MudText>
                                    </MudTooltip>
                                </MudStack>
                                <MudStack Row="true" Spacing="0" @onclick:stopPropagation="true" Class="flex-shrink-0">
                                    <MudIconButton Icon="@Icons.Material.Filled.PlayArrow" Size="Size.Small" OnClick="@(() => ExecuteFlow(flow))" Title="Execute flow" Color="Color.Success" />
                                    <MudIconButton Icon="@Icons.Material.Filled.Delete" Size="Size.Small" Color="Color.Error" OnClick="@(() => DeleteFlow(flow))" Title="Delete flow" />
                                </MudStack>
                            </MudStack>
                        </MudPaper>
                    }
                }

                @* Collections *@
                @if (_collections != null && _collections.Any())
                {
                    <MudText Typo="Typo.body2" Class="pa-2 mt-3" Color="Color.Primary"><strong>Collections</strong></MudText>
                    @foreach (var collection in _collections.Where(c => c.ParentCollectionId == null))
                    {
                        <CollectionTreeItem Collection="@collection" 
                                          OnSelect="SelectCollection" 
                                          OnRequestSelect="SelectRequest"
                                          OnCollectionUpdated="HandleCollectionUpdated"
                                          OnRequestUpdated="HandleRequestUpdated"
                                          SelectedCollectionId="@_selectedCollection?.Id"
                                          SelectedRequestId="@_selectedRequest?.Id" />
                    }
                }
                
                @if ((_collections == null || !_collections.Any()) && (_environmentRequests == null || !_environmentRequests.Any()) && (_flows == null || !_flows.Any()))
                {
                    <MudAlert Severity="Severity.Info" Variant="Variant.Outlined" Class="ma-4">
                        No flows, collections or requests yet. Click the + button to add one!
                    </MudAlert>
                }
            </div>
        }
    </MudPaper>

    <MudPaper Class="flex-grow-1 overflow-y-auto pa-4" Elevation="0">
        @if (_selectedCollection != null)
        {
            <MudBreadcrumbs Items="@GetBreadcrumbs()" Class="mb-4"></MudBreadcrumbs>
            <MudStack Row="true" Justify="Justify.SpaceBetween" AlignItems="AlignItems.Center" Class="mb-4">
                <div>
                    <MudText Typo="Typo.h5" Class="mb-2">@_selectedCollection.Name</MudText>
                    @if (!string.IsNullOrEmpty(_selectedCollection.Description))
                    {
                        <MudText Typo="Typo.body1" Color="Color.Secondary">@_selectedCollection.Description</MudText>
                    }
                </div>
                <MudButton Variant="Variant.Filled" Color="Color.Primary" OnClick="CreateRequest" StartIcon="@Icons.Material.Filled.Add">
                    New Request
                </MudButton>
            </MudStack>

            <MudText Typo="Typo.h6" Class="mb-3">Requests in this Collection</MudText>
            @if (_selectedCollection.Requests != null && _selectedCollection.Requests.Any())
            {
                <MudGrid Spacing="2">
                    @foreach (var request in _selectedCollection.Requests)
                    {
                        <MudItem xs="12" sm="6" md="4">
                            <MudPaper Class="pa-3 cursor-pointer" Outlined="true" @onclick="@(() => SelectRequest(request))">
                                <MudStack Spacing="1">
                                    <MudStack Row="true" AlignItems="AlignItems.Center" Spacing="1">
                                        <MudIcon Icon="@GetRequestIcon(request.Type)" Size="Size.Small" Color="@GetRequestColor(request.Type)" />
                                        <MudTooltip Text="@request.Name">
                                            <MudText Typo="Typo.subtitle1" Class="text-truncate"><strong>@request.Name</strong></MudText>
                                        </MudTooltip>
                                    </MudStack>
                                    <MudChip T="string" Size="Size.Small" Color="@GetRequestColor(request.Type)">@request.Type</MudChip>
                                </MudStack>
                            </MudPaper>
                        </MudItem>
                    }
                </MudGrid>
            }
            else
            {
                <MudAlert Severity="Severity.Info" Variant="Variant.Outlined">
                    No requests in this collection. Click "New Request" to add one!
                </MudAlert>
            }
        }
        else if (_selectedFlow != null)
        {
            <MudStack Row="true" Justify="Justify.SpaceBetween" AlignItems="AlignItems.Center" Class="mb-4">
                <div>
                    <MudText Typo="Typo.h5" Class="mb-2">@_selectedFlow.Name</MudText>
                    @if (!string.IsNullOrEmpty(_selectedFlow.Description))
                    {
                        <MudText Typo="Typo.body1" Color="Color.Secondary">@_selectedFlow.Description</MudText>
                    }
                </div>
                <MudButton Variant="Variant.Filled" 
                          Color="Color.Success" 
                          StartIcon="@Icons.Material.Filled.PlayArrow"
                          OnClick="@(() => ExecuteFlow(_selectedFlow))">
                    Execute Flow
                </MudButton>
            </MudStack>

            <MudText Typo="Typo.h6" Class="mb-3">Flow Steps (@_selectedFlow.Steps.Count)</MudText>
            @if (_selectedFlow.Steps != null && _selectedFlow.Steps.Any())
            {
                <MudList T="string">
                    @foreach (var step in _selectedFlow.Steps.OrderBy(s => s.Order))
                    {
                        <MudListItem T="string">
                            <MudPaper Class="pa-3 mb-2" Outlined="true">
                                <MudStack Row="true" Justify="Justify.SpaceBetween" AlignItems="AlignItems.Center">
                                    <MudStack Row="true" AlignItems="AlignItems.Center" Spacing="2">
                                        <MudChip T="string" Size="Size.Small" Color="Color.Primary">Step @step.Order</MudChip>
                                        <MudText Typo="Typo.body1">@(step.Request?.Name ?? "Unknown Request")</MudText>
                                    </MudStack>
                                    <MudStack Row="true" Spacing="1">
                                        @if (!step.IsEnabled)
                                        {
                                            <MudChip T="string" Size="Size.Small" Color="Color.Default">Disabled</MudChip>
                                        }
                                        @if (step.ContinueOnError)
                                        {
                                            <MudChip T="string" Size="Size.Small" Color="Color.Warning">Continue on Error</MudChip>
                                        }
                                        @if (step.DelayBeforeExecutionMs.HasValue && step.DelayBeforeExecutionMs.Value > 0)
                                        {
                                            <MudChip T="string" Size="Size.Small" Color="Color.Info">Delay: @step.DelayBeforeExecutionMs ms</MudChip>
                                        }
                                    </MudStack>
                                </MudStack>
                            </MudPaper>
                        </MudListItem>
                    }
                </MudList>
            }
            else
            {
                <MudAlert Severity="Severity.Info" Variant="Variant.Outlined">
                    No steps in this flow.
                </MudAlert>
            }
        }
        else if (_selectedRequest != null)
        {
            <MudBreadcrumbs Items="@GetBreadcrumbs()" Class="mb-4"></MudBreadcrumbs>
            <RequestEditor Request="@_selectedRequest" 
                         Environment="@_environment" 
                         Collection="@_selectedRequestCollection"
                         OnSave="SaveRequest" 
                         OnCancel="CancelRequestEdit" />
        }
        else
        {
            <div Class="d-flex flex-column align-center justify-center" Style="height: 100%;">
                <MudIcon Icon="@Icons.Material.Filled.TouchApp" Size="Size.Large" Color="Color.Primary" Class="mb-4" Style="font-size: 5rem;" />
                <MudText Typo="Typo.h5" Class="mb-2">Welcome to @(_environment?.Name ?? "Environment")</MudText>
                <MudText Typo="Typo.body1" Color="Color.Secondary" Align="Align.Center" Class="mb-4">
                    Select a collection or request from the sidebar to get started
                </MudText>
                <MudStack Row="true" Spacing="2">
                    <MudButton Variant="Variant.Filled" 
                              Color="Color.Primary" 
                              StartIcon="@Icons.Material.Filled.Add"
                              OnClick="ShowCreateMenu">
                        Create New
                    </MudButton>
                    <MudButton Variant="Variant.Outlined" 
                              Color="Color.Primary" 
                              StartIcon="@Icons.Material.Filled.History"
                              OnClick="@(() => NavigationManager.NavigateTo("/history"))">
                        View History
                    </MudButton>
                </MudStack>
            </div>
        }
    </MudPaper>
</MudContainer>

@code {
    [Parameter]
    public Guid EnvironmentId { get; set; }

    private Domain.Entities.Environment? _environment;
    private IEnumerable<Collection>? _collections;
    private IEnumerable<Request>? _environmentRequests;
    private IEnumerable<Flow>? _flows;
    private Collection? _selectedCollection;
    private Request? _selectedRequest;
    private Flow? _selectedFlow;
    private Collection? _selectedRequestCollection;

    protected override async Task OnInitializedAsync()
    {
        // Subscribe to navigation changes to refresh data when coming back from create pages
        NavigationManager.LocationChanged += OnLocationChanged;
        await LoadData();
        await HandleQueryParameters();
    }

    protected override async Task OnParametersSetAsync()
    {
        // Reload data when parameters change (e.g., navigating back from create pages)
        await LoadData();
        await HandleQueryParameters();
    }

    private async Task HandleQueryParameters()
    {
        // Check if there's a requestId, collectionId, or flowId query parameter to auto-select
        var uri = new Uri(NavigationManager.Uri);
        var query = QueryHelpers.ParseQuery(uri.Query);
        if (query.TryGetValue("requestId", out var requestIdString) && Guid.TryParse(requestIdString, out var requestId))
        {
            var request = await RequestService.GetRequestByIdAsync(requestId);
            if (request != null)
            {
                SelectRequest(request);
                return;
            }
        }
        if (query.TryGetValue("collectionId", out var collectionIdString) && Guid.TryParse(collectionIdString, out var collectionId))
        {
            if (_collections != null)
            {
                var collection = FindCollectionById(_collections, collectionId);
                if (collection != null)
                {
                    SelectCollection(collection);
                    return;
                }
            }
        }
        if (query.TryGetValue("flowId", out var flowIdString) && Guid.TryParse(flowIdString, out var flowId))
        {
            var flow = await FlowService.GetFlowByIdAsync(flowId);
            if (flow != null)
            {
                SelectFlow(flow);
                return;
            }
        }
    }

    private async void OnLocationChanged(object? sender, Microsoft.AspNetCore.Components.Routing.LocationChangedEventArgs e)
    {
        try
        {
            // Reload data when location changes
            if (EnvironmentId != Guid.Empty && e.Location.Contains($"/environment/{EnvironmentId}"))
            {
                await LoadData();
                await HandleQueryParameters();
                StateHasChanged();
            }
        }
        catch (Exception ex)
        {
            Console.WriteLine($"Error reloading data on location change: {ex.Message}");
        }
    }

    public void Dispose()
    {
        NavigationManager.LocationChanged -= OnLocationChanged;
    }

    private async Task LoadData()
    {
        _environment = await EnvironmentService.GetEnvironmentByIdAsync(EnvironmentId);
        if (_environment != null)
        {
            var allCollections = await CollectionService.GetAllCollectionsAsync();
            var environmentCollections = allCollections.Where(c => c.EnvironmentId == EnvironmentId).ToList();
            
            // Build collection hierarchy efficiently in a single pass
            var collectionDict = new Dictionary<Guid, Collection>();
            var rootCollections = new List<Collection>();
            
            // First pass: clear existing sub-collections and index all collections
            foreach (var collection in environmentCollections)
            {
                collection.SubCollections.Clear();
                collectionDict[collection.Id] = collection;
            }
            
            // Second pass: build hierarchy and identify roots
            foreach (var collection in environmentCollections)
            {
                if (collection.ParentCollectionId.HasValue)
                {
                    if (collectionDict.TryGetValue(collection.ParentCollectionId.Value, out var parent))
                    {
                        parent.SubCollections.Add(collection);
                    }
                }
                else
                {
                    rootCollections.Add(collection);
                }
            }
            
            _collections = rootCollections;
            
            // Load requests for each collection (load once and group to avoid N+1 queries)
            var allRequests = await RequestService.GetAllRequestsAsync();
            var collectionIds = environmentCollections.Select(c => c.Id).ToHashSet();
            var requestsByCollection = allRequests
                .Where(r => r.CollectionId.HasValue && collectionIds.Contains(r.CollectionId.Value))
                .GroupBy(r => r.CollectionId!.Value)
                .ToDictionary(g => g.Key, g => g.ToList());
            
            foreach (var collection in environmentCollections)
            {
                collection.Requests = requestsByCollection.TryGetValue(collection.Id, out var requests) ? requests : new List<Request>();
            }
            
            // Load environment-level requests (requests without a collection)
            _environmentRequests = await RequestService.GetRequestsByEnvironmentIdAsync(EnvironmentId);
            
            // Load flows for this environment
            _flows = await FlowService.GetFlowsByEnvironmentIdAsync(EnvironmentId);
        }
    }

    private void SelectCollection(Collection collection)
    {
        _selectedCollection = collection;
        _selectedRequest = null;
        _selectedRequestCollection = null;
        StateHasChanged();
    }

    private void SelectRequest(Request request)
    {
        _selectedRequest = request;
        _selectedCollection = null;
        
        // Find the collection for this request
        _selectedRequestCollection = null;
        if (request.CollectionId.HasValue && _collections != null)
        {
            _selectedRequestCollection = FindCollectionById(_collections, request.CollectionId.Value);
        }
        
        StateHasChanged();
    }

    private Collection? FindCollectionById(IEnumerable<Collection> collections, Guid id)
    {
        foreach (var collection in collections)
        {
            if (collection.Id == id)
            {
                return collection;
            }
            
            var found = FindCollectionById(collection.SubCollections, id);
            if (found != null)
            {
                return found;
            }
        }
        
        return null;
    }

    private void SelectFlow(Flow flow)
    {
        _selectedFlow = flow;
        _selectedCollection = null;
        _selectedRequest = null;
        _selectedRequestCollection = null;
        StateHasChanged();
    }

    private void ExecuteFlow(Flow flow)
    {
        NavigationManager.NavigateTo($"/flow/{flow.Id}/execute");
    }

    private async Task DeleteFlow(Flow flow)
    {
        var parameters = new DialogParameters
        {
            ["Message"] = $"Are you sure you want to delete the flow '{flow.Name}'?"
        };

        var dialog = await DialogService.ShowAsync<ConfirmDialog>("Confirm Delete", parameters);
        var result = await dialog.Result;

        if (result != null && !result.Canceled)
        {
            try
            {
                await FlowService.DeleteFlowAsync(flow.Id);
                Snackbar.Add("Flow deleted successfully", Severity.Success);
                await LoadData();
            }
            catch (Exception ex)
            {
                Snackbar.Add($"Error deleting flow: {ex.Message}", Severity.Error);
            }
        }
    }

    private async Task ShowCreateMenu()
    {
        var options = new List<string> { "New Flow", "New Collection", "New Request" };
        var parameters = new DialogParameters
        {
            ["Options"] = options
        };

        var dialog = await DialogService.ShowAsync<SelectOptionDialog>("Create", parameters);
        var result = await dialog.Result;

        if (!result.Canceled && result.Data is string selectedOption)
        {
            if (selectedOption == "New Flow")
            {
                CreateFlow();
            }
            else if (selectedOption == "New Collection")
            {
                CreateCollection();
            }
            else if (selectedOption == "New Request")
            {
                CreateEnvironmentRequest();
            }
        }
    }

    private void CreateFlow()
    {
        NavigationManager.NavigateTo($"/flow/create?environmentId={EnvironmentId}");
    }

    private void CreateCollection()
    {
        NavigationManager.NavigateTo($"/environment/{EnvironmentId}/collection/create");
    }

    private void CreateEnvironmentRequest()
    {
        NavigationManager.NavigateTo($"/environment/{EnvironmentId}/request/create");
    }

    private void CreateRequest()
    {
        if (_selectedCollection != null)
        {
            NavigationManager.NavigateTo($"/collection/{_selectedCollection.Id}/request/create");
        }
    }

    private async Task SaveRequest()
    {
        if (_selectedRequest != null)
        {
            try
            {
                var selectedRequestId = _selectedRequest.Id;
                await RequestService.UpdateRequestAsync(_selectedRequest);
                Snackbar.Add("Request saved", Severity.Success);          
                await LoadData();
                
                // Re-select the request after reload to maintain state
                var reloadedRequest = await RequestService.GetRequestByIdAsync(selectedRequestId);
                if (reloadedRequest != null)
                {
                    SelectRequest(reloadedRequest);
                }
            }
            catch (InvalidOperationException ex) when (ex.Message.Contains("already exists"))
            {
                Snackbar.Add($"A request with the name '{_selectedRequest.Name}' already exists. Please choose a different name.", Severity.Error);
            }
            catch (Exception ex)
            {
                Snackbar.Add($"Error saving request: {ex.Message}", Severity.Error);
            }
        }
    }

    private void CancelRequestEdit()
    {
        _selectedRequest = null;
        StateHasChanged();
    }

    private async Task HandleCollectionUpdated((Guid CollectionId, string NewName, bool IsDelete) updateInfo)
    {
        var selectedRequestId = _selectedRequest?.Id;
        
        if (updateInfo.IsDelete)
        {
            await CollectionService.DeleteCollectionAsync(updateInfo.CollectionId);
            Snackbar.Add("Collection deleted successfully", Severity.Success);
        }
        else
        {
            var collection = await CollectionService.GetCollectionByIdAsync(updateInfo.CollectionId);
            if (collection != null)
            {
                collection.Name = updateInfo.NewName;
                await CollectionService.UpdateCollectionAsync(collection);
                Snackbar.Add("Collection renamed successfully", Severity.Success);
            }
        }
        
        await LoadData();
        
        // Re-select the request after reload to maintain state
        if (selectedRequestId.HasValue)
        {
            var reloadedRequest = await RequestService.GetRequestByIdAsync(selectedRequestId.Value);
            if (reloadedRequest != null)
            {
                SelectRequest(reloadedRequest);
            }
        }
        
        StateHasChanged();
    }

    private async Task HandleRequestUpdated((Guid RequestId, string NewName, bool IsDelete) updateInfo)
    {
        var selectedRequestId = _selectedRequest?.Id;
        
        if (updateInfo.IsDelete)
        {
            await RequestService.DeleteRequestAsync(updateInfo.RequestId);
            Snackbar.Add("Request deleted successfully", Severity.Success);
            
            // Clear selection if deleted request was selected
            if (selectedRequestId.HasValue && selectedRequestId.Value == updateInfo.RequestId)
            {
                _selectedRequest = null;
                selectedRequestId = null;
            }
        }
        else
        {
            try
            {
                var request = await RequestService.GetRequestByIdAsync(updateInfo.RequestId);
                if (request != null)
                {
                    request.Name = updateInfo.NewName;
                    await RequestService.UpdateRequestAsync(request);
                    Snackbar.Add("Request renamed successfully", Severity.Success);
                }
            }
            catch (InvalidOperationException ex) when (ex.Message.Contains("already exists"))
            {
                Snackbar.Add($"A request with the name '{updateInfo.NewName}' already exists. Please choose a different name.", Severity.Error);
            }
            catch (Exception ex)
            {
                Snackbar.Add($"Error renaming request: {ex.Message}", Severity.Error);
            }
        }
        
        await LoadData();
        
        // Re-select the request after reload to maintain state (unless it was deleted)
        if (selectedRequestId.HasValue)
        {
            var reloadedRequest = await RequestService.GetRequestByIdAsync(selectedRequestId.Value);
            if (reloadedRequest != null)
            {
                SelectRequest(reloadedRequest);
            }
        }
        
        StateHasChanged();
    }

    private void EditEnvironment()
    {
        if (_environment == null) return;
        
        // Preserve the selected request when navigating to edit
        var url = $"/environment/{_environment.Id}/edit";
        if (_selectedRequest != null)
        {
            url += $"?requestId={_selectedRequest.Id}";
        }
        NavigationManager.NavigateTo(url);
    }

    private async Task DeleteEnvironment()
    {
        if (_environment == null) return;

        var parameters = new DialogParameters
        {
            ["ContentText"] = $"Are you sure you want to delete the environment '{_environment.Name}'? This will also delete all collections and requests within it. This action cannot be undone.",
            ["ButtonText"] = "Delete",
            ["Color"] = Color.Error
        };

        var dialog = await DialogService.ShowAsync<ConfirmDialog>("Delete Environment", parameters);
        var result = await dialog.Result;

        if (!result.Canceled)
        {
            await EnvironmentService.DeleteEnvironmentAsync(_environment.Id);
            Snackbar.Add("Environment deleted successfully", Severity.Success);
            NavigationManager.NavigateTo("/");
        }
    }

    private string GetRequestIcon(RequestType type) => type switch
    {
        RequestType.Rest => Icons.Material.Filled.Http,
        RequestType.GraphQL => Icons.Material.Filled.GraphicEq,
        _ => Icons.Material.Filled.Article
    };

    private Color GetRequestColor(RequestType type) => type switch
    {
        RequestType.Rest => Color.Primary,
        RequestType.GraphQL => Color.Secondary,
        _ => Color.Default
    };



    private List<BreadcrumbItem> GetBreadcrumbs()
    {
        var breadcrumbs = new List<BreadcrumbItem>
        {
            new BreadcrumbItem(_environment?.Name ?? "Environment", href: $"/environment/{EnvironmentId}", icon: Icons.Material.Filled.Dns)
        };

        if (_selectedRequest != null)
        {
            if (_selectedRequestCollection != null)
            {
                // Link to select the collection via query parameter
                var collectionHref = $"/environment/{EnvironmentId}?collectionId={_selectedRequestCollection.Id}";
                breadcrumbs.Add(new BreadcrumbItem(_selectedRequestCollection.Name, href: collectionHref, icon: Icons.Material.Filled.Folder));
            }
            // Link to select the request via query parameter
            var requestHref = $"/environment/{EnvironmentId}?requestId={_selectedRequest.Id}";
            breadcrumbs.Add(new BreadcrumbItem(_selectedRequest.Name, href: requestHref, icon: GetRequestIcon(_selectedRequest.Type)));
        }
        else if (_selectedCollection != null)
        {
            // Link to select the collection via query parameter
            var collectionHref = $"/environment/{EnvironmentId}?collectionId={_selectedCollection.Id}";
            breadcrumbs.Add(new BreadcrumbItem(_selectedCollection.Name, href: collectionHref, icon: Icons.Material.Filled.Folder));
        }

        return breadcrumbs;
    }

    private async Task RenameRequest(Request request)
    {
        var parameters = new DialogParameters
        {
            ["CurrentName"] = request.Name
        };

        var dialog = await DialogService.ShowAsync<RenameDialog>("Rename Request", parameters);
        var result = await dialog.Result;

        if (!result.Canceled && result.Data is string newName && !string.IsNullOrWhiteSpace(newName))
        {
            try
            {
                var selectedRequestId = _selectedRequest?.Id;
                request.Name = newName;
                await RequestService.UpdateRequestAsync(request);
                Snackbar.Add("Request renamed successfully", Severity.Success);
                await LoadData();
                
                // Re-select the request after reload to maintain state
                if (selectedRequestId.HasValue)
                {
                    var reloadedRequest = await RequestService.GetRequestByIdAsync(selectedRequestId.Value);
                    if (reloadedRequest != null)
                    {
                        SelectRequest(reloadedRequest);
                    }
                }
            }
            catch (InvalidOperationException ex) when (ex.Message.Contains("already exists"))
            {
                Snackbar.Add($"A request with the name '{newName}' already exists. Please choose a different name.", Severity.Error);
            }
            catch (Exception ex)
            {
                Snackbar.Add($"Error renaming request: {ex.Message}", Severity.Error);
            }
            
            StateHasChanged();
        }
    }

    private async Task DeleteRequest(Request request)
    {
        var parameters = new DialogParameters
        {
            ["ContentText"] = $"Are you sure you want to delete the request '{request.Name}'? This action cannot be undone.",
            ["ButtonText"] = "Delete",
            ["Color"] = Color.Error
        };

        var dialog = await DialogService.ShowAsync<ConfirmDialog>("Delete Request", parameters);
        var result = await dialog.Result;

        if (!result.Canceled)
        {
            await RequestService.DeleteRequestAsync(request.Id);
            Snackbar.Add("Request deleted successfully", Severity.Success);
            
            // Clear selection if deleted request was selected
            if (_selectedRequest?.Id == request.Id)
            {
                _selectedRequest = null;
                _selectedRequestCollection = null;
            }
            
            await LoadData();
            StateHasChanged();
        }
    }
}
