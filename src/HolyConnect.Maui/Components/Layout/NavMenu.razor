@inject IEnvironmentService EnvironmentService
@inject NavigationManager NavigationManager
@implements IDisposable

<MudNavMenu>
    <MudNavLink Href="/" Icon="@Icons.Material.Filled.Home" Match="NavLinkMatch.All">Home</MudNavLink>
    
    <MudNavGroup Title="Environments" Icon="@Icons.Material.Filled.Folder" Expanded="true">
        @if (_environments != null && _environments.Any())
        {
            @foreach (var env in _environments)
            {
                <MudNavLink Href="@($"/environment/{env.Id}")" Icon="@Icons.Material.Filled.Dns">
                    @env.Name
                </MudNavLink>
            }
        }
        else
        {
            <MudText Typo="Typo.body2" Class="ml-8 mt-2" Color="Color.Default">No environments</MudText>
        }
    </MudNavGroup>
    
    <MudDivider Class="my-2" />
    
    <MudNavLink Href="/wiki/variables" Icon="@Icons.Material.Filled.Code">Variables Wiki</MudNavLink>
    <MudNavLink Href="/settings" Icon="@Icons.Material.Filled.Settings">Settings</MudNavLink>
</MudNavMenu>

@code {
    private IEnumerable<Domain.Entities.Environment>? _environments;

    protected override async Task OnInitializedAsync()
    {
        NavigationManager.LocationChanged += OnLocationChanged;
        await LoadEnvironments();
    }

    private async void OnLocationChanged(object? sender, Microsoft.AspNetCore.Components.Routing.LocationChangedEventArgs e)
    {
        try
        {
            // Reload list whenever navigation occurs (e.g., after create/save pages)
            await LoadEnvironments();
            StateHasChanged();
        }
        catch { }
    }

    private async Task LoadEnvironments()
    {
        _environments = await EnvironmentService.GetAllEnvironmentsAsync();
    }

    public void Dispose()
    {
        NavigationManager.LocationChanged -= OnLocationChanged;
    }
}
