@inject ICollectionService CollectionService
@inject IEnvironmentService EnvironmentService
@inject NavigationManager NavigationManager
@implements IDisposable

<MudNavMenu>
    <MudNavLink Href="/" Icon="@Icons.Material.Filled.Home" Match="NavLinkMatch.All">Home</MudNavLink>
    
    <MudNavGroup Title="Collections" Icon="@Icons.Material.Filled.Folder" Expanded="true">
        @if (_collections != null && _collections.Any())
        {
            @foreach (var collection in _collections.Where(c => c.ParentCollectionId == null).OrderBy(c => c.OrderIndex).ThenBy(c => c.CreatedAt))
            {
                <MudNavLink Href="@($"/collection/{collection.Id}")" Icon="@Icons.Material.Filled.Folder">
                    @collection.Name
                </MudNavLink>
            }
        }
        else
        {
            <MudText Typo="Typo.body2" Class="ml-8 mt-2" Color="Color.Default">No collections</MudText>
        }
    </MudNavGroup>
    
    <MudDivider Class="my-2" />
    
    <MudNavLink Href="/reorder" Icon="@Icons.Material.Filled.SwapVert">Reorder</MudNavLink>
    <MudNavLink Href="/variables/matrix" Icon="@Icons.Material.Filled.GridOn">Variable Matrix</MudNavLink>
    <MudNavLink Href="/environments" Icon="@Icons.Material.Filled.Dns">Manage Variables</MudNavLink>
    <MudNavLink Href="/import" Icon="@Icons.Material.Filled.Upload">Import</MudNavLink>
    <MudNavLink Href="/flows" Icon="@Icons.Material.Filled.AccountTree">Flows</MudNavLink>
    <MudNavLink Href="/git" Icon="@Icons.Material.Filled.Source">Git</MudNavLink>
    <MudNavLink Href="/history" Icon="@Icons.Material.Filled.History">History</MudNavLink>
    <MudNavLink Href="/wiki/variables" Icon="@Icons.Material.Filled.Code">Variables Wiki</MudNavLink>
    <MudNavLink Href="/shortcuts" Icon="@Icons.Material.Filled.Keyboard">Keyboard Shortcuts</MudNavLink>
    <MudNavLink Href="/settings" Icon="@Icons.Material.Filled.Settings">Settings</MudNavLink>
</MudNavMenu>

@code {
    private IEnumerable<Domain.Entities.Collection>? _collections;

    protected override async Task OnInitializedAsync()
    {
        NavigationManager.LocationChanged += OnLocationChanged;
        await LoadCollections();
    }

    private async void OnLocationChanged(object? sender, Microsoft.AspNetCore.Components.Routing.LocationChangedEventArgs e)
    {
        try
        {
            // Reload list whenever navigation occurs (e.g., after create/save pages)
            await LoadCollections();
            StateHasChanged();
        }
        catch { }
    }

    private async Task LoadCollections()
    {
        _collections = await CollectionService.GetAllCollectionsAsync();
    }

    public void Dispose()
    {
        NavigationManager.LocationChanged -= OnLocationChanged;
    }
}
