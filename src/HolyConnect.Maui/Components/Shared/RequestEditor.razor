@inject IRequestService RequestService
@inject IFormatterService FormatterService
@inject ISnackbar Snackbar
@inject SettingsService SettingsService

@if (_layout == Domain.Entities.RequestLayout.Vertical)
{
    <!-- Vertical Layout: Request on left, Response on right -->
    <MudGrid Class="flex-grow-1" Style="height: 100%; display: flex; gap: 8px;">
        <MudItem xs="6" Style="height: 100%; display: flex; flex-direction: column; overflow: hidden;">
            <div style="flex: 1; overflow-y: auto; overflow-x: hidden;">
                @RequestConfigurationSection
            </div>
        </MudItem>
        <MudItem xs="6" Style="height: 100%; display: flex; flex-direction: column; overflow: hidden;">
            <div style="flex: 1; overflow-y: auto; overflow-x: hidden;">
                @ResponseSection
            </div>
        </MudItem>
    </MudGrid>
}
else
{
    <!-- Horizontal Layout: Request on top, Response on bottom -->
    <div Style="height: 100%; display: flex; flex-direction: column; overflow: hidden;">
        <div style="flex: 0 0 auto; overflow-y: auto; overflow-x: hidden; max-height: 45%;">
            @RequestConfigurationSection
        </div>
        
        @if (_response != null)
        {
            <MudDivider Class="my-2" />
            <div style="flex: 1; overflow-y: auto; overflow-x: hidden; min-height: 0;">
                @ResponseSection
            </div>
        }
    </div>
}

@code {
    private RenderFragment RequestConfigurationSection => __builder =>
    {
<MudCard>
    <MudCardContent>
        <MudText Typo="Typo.h6" Class="mb-2">@(Request?.Name ?? "New Request")</MudText>
        
        <MudStack Row="true" Spacing="2" Class="mb-2" AlignItems="AlignItems.Center">
            <MudTextField @bind-Value="Request!.Name" Label="Name" Variant="Variant.Outlined" Dense="true" Style="flex: 1; min-width: 0;" />
            @if (Request is RestRequest restRequest)
            {
                <MudSelect @bind-Value="restRequest.Method" Label="Method" Variant="Variant.Outlined" Dense="true" Style="width: 120px; flex-shrink: 0;">
                    @foreach (var method in Enum.GetValues<Domain.Entities.HttpMethod>())
                    {
                        <MudSelectItem Value="@method">@method.ToString()</MudSelectItem>
                    }
                </MudSelect>
            }
        </MudStack>
        <VariableTextField @bind-Value="Request.Url" Label="URL" Variant="Variant.Outlined" Dense="true" Class="mb-2" Environment="@Environment" Collection="@Collection" />
        
        @if (Request is RestRequest restRequest2)
        {
            
            <MudTabs Class="mt-2" Elevation="2" Rounded="true" ApplyEffectsToContainer="true" PanelClass="pa-3">
                <MudTabPanel Text="Body">
                    <MudStack Row="true" Justify="Justify.SpaceBetween" Class="mb-2" AlignItems="AlignItems.Center">
                        <MudSelect @bind-Value="restRequest2.BodyType" Label="Body Type" Variant="Variant.Outlined" Dense="true" Style="width: 150px;">
                            @foreach (var bodyType in Enum.GetValues<Domain.Entities.BodyType>())
                            {
                                <MudSelectItem Value="@bodyType">@bodyType.ToString()</MudSelectItem>
                            }
                        </MudSelect>
                        <MudButton Variant="Variant.Outlined" 
                                   Color="Color.Primary" 
                                   Size="Size.Small" 
                                   StartIcon="@Icons.Material.Filled.AutoFixHigh"
                                   OnClick="@(() => FormatRestBody(restRequest2))">
                            Format
                        </MudButton>
                    </MudStack>
                    <CodeEditor @ref="_restBodyEditor" 
                                @bind-Value="restRequest2.Body" 
                                Language="@restRequest2.BodyType.ToString()" 
                                Height="600px" />
                </MudTabPanel>
                
                <MudTabPanel Text="Headers">
                    <MudText Typo="Typo.caption" Class="mb-2">Common Headers</MudText>
                    <MudStack Row="true" Spacing="1" Class="mb-3" Wrap="Wrap.Wrap">
                        <MudButton Variant="Variant.Outlined" Size="Size.Small" OnClick="@(() => AddCommonHeader("Content-Type", "application/json"))">
                            + JSON
                        </MudButton>
                        <MudButton Variant="Variant.Outlined" Size="Size.Small" OnClick="@(() => AddCommonHeader("Content-Type", "application/xml"))">
                            + XML
                        </MudButton>
                        <MudButton Variant="Variant.Outlined" Size="Size.Small" OnClick="@(() => AddCommonHeader("Authorization", "Bearer "))">
                            + Auth
                        </MudButton>
                        <MudButton Variant="Variant.Outlined" Size="Size.Small" OnClick="@(() => AddCommonHeader("Accept", "*/*"))">
                            + Accept
                        </MudButton>
                    </MudStack>
                    
                    @foreach (var header in _headers)
                    {
                        <MudGrid Class="mb-1" Spacing="1">
                            <MudItem xs="1" Class="d-flex align-center">
                                <MudCheckBox @bind-Value="header.Enabled" Color="Color.Primary" Dense="true" />
                            </MudItem>
                            <MudItem xs="5">
                                <MudStack Spacing="0">
                                    <VariableTextField @bind-Value="header.Key" 
                                                       Label="Header Name" 
                                                       Variant="Variant.Outlined" 
                                                       Dense="true"
                                                       Disabled="@(!header.Enabled)" 
                                                       Environment="@Environment" 
                                                       Collection="@Collection" />
                                    @if (header.IsDefault)
                                    {
                                        <MudText Typo="Typo.caption" Color="Color.Secondary" Style="font-size: 0.7rem;">(auto)</MudText>
                                    }
                                </MudStack>
                            </MudItem>
                            <MudItem xs="4">
                                <VariableTextField @bind-Value="header.Value" 
                                                   Label="Value" 
                                                   Variant="Variant.Outlined" 
                                                   Dense="true"
                                                   Disabled="@(!header.Enabled)" 
                                                   Environment="@Environment" 
                                                   Collection="@Collection" />
                            </MudItem>
                            <MudItem xs="2" Class="d-flex align-center">
                                <MudIconButton Icon="@Icons.Material.Filled.Delete" Size="Size.Small" Color="Color.Error" OnClick="@(() => RemoveHeader(header))" />
                            </MudItem>
                        </MudGrid>
                    }
                    <MudButton Variant="Variant.Outlined" Color="Color.Primary" Size="Size.Small" OnClick="AddHeader" StartIcon="@Icons.Material.Filled.Add" Class="mt-2">
                        Add Header
                    </MudButton>
                </MudTabPanel>
                
                <MudTabPanel Text="Query Params">
                    @foreach (var param in _queryParams)
                    {
                        <MudGrid Class="mb-1" Spacing="1">
                            <MudItem xs="1" Class="d-flex align-center">
                                <MudCheckBox @bind-Value="param.Enabled" Color="Color.Primary" Dense="true" />
                            </MudItem>
                            <MudItem xs="5">
                                <VariableTextField @bind-Value="param.Key" Label="Name" Variant="Variant.Outlined" Dense="true" Disabled="@(!param.Enabled)" Environment="@Environment" Collection="@Collection" />
                            </MudItem>
                            <MudItem xs="4">
                                <VariableTextField @bind-Value="param.Value" Label="Value" Variant="Variant.Outlined" Dense="true" Disabled="@(!param.Enabled)" Environment="@Environment" Collection="@Collection" />
                            </MudItem>
                            <MudItem xs="2" Class="d-flex align-center">
                                <MudIconButton Icon="@Icons.Material.Filled.Delete" Size="Size.Small" Color="Color.Error" OnClick="@(() => RemoveQueryParam(param))" />
                            </MudItem>
                        </MudGrid>
                    }
                    <MudButton Variant="Variant.Outlined" Color="Color.Primary" Size="Size.Small" OnClick="AddQueryParam" StartIcon="@Icons.Material.Filled.Add" Class="mt-2">
                        Add Query Parameter
                    </MudButton>
                </MudTabPanel>
                
                <MudTabPanel Text="Auth">
                    <MudSelect @bind-Value="Request.AuthType" Label="Authentication Type" Variant="Variant.Outlined" Dense="true" Class="mb-3">
                        @foreach (var authType in Enum.GetValues<Domain.Entities.AuthenticationType>())
                        {
                            <MudSelectItem Value="@authType">@GetAuthTypeName(authType)</MudSelectItem>
                        }
                    </MudSelect>
                    
                    @if (Request.AuthType == Domain.Entities.AuthenticationType.Basic)
                    {
                        <MudTextField @bind-Value="Request.BasicAuthUsername" Label="Username" Variant="Variant.Outlined" Dense="true" Class="mb-2" />
                        <MudTextField @bind-Value="Request.BasicAuthPassword" Label="Password" Variant="Variant.Outlined" Dense="true" InputType="InputType.Password" Class="mb-2" />
                    }
                    else if (Request.AuthType == Domain.Entities.AuthenticationType.BearerToken)
                    {
                        <VariableTextField @bind-Value="Request.BearerToken" Label="Bearer Token" Variant="Variant.Outlined" Dense="true" Lines="3" Environment="@Environment" Collection="@Collection" />
                    }
                    else
                    {
                        <MudText Typo="Typo.body2" Color="Color.Secondary">No authentication selected</MudText>
                    }
                </MudTabPanel>
                
                <MudTabPanel Text="Extractions">
                    <ResponseExtractionManager Extractions="@Request.ResponseExtractions" ExtractionsChanged="@((e) => Request.ResponseExtractions = e)" />
                </MudTabPanel>
            </MudTabs>
        }
        else if (Request is GraphQLRequest graphQLRequest)
        {
            <MudTabs Class="mt-2" Elevation="2" Rounded="true" ApplyEffectsToContainer="true" PanelClass="pa-3">
                <MudTabPanel Text="Query">
                    <MudStack Row="true" Justify="Justify.SpaceBetween" AlignItems="AlignItems.Center" Class="mb-2">
                        <MudText Typo="Typo.caption" Color="Color.Secondary">Press <strong>Ctrl+Space</strong> for autocomplete</MudText>
                        <MudButton Variant="Variant.Outlined" 
                                  Color="Color.Primary" 
                                  Size="Size.Small" 
                                  StartIcon="@Icons.Material.Filled.AutoFixHigh"
                                  OnClick="@(() => PrettifyGraphQLQuery(graphQLRequest))">
                            Prettify
                        </MudButton>
                    </MudStack>
                    <GraphQLCodeEditor @bind-Value="graphQLRequest.Query" Request="@graphQLRequest" Height="600px" />
                </MudTabPanel>
                
                <MudTabPanel Text="Variables">
                    <MudStack Row="true" Justify="Justify.FlexEnd" Class="mb-2" AlignItems="AlignItems.Center">
                        <MudButton Variant="Variant.Outlined" 
                                   Color="Color.Primary" 
                                   Size="Size.Small" 
                                   StartIcon="@Icons.Material.Filled.AutoFixHigh"
                                   OnClick="@(() => PrettifyGraphQLVariables(graphQLRequest))">
                            Prettify
                        </MudButton>
                    </MudStack>
                    <VariableTextField @bind-Value="graphQLRequest.Variables" Label="Variables (JSON)" Lines="10" Variant="Variant.Outlined" Dense="true" Environment="@Environment" Collection="@Collection" />
                </MudTabPanel>
                
                <MudTabPanel Text="Headers">
                    <MudText Typo="Typo.caption" Class="mb-2">Common Headers</MudText>
                    <MudStack Row="true" Spacing="1" Class="mb-3" Wrap="Wrap.Wrap">
                        <MudButton Variant="Variant.Outlined" Size="Size.Small" OnClick="@(() => AddCommonHeader("Content-Type", "application/json"))">
                            + JSON
                        </MudButton>
                        <MudButton Variant="Variant.Outlined" Size="Size.Small" OnClick="@(() => AddCommonHeader("Authorization", "Bearer "))">
                            + Auth
                        </MudButton>
                    </MudStack>
                    
                    @foreach (var header in _headers)
                    {
                        <MudGrid Class="mb-1" Spacing="1">
                            <MudItem xs="1" Class="d-flex align-center">
                                <MudCheckBox @bind-Value="header.Enabled" Color="Color.Primary" Dense="true" />
                            </MudItem>
                            <MudItem xs="5">
                                <MudStack Spacing="0">
                                    <VariableTextField @bind-Value="header.Key" 
                                                       Label="Header Name" 
                                                       Variant="Variant.Outlined" 
                                                       Dense="true"
                                                       Disabled="@(!header.Enabled)" 
                                                       Environment="@Environment" 
                                                       Collection="@Collection" />
                                    @if (header.IsDefault)
                                    {
                                        <MudText Typo="Typo.caption" Color="Color.Secondary" Style="font-size: 0.7rem;">(auto)</MudText>
                                    }
                                </MudStack>
                            </MudItem>
                            <MudItem xs="4">
                                <VariableTextField @bind-Value="header.Value" 
                                                   Label="Value" 
                                                   Variant="Variant.Outlined" 
                                                   Dense="true"
                                                   Disabled="@(!header.Enabled)" 
                                                   Environment="@Environment" 
                                                   Collection="@Collection" />
                            </MudItem>
                            <MudItem xs="2" Class="d-flex align-center">
                                <MudIconButton Icon="@Icons.Material.Filled.Delete" Size="Size.Small" Color="Color.Error" OnClick="@(() => RemoveHeader(header))" />
                            </MudItem>
                        </MudGrid>
                    }
                    <MudButton Variant="Variant.Outlined" Color="Color.Primary" Size="Size.Small" OnClick="AddHeader" StartIcon="@Icons.Material.Filled.Add" Class="mt-2">
                        Add Header
                    </MudButton>
                </MudTabPanel>
                
                <MudTabPanel Text="Auth">
                    <MudSelect @bind-Value="Request.AuthType" Label="Authentication Type" Variant="Variant.Outlined" Dense="true" Class="mb-3">
                            @foreach (var authType in Enum.GetValues<Domain.Entities.AuthenticationType>())
                            {
                                <MudSelectItem Value="@authType">@GetAuthTypeName(authType)</MudSelectItem>
                            }
                        </MudSelect>
                        
                        @if (Request.AuthType == Domain.Entities.AuthenticationType.Basic)
                        {
                            <MudTextField @bind-Value="Request.BasicAuthUsername" Label="Username" Variant="Variant.Outlined" Dense="true" Class="mb-2" />
                            <MudTextField @bind-Value="Request.BasicAuthPassword" Label="Password" Variant="Variant.Outlined" Dense="true" InputType="InputType.Password" Class="mb-2" />
                        }
                        else if (Request.AuthType == Domain.Entities.AuthenticationType.BearerToken)
                        {
                            <VariableTextField @bind-Value="Request.BearerToken" Label="Bearer Token" Variant="Variant.Outlined" Dense="true" Lines="3" Environment="@Environment" Collection="@Collection" />
                        }
                        else
                        {
                            <MudText Typo="Typo.body2" Color="Color.Secondary">No authentication selected</MudText>
                        }
                </MudTabPanel>
                
                <MudTabPanel Text="Extractions">
                    <ResponseExtractionManager Extractions="@Request.ResponseExtractions" ExtractionsChanged="@((e) => Request.ResponseExtractions = e)" />
                </MudTabPanel>
            </MudTabs>
        }
        else if (Request is WebSocketRequest webSocketRequest)
        {
            <MudTabs Class="mt-2" Elevation="2" Rounded="true" ApplyEffectsToContainer="true" PanelClass="pa-3">
                <MudTabPanel Text="Message">
                    <MudTextField @bind-Value="webSocketRequest.Message" 
                                  Label="Message to Send" 
                                  Lines="15" 
                                  Variant="Variant.Outlined"
                                  Dense="true"
                                  HelperText="Message to send after connection is established" />
                </MudTabPanel>
                
                <MudTabPanel Text="Headers">
                    <MudText Typo="Typo.caption" Class="mb-2">Common Headers</MudText>
                    <MudStack Row="true" Spacing="1" Class="mb-3" Wrap="Wrap.Wrap">
                        <MudButton Variant="Variant.Outlined" Size="Size.Small" OnClick="@(() => AddCommonHeader("Authorization", "Bearer "))">
                            + Auth
                        </MudButton>
                    </MudStack>
                    
                    @foreach (var header in _headers)
                    {
                        <MudGrid Class="mb-1" Spacing="1">
                            <MudItem xs="1" Class="d-flex align-center">
                                <MudCheckBox @bind-Value="header.Enabled" Color="Color.Primary" Dense="true" />
                            </MudItem>
                            <MudItem xs="5">
                                <MudStack Spacing="0">
                                    <VariableTextField @bind-Value="header.Key" 
                                                       Label="Header Name" 
                                                       Variant="Variant.Outlined" 
                                                       Dense="true"
                                                       Disabled="@(!header.Enabled)" 
                                                       Environment="@Environment" 
                                                       Collection="@Collection" />
                                    @if (header.IsDefault)
                                    {
                                        <MudText Typo="Typo.caption" Color="Color.Secondary" Style="font-size: 0.7rem;">(auto)</MudText>
                                    }
                                </MudStack>
                            </MudItem>
                            <MudItem xs="4">
                                <VariableTextField @bind-Value="header.Value" 
                                                   Label="Value" 
                                                   Variant="Variant.Outlined" 
                                                   Dense="true"
                                                   Disabled="@(!header.Enabled)" 
                                                   Environment="@Environment" 
                                                   Collection="@Collection" />
                            </MudItem>
                            <MudItem xs="2" Class="d-flex align-center">
                                <MudIconButton Icon="@Icons.Material.Filled.Delete" Size="Size.Small" Color="Color.Error" OnClick="@(() => RemoveHeader(header))" />
                            </MudItem>
                        </MudGrid>
                    }
                    <MudButton Variant="Variant.Outlined" Color="Color.Primary" Size="Size.Small" OnClick="AddHeader" StartIcon="@Icons.Material.Filled.Add" Class="mt-2">
                        Add Header
                    </MudButton>
                </MudTabPanel>
                
                <MudTabPanel Text="Protocols">
                    <MudText Typo="Typo.caption" Class="mb-2">Sub-protocols (optional)</MudText>
                    @foreach (var protocol in _protocols)
                    {
                        <MudGrid Class="mb-1" Spacing="1">
                            <MudItem xs="10">
                                <MudTextField @bind-Value="protocol.Value" Label="Protocol" Variant="Variant.Outlined" Dense="true" />
                            </MudItem>
                            <MudItem xs="2" Class="d-flex align-center">
                                <MudIconButton Icon="@Icons.Material.Filled.Delete" Size="Size.Small" Color="Color.Error" OnClick="@(() => RemoveProtocol(protocol))" />
                            </MudItem>
                        </MudGrid>
                    }
                    <MudButton Variant="Variant.Outlined" Color="Color.Primary" Size="Size.Small" OnClick="AddProtocol" StartIcon="@Icons.Material.Filled.Add" Class="mt-2">
                        Add Protocol
                    </MudButton>
                </MudTabPanel>
                
                <MudTabPanel Text="Auth">
                    <MudSelect @bind-Value="Request.AuthType" Label="Authentication Type" Variant="Variant.Outlined" Dense="true" Class="mb-3">
                        @foreach (var authType in Enum.GetValues<Domain.Entities.AuthenticationType>())
                        {
                            <MudSelectItem Value="@authType">@GetAuthTypeName(authType)</MudSelectItem>
                        }
                    </MudSelect>
                    
                    @if (Request.AuthType == Domain.Entities.AuthenticationType.Basic)
                    {
                        <MudTextField @bind-Value="Request.BasicAuthUsername" Label="Username" Variant="Variant.Outlined" Dense="true" Class="mb-2" />
                        <MudTextField @bind-Value="Request.BasicAuthPassword" Label="Password" Variant="Variant.Outlined" Dense="true" InputType="InputType.Password" Class="mb-2" />
                    }
                    else if (Request.AuthType == Domain.Entities.AuthenticationType.BearerToken)
                    {
                        <VariableTextField @bind-Value="Request.BearerToken" Label="Bearer Token" Variant="Variant.Outlined" Dense="true" Lines="3" Environment="@Environment" Collection="@Collection" />
                    }
                    else
                    {
                        <MudText Typo="Typo.body2" Color="Color.Secondary">No authentication selected</MudText>
                    }
                </MudTabPanel>
            </MudTabs>
        }
    </MudCardContent>
    <MudCardActions Class="pa-2">
        <MudStack Row="true" Spacing="1" AlignItems="AlignItems.Center" Wrap="Wrap.Wrap">
            <MudButton Variant="Variant.Filled" 
                      Color="Color.Primary" 
                      Size="Size.Small"
                      OnClick="ExecuteRequest" 
                      StartIcon="@Icons.Material.Filled.Send"
                      Disabled="_isExecuting">
                @if (_isExecuting)
                {
                    <MudProgressCircular Class="mr-1" Size="Size.Small" Indeterminate="true" />
                    <span>Sending...</span>
                }
                else
                {
                    <span>Send</span>
                }
            </MudButton>
            <MudButton Variant="Variant.Filled" Color="Color.Secondary" Size="Size.Small" OnClick="SaveRequestInternal" Disabled="_isExecuting">
                Save
            </MudButton>
            <MudMenu Icon="@Icons.Material.Filled.SwapHoriz" 
                     Variant="Variant.Outlined" 
                     Size="Size.Small"
                     Disabled="_isExecuting">
                @if (Request?.Type != RequestType.Rest)
                {
                    <MudMenuItem OnClick="@(() => ConvertRequestTo(RequestType.Rest))">REST</MudMenuItem>
                }
                @if (Request?.Type != RequestType.GraphQL)
                {
                    <MudMenuItem OnClick="@(() => ConvertRequestTo(RequestType.GraphQL))">GraphQL</MudMenuItem>
                }
                @if (Request?.Type != RequestType.WebSocket)
                {
                    <MudMenuItem OnClick="@(() => ConvertRequestTo(RequestType.WebSocket))">WebSocket</MudMenuItem>
                }
            </MudMenu>
            <MudButton Variant="Variant.Outlined" Size="Size.Small" Color="Color.Default" OnClick="@(() => OnCancel.InvokeAsync())" Disabled="_isExecuting">
                Cancel
            </MudButton>
        </MudStack>
    </MudCardActions>
</MudCard>
    };

    private RenderFragment ResponseSection => __builder =>
    {
        <ResponseViewer Response="@_response" />
    };
}

@code {
    [Parameter]
    public Request? Request { get; set; }

    [Parameter]
    public EventCallback OnSave { get; set; }

    [Parameter]
    public EventCallback OnCancel { get; set; }

    [Parameter]
    public Domain.Entities.Environment? Environment { get; set; }

    [Parameter]
    public Collection? Collection { get; set; }

    private List<HeaderModel> _headers = new();
    private List<ParamModel> _queryParams = new();
    private List<ProtocolModel> _protocols = new();
    private RequestResponse? _response;
    private Domain.Entities.RequestLayout _layout = Domain.Entities.RequestLayout.Horizontal;
    private bool _isExecuting;
    private CodeEditor? _restBodyEditor;

    private class HeaderModel
    {
        public string Key { get; set; } = string.Empty;
        public string Value { get; set; } = string.Empty;
        public bool Enabled { get; set; } = true;
        public bool IsDefault { get; set; } = false;
    }

    private class ParamModel
    {
        public string Key { get; set; } = string.Empty;
        public string Value { get; set; } = string.Empty;
        public bool Enabled { get; set; } = true;
    }

    private class ProtocolModel
    {
        public string Value { get; set; } = string.Empty;
    }

    protected override async Task OnInitializedAsync()
    {
        var settings = await SettingsService.GetSettingsAsync();
        _layout = settings.Layout;
    }

    protected override void OnParametersSet()
    {
        if (Request != null)
        {
            _headers = Request.Headers.Select(h => new HeaderModel 
            { 
                Key = h.Key, 
                Value = h.Value,
                Enabled = !Request.DisabledHeaders.Contains(h.Key)
            }).ToList();
            
            // Add default User-Agent header if not already present
            if (!_headers.Any(h => h.Key.Equals("User-Agent", StringComparison.OrdinalIgnoreCase)))
            {
                _headers.Insert(0, new HeaderModel 
                { 
                    Key = "User-Agent", 
                    Value = "HolyConnect/1.0",
                    Enabled = true,
                    IsDefault = true
                });
            }
            
            // Add default Content-Type header for REST requests with body
            if (Request is RestRequest restRequest)
            {
                _queryParams = restRequest.QueryParameters.Select(p => new ParamModel 
                { 
                    Key = p.Key, 
                    Value = p.Value,
                    Enabled = !restRequest.DisabledQueryParameters.Contains(p.Key)
                }).ToList();
                
                // Add Content-Type header if there's a body and no explicit Content-Type
                if (!string.IsNullOrEmpty(restRequest.Body) && 
                    !_headers.Any(h => h.Key.Equals("Content-Type", StringComparison.OrdinalIgnoreCase)))
                {
                    var contentType = GetDefaultContentType(restRequest);
                    _headers.Insert(_headers.Any(h => h.IsDefault) ? 1 : 0, new HeaderModel 
                    { 
                        Key = "Content-Type", 
                        Value = contentType,
                        Enabled = true,
                        IsDefault = true
                    });
                }
            }
            
            // Add default Content-Type header for GraphQL requests (always JSON)
            if (Request is GraphQLRequest && 
                !_headers.Any(h => h.Key.Equals("Content-Type", StringComparison.OrdinalIgnoreCase)))
            {
                _headers.Insert(_headers.Any(h => h.IsDefault) ? 1 : 0, new HeaderModel 
                { 
                    Key = "Content-Type", 
                    Value = "application/json",
                    Enabled = true,
                    IsDefault = true
                });
            }
            
            if (Request is WebSocketRequest wsRequest)
            {
                _protocols = wsRequest.Protocols.Select(p => new ProtocolModel { Value = p }).ToList();
            }
        }
    }

    private string GetDefaultContentType(RestRequest request)
    {
        if (!string.IsNullOrEmpty(request.ContentType))
        {
            return request.ContentType;
        }

        return request.BodyType switch
        {
            BodyType.Json => "application/json",
            BodyType.Xml => "application/xml",
            BodyType.Html => "text/html",
            BodyType.JavaScript => "application/javascript",
            BodyType.Text => "text/plain",
            _ => "text/plain"
        };
    }

    private void AddHeader()
    {
        _headers.Add(new HeaderModel());
    }

    private void RemoveHeader(HeaderModel header)
    {
        _headers.Remove(header);
    }

    private void AddQueryParam()
    {
        _queryParams.Add(new ParamModel());
    }

    private void RemoveQueryParam(ParamModel param)
    {
        _queryParams.Remove(param);
    }

    private void AddProtocol()
    {
        _protocols.Add(new ProtocolModel());
    }

    private void RemoveProtocol(ProtocolModel protocol)
    {
        _protocols.Remove(protocol);
    }

    private void AddCommonHeader(string key, string value)
    {
        var existingHeader = _headers.FirstOrDefault(h => h.Key == key);
        if (existingHeader != null)
        {
            existingHeader.Value = value;
        }
        else
        {
            _headers.Add(new HeaderModel { Key = key, Value = value });
        }
        StateHasChanged();
    }

    private async Task FormatRestBody(RestRequest restRequest)
    {
        if (string.IsNullOrWhiteSpace(restRequest.Body) || _restBodyEditor == null)
        {
            return;
        }

        try
        {
            await _restBodyEditor.FormatDocumentAsync();
            Snackbar.Add("Body formatted successfully", Severity.Success);
        }
        catch (Exception ex)
        {
            Snackbar.Add($"Error formatting body: {ex.Message}", Severity.Warning);
        }
    }

    private void PrettifyGraphQLQuery(GraphQLRequest graphQLRequest)
    {
        if (string.IsNullOrWhiteSpace(graphQLRequest.Query))
        {
            return;
        }

        try
        {
            graphQLRequest.Query = FormatterService.FormatGraphQL(graphQLRequest.Query);
            StateHasChanged();
        }
        catch (Exception ex)
        {
            Snackbar.Add($"Error formatting query: {ex.Message}", Severity.Warning);
        }
    }

    private void PrettifyGraphQLVariables(GraphQLRequest graphQLRequest)
    {
        if (string.IsNullOrWhiteSpace(graphQLRequest.Variables))
        {
            return;
        }

        try
        {
            graphQLRequest.Variables = FormatterService.FormatJson(graphQLRequest.Variables);
            StateHasChanged();
        }
        catch (Exception ex)
        {
            Snackbar.Add($"Error formatting variables: {ex.Message}", Severity.Warning);
        }
    }

    private async Task ExecuteRequest()
    {
        if (Request == null) return;

        _isExecuting = true;
        StateHasChanged();

        try
        {
            SyncHeaders();
            SyncQueryParams();
            SyncProtocols();
            _response = await RequestService.ExecuteRequestAsync(Request);
            Snackbar.Add("Request executed successfully", Severity.Success);
        }
        catch (Exception ex)
        {
            Snackbar.Add($"Error executing request: {ex.Message}", Severity.Error);
        }
        finally
        {
            _isExecuting = false;
            StateHasChanged();
        }
    }

    private async Task SaveRequestInternal()
    {
        if (Request == null) return;

        SyncHeaders();
        SyncQueryParams();
        SyncProtocols();
        await OnSave.InvokeAsync();
    }

    private void SyncHeaders()
    {
        if (Request != null)
        {
            Request.Headers.Clear();
            Request.DisabledHeaders.Clear();
            
            foreach (var header in _headers.Where(h => !string.IsNullOrWhiteSpace(h.Key)))
            {
                if (header.Enabled)
                {
                    // For default headers that haven't been modified, skip adding to Headers
                    // (they'll be auto-added by the executor)
                    if (header.IsDefault && !IsHeaderModified(header))
                    {
                        continue;
                    }
                    
                    Request.Headers[header.Key] = header.Value;
                }
                else
                {
                    // Always add disabled headers to DisabledHeaders, including default ones
                    Request.DisabledHeaders.Add(header.Key);
                }
            }
        }
    }

    private bool IsHeaderModified(HeaderModel header)
    {
        // Check if the default header has been modified from its default value
        if (header.Key.Equals("User-Agent", StringComparison.OrdinalIgnoreCase))
        {
            return header.Value != "HolyConnect/1.0";
        }
        
        if (header.Key.Equals("Content-Type", StringComparison.OrdinalIgnoreCase))
        {
            if (Request is RestRequest restRequest)
            {
                var defaultContentType = GetDefaultContentType(restRequest);
                return header.Value != defaultContentType;
            }
            
            if (Request is GraphQLRequest)
            {
                return header.Value != "application/json";
            }
        }
        
        return true; // If we can't determine, assume it's modified
    }

    private void SyncQueryParams()
    {
        if (Request is RestRequest restRequest)
        {
            restRequest.QueryParameters.Clear();
            restRequest.DisabledQueryParameters.Clear();
            
            foreach (var param in _queryParams.Where(p => !string.IsNullOrWhiteSpace(p.Key)))
            {
                if (param.Enabled)
                {
                    restRequest.QueryParameters[param.Key] = param.Value;
                }
                else
                {
                    restRequest.DisabledQueryParameters.Add(param.Key);
                }
            }
        }
    }

    private void SyncProtocols()
    {
        if (Request is WebSocketRequest wsRequest)
        {
            wsRequest.Protocols.Clear();
            
            foreach (var protocol in _protocols.Where(p => !string.IsNullOrWhiteSpace(p.Value)))
            {
                wsRequest.Protocols.Add(protocol.Value);
            }
        }
    }

    private string GetAuthTypeName(Domain.Entities.AuthenticationType authType)
    {
        return authType switch
        {
            Domain.Entities.AuthenticationType.None => "No Auth",
            Domain.Entities.AuthenticationType.Basic => "Basic Auth",
            Domain.Entities.AuthenticationType.BearerToken => "Bearer Token",
            _ => authType.ToString()
        };
    }

    private async Task ConvertRequestTo(RequestType targetType)
    {
        if (Request == null) return;

        try
        {
            // Sync current state
            SyncHeaders();
            SyncQueryParams();
            SyncProtocols();

            // Store the original request ID and references
            var originalId = Request.Id;
            var originalCollectionId = Request.CollectionId;
            var originalEnvironmentId = Request.EnvironmentId;

            // Delete the original request
            await RequestService.DeleteRequestAsync(originalId);

            // Convert to new type
            var convertedRequest = Application.Common.RequestConverter.ConvertTo(Request, targetType);
            
            // Use the original ID to replace the request
            convertedRequest.Id = originalId;
            convertedRequest.CollectionId = originalCollectionId;
            convertedRequest.EnvironmentId = originalEnvironmentId;
            
            // Remove the "(TypeName)" suffix from the name that ConvertTo adds
            convertedRequest.Name = Request.Name;
            
            // Create the converted request (effectively replacing the original)
            var createdRequest = await RequestService.CreateRequestAsync(convertedRequest);
            
            Snackbar.Add($"Request converted to {targetType} successfully", Severity.Success);
            
            // Update the local Request reference to the converted request
            Request = createdRequest;
            
            // Notify parent component to refresh
            await OnSave.InvokeAsync();
        }
        catch (Exception ex)
        {
            Snackbar.Add($"Error converting request: {ex.Message}", Severity.Error);
        }
    }
}
