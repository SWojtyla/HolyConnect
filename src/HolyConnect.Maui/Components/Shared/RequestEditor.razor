@inject IRequestService RequestService
@inject IFormatterService FormatterService
@inject ISnackbar Snackbar
@inject SettingsService SettingsService

@if (_layout == Domain.Entities.RequestLayout.Vertical)
{
    <!-- Vertical Layout: Request on left, Response on right -->
    <MudGrid Class="flex-grow-1">
        <MudItem xs="6" Class="overflow-y-auto">
            @RequestConfigurationSection
        </MudItem>
        <MudItem xs="6" Class="overflow-y-auto">
            @ResponseSection
        </MudItem>
    </MudGrid>
}
else
{
    <!-- Horizontal Layout: Request on top, Response on bottom -->
    <div>
        @RequestConfigurationSection
        
        @if (_response != null)
        {
            <MudDivider Class="my-4" />
            @ResponseSection
        }
    </div>
}

@code {
    private RenderFragment RequestConfigurationSection => __builder =>
    {
<MudCard>
    <MudCardContent>
        <MudText Typo="Typo.h5" Class="mb-4">@(Request?.Name ?? "New Request")</MudText>
        
        <MudTextField @bind-Value="Request!.Name" Label="Request Name" Variant="Variant.Outlined" Class="mb-2" />
        <VariableTextField @bind-Value="Request.Url" Label="URL" Variant="Variant.Outlined" Class="mb-2" Environment="@Environment" Collection="@Collection" />
        
        @if (Request is RestRequest restRequest)
        {
            <MudSelect @bind-Value="restRequest.Method" Label="Method" Variant="Variant.Outlined" Class="mb-2">
                @foreach (var method in Enum.GetValues<Domain.Entities.HttpMethod>())
                {
                    <MudSelectItem Value="@method">@method.ToString()</MudSelectItem>
                }
            </MudSelect>
            
            <MudTabs Class="mt-4" Elevation="2" Rounded="true" ApplyEffectsToContainer="true">
                <MudTabPanel Text="Body">
                    <div class="pa-4">
                        <MudStack Row="true" Justify="Justify.SpaceBetween" Class="mb-2">
                            <MudSelect @bind-Value="restRequest.BodyType" Label="Body Type" Variant="Variant.Outlined" Dense="true" Class="flex-shrink-1" Style="max-width: 200px;">
                                @foreach (var bodyType in Enum.GetValues<Domain.Entities.BodyType>())
                                {
                                    <MudSelectItem Value="@bodyType">@bodyType.ToString()</MudSelectItem>
                                }
                            </MudSelect>
                            <MudButton Variant="Variant.Outlined" Color="Color.Primary" Size="Size.Small" OnClick="@(() => PrettifyBody(restRequest))">
                                Prettify
                            </MudButton>
                        </MudStack>
                        <VariableTextField @bind-Value="restRequest.Body" Label="Request Body" Lines="12" Variant="Variant.Outlined" Environment="@Environment" Collection="@Collection" />
                    </div>
                </MudTabPanel>
                
                <MudTabPanel Text="Headers">
                    <div class="pa-4">
                        <MudText Typo="Typo.subtitle2" Class="mb-2">Common Headers</MudText>
                        <MudStack Row="true" Spacing="2" Class="mb-4">
                            <MudButton Variant="Variant.Outlined" Size="Size.Small" OnClick="@(() => AddCommonHeader("Content-Type", "application/json"))">
                                + JSON
                            </MudButton>
                            <MudButton Variant="Variant.Outlined" Size="Size.Small" OnClick="@(() => AddCommonHeader("Content-Type", "application/xml"))">
                                + XML
                            </MudButton>
                            <MudButton Variant="Variant.Outlined" Size="Size.Small" OnClick="@(() => AddCommonHeader("Authorization", "Bearer "))">
                                + Auth
                            </MudButton>
                            <MudButton Variant="Variant.Outlined" Size="Size.Small" OnClick="@(() => AddCommonHeader("Accept", "*/*"))">
                                + Accept
                            </MudButton>
                        </MudStack>
                        
                        @foreach (var header in _headers)
                        {
                            <MudGrid Class="mb-2">
                                <MudItem xs="1" Class="d-flex align-center">
                                    <MudCheckBox @bind-Value="header.Enabled" Color="Color.Primary" />
                                </MudItem>
                                <MudItem xs="5">
                                    <VariableTextField @bind-Value="header.Key" Label="Header Name" Variant="Variant.Outlined" Disabled="@(!header.Enabled)" Environment="@Environment" Collection="@Collection" />
                                </MudItem>
                                <MudItem xs="4">
                                    <VariableTextField @bind-Value="header.Value" Label="Header Value" Variant="Variant.Outlined" Disabled="@(!header.Enabled)" Environment="@Environment" Collection="@Collection" />
                                </MudItem>
                                <MudItem xs="2" Class="d-flex align-center">
                                    <MudIconButton Icon="@Icons.Material.Filled.Delete" Color="Color.Error" OnClick="@(() => RemoveHeader(header))" />
                                </MudItem>
                            </MudGrid>
                        }
                        <MudButton Variant="Variant.Outlined" Color="Color.Primary" OnClick="AddHeader" StartIcon="@Icons.Material.Filled.Add">
                            Add Header
                        </MudButton>
                    </div>
                </MudTabPanel>
                
                <MudTabPanel Text="Query Params">
                    <div class="pa-4">
                        @foreach (var param in _queryParams)
                        {
                            <MudGrid Class="mb-2">
                                <MudItem xs="1" Class="d-flex align-center">
                                    <MudCheckBox @bind-Value="param.Enabled" Color="Color.Primary" />
                                </MudItem>
                                <MudItem xs="5">
                                    <VariableTextField @bind-Value="param.Key" Label="Parameter Name" Variant="Variant.Outlined" Disabled="@(!param.Enabled)" Environment="@Environment" Collection="@Collection" />
                                </MudItem>
                                <MudItem xs="4">
                                    <VariableTextField @bind-Value="param.Value" Label="Parameter Value" Variant="Variant.Outlined" Disabled="@(!param.Enabled)" Environment="@Environment" Collection="@Collection" />
                                </MudItem>
                                <MudItem xs="2" Class="d-flex align-center">
                                    <MudIconButton Icon="@Icons.Material.Filled.Delete" Color="Color.Error" OnClick="@(() => RemoveQueryParam(param))" />
                                </MudItem>
                            </MudGrid>
                        }
                        <MudButton Variant="Variant.Outlined" Color="Color.Primary" OnClick="AddQueryParam" StartIcon="@Icons.Material.Filled.Add">
                            Add Query Parameter
                        </MudButton>
                    </div>
                </MudTabPanel>
                
                <MudTabPanel Text="Auth">
                    <div class="pa-4">
                        <MudSelect @bind-Value="Request.AuthType" Label="Authentication Type" Variant="Variant.Outlined" Class="mb-4">
                            @foreach (var authType in Enum.GetValues<Domain.Entities.AuthenticationType>())
                            {
                                <MudSelectItem Value="@authType">@GetAuthTypeName(authType)</MudSelectItem>
                            }
                        </MudSelect>
                        
                        @if (Request.AuthType == Domain.Entities.AuthenticationType.Basic)
                        {
                            <MudTextField @bind-Value="Request.BasicAuthUsername" Label="Username" Variant="Variant.Outlined" Class="mb-2" />
                            <MudTextField @bind-Value="Request.BasicAuthPassword" Label="Password" Variant="Variant.Outlined" InputType="InputType.Password" Class="mb-2" />
                        }
                        else if (Request.AuthType == Domain.Entities.AuthenticationType.BearerToken)
                        {
                            <VariableTextField @bind-Value="Request.BearerToken" Label="Bearer Token" Variant="Variant.Outlined" Lines="3" Environment="@Environment" Collection="@Collection" />
                        }
                        else
                        {
                            <MudText Typo="Typo.body2" Color="Color.Default">No authentication selected</MudText>
                        }
                    </div>
                </MudTabPanel>
                
                <MudTabPanel Text="Extractions">
                    <div class="pa-4">
                        <ResponseExtractionManager Extractions="@Request.ResponseExtractions" ExtractionsChanged="@((e) => Request.ResponseExtractions = e)" />
                    </div>
                </MudTabPanel>
            </MudTabs>
        }
        else if (Request is GraphQLRequest graphQLRequest)
        {
            <MudTabs Class="mt-4" Elevation="2" Rounded="true" ApplyEffectsToContainer="true">
                <MudTabPanel Text="Query">
                    <div class="pa-4">
                        <MudStack Row="true" Justify="Justify.FlexEnd" Class="mb-2">
                            <MudButton Variant="Variant.Outlined" Color="Color.Primary" Size="Size.Small" OnClick="@(() => PrettifyGraphQLQuery(graphQLRequest))">
                                Prettify
                            </MudButton>
                        </MudStack>
                        <VariableTextField @bind-Value="graphQLRequest.Query" Label="GraphQL Query" Lines="12" Variant="Variant.Outlined" Environment="@Environment" Collection="@Collection" />
                    </div>
                </MudTabPanel>
                
                <MudTabPanel Text="Variables">
                    <div class="pa-4">
                        <MudStack Row="true" Justify="Justify.FlexEnd" Class="mb-2">
                            <MudButton Variant="Variant.Outlined" Color="Color.Primary" Size="Size.Small" OnClick="@(() => PrettifyGraphQLVariables(graphQLRequest))">
                                Prettify
                            </MudButton>
                        </MudStack>
                        <VariableTextField @bind-Value="graphQLRequest.Variables" Label="Variables (JSON)" Lines="8" Variant="Variant.Outlined" Environment="@Environment" Collection="@Collection" />
                    </div>
                </MudTabPanel>
                
                <MudTabPanel Text="Headers">
                    <div class="pa-4">
                        <MudText Typo="Typo.subtitle2" Class="mb-2">Common Headers</MudText>
                        <MudStack Row="true" Spacing="2" Class="mb-4">
                            <MudButton Variant="Variant.Outlined" Size="Size.Small" OnClick="@(() => AddCommonHeader("Content-Type", "application/json"))">
                                + JSON
                            </MudButton>
                            <MudButton Variant="Variant.Outlined" Size="Size.Small" OnClick="@(() => AddCommonHeader("Authorization", "Bearer "))">
                                + Auth
                            </MudButton>
                        </MudStack>
                        
                        @foreach (var header in _headers)
                        {
                            <MudGrid Class="mb-2">
                                <MudItem xs="1" Class="d-flex align-center">
                                    <MudCheckBox @bind-Value="header.Enabled" Color="Color.Primary" />
                                </MudItem>
                                <MudItem xs="5">
                                    <VariableTextField @bind-Value="header.Key" Label="Header Name" Variant="Variant.Outlined" Disabled="@(!header.Enabled)" Environment="@Environment" Collection="@Collection" />
                                </MudItem>
                                <MudItem xs="4">
                                    <VariableTextField @bind-Value="header.Value" Label="Header Value" Variant="Variant.Outlined" Disabled="@(!header.Enabled)" Environment="@Environment" Collection="@Collection" />
                                </MudItem>
                                <MudItem xs="2" Class="d-flex align-center">
                                    <MudIconButton Icon="@Icons.Material.Filled.Delete" Color="Color.Error" OnClick="@(() => RemoveHeader(header))" />
                                </MudItem>
                            </MudGrid>
                        }
                        <MudButton Variant="Variant.Outlined" Color="Color.Primary" OnClick="AddHeader" StartIcon="@Icons.Material.Filled.Add">
                            Add Header
                        </MudButton>
                    </div>
                </MudTabPanel>
                
                <MudTabPanel Text="Auth">
                    <div class="pa-4">
                        <MudSelect @bind-Value="Request.AuthType" Label="Authentication Type" Variant="Variant.Outlined" Class="mb-4">
                            @foreach (var authType in Enum.GetValues<Domain.Entities.AuthenticationType>())
                            {
                                <MudSelectItem Value="@authType">@GetAuthTypeName(authType)</MudSelectItem>
                            }
                        </MudSelect>
                        
                        @if (Request.AuthType == Domain.Entities.AuthenticationType.Basic)
                        {
                            <MudTextField @bind-Value="Request.BasicAuthUsername" Label="Username" Variant="Variant.Outlined" Class="mb-2" />
                            <MudTextField @bind-Value="Request.BasicAuthPassword" Label="Password" Variant="Variant.Outlined" InputType="InputType.Password" Class="mb-2" />
                        }
                        else if (Request.AuthType == Domain.Entities.AuthenticationType.BearerToken)
                        {
                            <VariableTextField @bind-Value="Request.BearerToken" Label="Bearer Token" Variant="Variant.Outlined" Lines="3" Environment="@Environment" Collection="@Collection" />
                        }
                        else
                        {
                            <MudText Typo="Typo.body2" Color="Color.Default">No authentication selected</MudText>
                        }
                    </div>
                </MudTabPanel>
                
                <MudTabPanel Text="Extractions">
                    <div class="pa-4">
                        <ResponseExtractionManager Extractions="@Request.ResponseExtractions" ExtractionsChanged="@((e) => Request.ResponseExtractions = e)" />
                    </div>
                </MudTabPanel>
            </MudTabs>
        }
    </MudCardContent>
    <MudCardActions>
        <MudStack Row="true" Spacing="2" AlignItems="AlignItems.Center">
            <MudButton Variant="Variant.Filled" 
                      Color="Color.Primary" 
                      OnClick="ExecuteRequest" 
                      StartIcon="@Icons.Material.Filled.Send"
                      Disabled="_isExecuting">
                @if (_isExecuting)
                {
                    <MudProgressCircular Class="mr-2" Size="Size.Small" Indeterminate="true" />
                    <span>Sending...</span>
                }
                else
                {
                    <span>Send</span>
                }
            </MudButton>
            <MudButton Variant="Variant.Filled" Color="Color.Secondary" OnClick="SaveRequestInternal" Disabled="_isExecuting">
                Save
            </MudButton>
            <MudButton Variant="Variant.Outlined" Color="Color.Default" OnClick="@(() => OnCancel.InvokeAsync())" Disabled="_isExecuting">
                Cancel
            </MudButton>
        </MudStack>
    </MudCardActions>
</MudCard>
    };

    private RenderFragment ResponseSection => __builder =>
    {
        <ResponseViewer Response="@_response" />
    };
}

@code {
    [Parameter]
    public Request? Request { get; set; }

    [Parameter]
    public EventCallback OnSave { get; set; }

    [Parameter]
    public EventCallback OnCancel { get; set; }

    [Parameter]
    public Domain.Entities.Environment? Environment { get; set; }

    [Parameter]
    public Collection? Collection { get; set; }

    private List<HeaderModel> _headers = new();
    private List<ParamModel> _queryParams = new();
    private RequestResponse? _response;
    private Domain.Entities.RequestLayout _layout = Domain.Entities.RequestLayout.Horizontal;
    private bool _isExecuting;

    private class HeaderModel
    {
        public string Key { get; set; } = string.Empty;
        public string Value { get; set; } = string.Empty;
        public bool Enabled { get; set; } = true;
    }

    private class ParamModel
    {
        public string Key { get; set; } = string.Empty;
        public string Value { get; set; } = string.Empty;
        public bool Enabled { get; set; } = true;
    }

    protected override async Task OnInitializedAsync()
    {
        var settings = await SettingsService.GetSettingsAsync();
        _layout = settings.Layout;
    }

    protected override void OnParametersSet()
    {
        if (Request != null)
        {
            _headers = Request.Headers.Select(h => new HeaderModel 
            { 
                Key = h.Key, 
                Value = h.Value,
                Enabled = !Request.DisabledHeaders.Contains(h.Key)
            }).ToList();
            
            if (Request is RestRequest restRequest)
            {
                _queryParams = restRequest.QueryParameters.Select(p => new ParamModel 
                { 
                    Key = p.Key, 
                    Value = p.Value,
                    Enabled = !restRequest.DisabledQueryParameters.Contains(p.Key)
                }).ToList();
            }
        }
    }

    private void AddHeader()
    {
        _headers.Add(new HeaderModel());
    }

    private void RemoveHeader(HeaderModel header)
    {
        _headers.Remove(header);
    }

    private void AddQueryParam()
    {
        _queryParams.Add(new ParamModel());
    }

    private void RemoveQueryParam(ParamModel param)
    {
        _queryParams.Remove(param);
    }

    private void AddCommonHeader(string key, string value)
    {
        var existingHeader = _headers.FirstOrDefault(h => h.Key == key);
        if (existingHeader != null)
        {
            existingHeader.Value = value;
        }
        else
        {
            _headers.Add(new HeaderModel { Key = key, Value = value });
        }
        StateHasChanged();
    }

    private void PrettifyBody(RestRequest restRequest)
    {
        if (string.IsNullOrWhiteSpace(restRequest.Body))
        {
            return;
        }

        try
        {
            restRequest.Body = restRequest.BodyType switch
            {
                Domain.Entities.BodyType.Json => FormatterService.FormatJson(restRequest.Body),
                Domain.Entities.BodyType.Xml => FormatterService.FormatXml(restRequest.Body),
                _ => restRequest.Body
            };
            StateHasChanged();
        }
        catch (Exception ex)
        {
            Snackbar.Add($"Error formatting body: {ex.Message}", Severity.Warning);
        }
    }

    private void PrettifyGraphQLQuery(GraphQLRequest graphQLRequest)
    {
        if (string.IsNullOrWhiteSpace(graphQLRequest.Query))
        {
            return;
        }

        try
        {
            graphQLRequest.Query = FormatterService.FormatGraphQL(graphQLRequest.Query);
            StateHasChanged();
        }
        catch (Exception ex)
        {
            Snackbar.Add($"Error formatting query: {ex.Message}", Severity.Warning);
        }
    }

    private void PrettifyGraphQLVariables(GraphQLRequest graphQLRequest)
    {
        if (string.IsNullOrWhiteSpace(graphQLRequest.Variables))
        {
            return;
        }

        try
        {
            graphQLRequest.Variables = FormatterService.FormatJson(graphQLRequest.Variables);
            StateHasChanged();
        }
        catch (Exception ex)
        {
            Snackbar.Add($"Error formatting variables: {ex.Message}", Severity.Warning);
        }
    }

    private async Task ExecuteRequest()
    {
        if (Request == null) return;

        _isExecuting = true;
        StateHasChanged();

        try
        {
            SyncHeaders();
            SyncQueryParams();
            _response = await RequestService.ExecuteRequestAsync(Request);
            Snackbar.Add("Request executed successfully", Severity.Success);
        }
        catch (Exception ex)
        {
            Snackbar.Add($"Error executing request: {ex.Message}", Severity.Error);
        }
        finally
        {
            _isExecuting = false;
            StateHasChanged();
        }
    }

    private async Task SaveRequestInternal()
    {
        if (Request == null) return;

        SyncHeaders();
        SyncQueryParams();
        await OnSave.InvokeAsync();
    }

    private void SyncHeaders()
    {
        if (Request != null)
        {
            Request.Headers.Clear();
            Request.DisabledHeaders.Clear();
            
            foreach (var header in _headers.Where(h => !string.IsNullOrWhiteSpace(h.Key)))
            {
                if (header.Enabled)
                {
                    Request.Headers[header.Key] = header.Value;
                }
                else
                {
                    Request.DisabledHeaders.Add(header.Key);
                }
            }
        }
    }

    private void SyncQueryParams()
    {
        if (Request is RestRequest restRequest)
        {
            restRequest.QueryParameters.Clear();
            restRequest.DisabledQueryParameters.Clear();
            
            foreach (var param in _queryParams.Where(p => !string.IsNullOrWhiteSpace(p.Key)))
            {
                if (param.Enabled)
                {
                    restRequest.QueryParameters[param.Key] = param.Value;
                }
                else
                {
                    restRequest.DisabledQueryParameters.Add(param.Key);
                }
            }
        }
    }

    private string GetAuthTypeName(Domain.Entities.AuthenticationType authType)
    {
        return authType switch
        {
            Domain.Entities.AuthenticationType.None => "No Auth",
            Domain.Entities.AuthenticationType.Basic => "Basic Auth",
            Domain.Entities.AuthenticationType.BearerToken => "Bearer Token",
            _ => authType.ToString()
        };
    }
}
