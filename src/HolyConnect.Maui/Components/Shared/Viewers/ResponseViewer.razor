@inject IFormatterService FormatterService
@inject IResponseValueExtractor ResponseValueExtractor
@inject IClipboardService ClipboardService
@inject ISnackbar Snackbar

<MudCard Style="height: 100%; display: flex; flex-direction: column;">
    <MudCardContent Style="flex: 1; display: flex; flex-direction: column; overflow: hidden;">
        @if (Response == null)
        {
            <div class="d-flex flex-column align-center justify-center" style="height: 100%; opacity: 0.5;">
                <MudIcon Icon="@Icons.Material.Filled.Bolt" Size="Size.Large" Style="width: 4rem; height: 4rem;" />
                <MudText Typo="Typo.h6" Class="mt-2">Enter the URL and click Send to get a response</MudText>
            </div>
        }
        else
        {
            <div style="flex: 0 0 auto;">
                <MudText Typo="Typo.h6">Response</MudText>
                <MudText Typo="Typo.body2">Status: @Response.StatusCode - @Response.StatusMessage</MudText>
                <MudText Typo="Typo.body2">Time: @Response.ResponseTime ms</MudText>
                <MudText Typo="Typo.body2">Size: @Response.Size bytes</MudText>
            </div>
            
            <MudTabs Class="mt-2" Elevation="2" Rounded="true" Style="flex: 1; display: flex; flex-direction: column; overflow: hidden;" PanelClass="d-flex flex-column flex-grow-1 overflow-hidden">
                @if (Response.IsStreaming)
                {
                    <MudTabPanel Text="Messages" Style="height: 100%;">
                        <div class="pa-4 d-flex flex-column" style="height: 100%;">
                            <MudStack Row="true" Justify="Justify.SpaceBetween" Class="mb-2" AlignItems="AlignItems.Center">
                                <MudText Typo="Typo.body2" Color="Color.Secondary">Events: @Response.StreamEvents.Count</MudText>
                                <MudCheckBox @bind-Value="_autoScroll" Label="Auto-scroll" Color="Color.Primary" Dense="true" />
                            </MudStack>
                            <MudPaper Class="pa-2" Elevation="1" Style="flex: 1; overflow-y: auto; background-color: var(--mud-palette-surface);">
                                @foreach (var evt in Response.StreamEvents)
                                {
                                    <div class="mb-2">
                                        <MudText Typo="Typo.caption" Color="Color.Secondary">
                                            [@evt.Timestamp.ToString("HH:mm:ss.fff")] 
                                            @if (!string.IsNullOrEmpty(evt.EventType))
                                            {
                                                <MudChip T="string" Size="Size.Small" Color="@GetEventTypeColor(evt.EventType)" Variant="Variant.Text">@evt.EventType</MudChip>
                                            }
                                        </MudText>
                                        <MudText Typo="Typo.body2" Style="font-family: monospace; white-space: pre-wrap; word-break: break-word;">@evt.Data</MudText>
                                    </div>
                                }
                            </MudPaper>
                        </div>
                    </MudTabPanel>
                }
                else
                {
                    <MudTabPanel Text="Body" Style="height: 100%;">
                        <div class="pa-4 d-flex flex-column" style="height: 100%;">
                            <MudStack Row="true" Justify="Justify.SpaceBetween" Class="mb-2" AlignItems="AlignItems.Center">
                                <MudText Typo="Typo.body2" Color="Color.Secondary">Language: @_responseLanguage</MudText>
                                <MudButton Variant="Variant.Outlined" 
                                           Color="Color.Primary" 
                                           Size="Size.Small" 
                                           StartIcon="@Icons.Material.Filled.AutoFixHigh"
                                           OnClick="PrettifyResponseBody">
                                    Format
                                </MudButton>
                            </MudStack>
                            <div style="flex: 1; min-height: 0; overflow: hidden;">
                                 <CodeEditor @ref="_codeEditor"
                                             @bind-Value="_responseBodyDisplay"
                                             Language="@_responseLanguage" 
                                             ReadOnly="true" 
                                             Height="100%" />
                            </div>
                        </div>
                    </MudTabPanel>
                }
                
                <MudTabPanel Text="Headers" Style="height: 100%;">
                    <div class="pa-4" style="height: 100%; overflow-y: auto;">
                        @foreach (var header in Response.Headers)
                        {
                            <MudText Typo="Typo.body2" Style="word-break: break-word; overflow-wrap: break-word; white-space: normal; max-width: 100%;"><strong>@header.Key:</strong> @header.Value</MudText>
                        }
                    </div>
                </MudTabPanel>
                
                @if (Response.SentRequest != null)
                {
                    <MudTabPanel Text="Request" Style="height: 100%;">
                        <div class="pa-4" style="height: 100%; overflow-y: auto;">
                            <MudText Typo="Typo.subtitle1" Class="mb-2"><strong>What was sent:</strong></MudText>
                            <MudText Typo="Typo.body2" Class="mb-1"><strong>Method:</strong> @Response.SentRequest.Method</MudText>
                            <MudText Typo="Typo.body2" Class="mb-2"><strong>URL:</strong> @Response.SentRequest.Url</MudText>
                            
                            <MudText Typo="Typo.subtitle2" Class="mt-3 mb-2"><strong>Headers:</strong></MudText>
                            @foreach (var header in @Response.SentRequest.Headers)
                            {
                                <MudText Typo="Typo.body2">@header.Key: @header.Value</MudText>
                            }
                            
                            @if (!string.IsNullOrEmpty(@Response.SentRequest.Body))
                            {
                                <MudText Typo="Typo.subtitle2" Class="mt-3 mb-2"><strong>Body:</strong></MudText>
                                <MudTextField Value="@Response.SentRequest.Body" Lines="10" Variant="Variant.Outlined" ReadOnly="true" />
                            }
                            
                            @if (@Response.SentRequest.QueryParameters.Any())
                            {
                                <MudText Typo="Typo.subtitle2" Class="mt-3 mb-2"><strong>Query Parameters:</strong></MudText>
                                @foreach (var param in @Response.SentRequest.QueryParameters)
                                {
                                    <MudText Typo="Typo.body2">@param.Key: @param.Value</MudText>
                                }
                            }
                        </div>
                    </MudTabPanel>
                }
                
                <MudTabPanel Text="Extract" Style="height: 100%;">
                    <div class="pa-4" style="height: 100%; overflow-y: auto;">
                        <MudText Typo="Typo.subtitle1" Class="mb-3"><strong>Extract Values from Response</strong></MudText>
                        <MudText Typo="Typo.body2" Class="mb-3">
                            Use JSONPath (e.g., <code>$.data.user.id</code>) for JSON/GraphQL or XPath (e.g., <code>//user/id</code>) for XML.
                        </MudText>
                        
                        <MudStack Spacing="3">
                            <MudTextField @bind-Value="_extractionPattern" 
                                          Label="Pattern" 
                                          Variant="Variant.Outlined"
                                          Placeholder="$.data.id or //id"
                                          HelperText="JSONPath for JSON/GraphQL, XPath for XML" />
                            
                            <MudStack Row="true" Spacing="2">
                                <MudButton Variant="Variant.Filled" 
                                           Color="Color.Primary" 
                                           OnClick="ExtractValue"
                                           Disabled="@string.IsNullOrWhiteSpace(_extractionPattern)">
                                    Extract
                                </MudButton>
                                
                                @if (!string.IsNullOrEmpty(_extractedValue))
                                {
                                    <MudButton Variant="Variant.Outlined" 
                                               Color="Color.Secondary" 
                                               OnClick="CopyExtractedValue"
                                               StartIcon="@Icons.Material.Filled.ContentCopy">
                                        Copy to Clipboard
                                    </MudButton>
                                }
                            </MudStack>
                            
                            @if (_extractionError)
                            {
                                <MudAlert Severity="Severity.Warning">Failed to extract value. Check your pattern.</MudAlert>
                            }
                            
                            @if (!string.IsNullOrEmpty(_extractedValue))
                            {
                                <MudPaper Class="pa-3" Elevation="1">
                                    <MudText Typo="Typo.subtitle2" Class="mb-2"><strong>Extracted Value:</strong></MudText>
                                    <MudTextField Value="@_extractedValue" 
                                                  Lines="5" 
                                                  Variant="Variant.Outlined" 
                                                  ReadOnly="true" />
                                </MudPaper>
                            }
                        </MudStack>
                    </div>
                </MudTabPanel>
            </MudTabs>
        }
    </MudCardContent>
</MudCard>

@code {
    [Parameter]
    public RequestResponse? Response { get; set; }

    private string _responseBodyDisplay = string.Empty;
    private RequestResponse? _previousResponse;
    private string _extractionPattern = string.Empty;
    private string? _extractedValue;
    private bool _extractionError = false;
    private CodeEditor? _codeEditor;
    private string _responseLanguage = "json";
    private bool _autoScroll = true;

    protected override void OnParametersSet()
    {
        // Only reset display if we have a new response (not just a re-render)
        if (Response != null && Response != _previousResponse)
        {
            _responseBodyDisplay = Response.Body;
            _previousResponse = Response;
            // Reset extraction when response changes
            _extractionPattern = string.Empty;
            _extractedValue = null;
            _extractionError = false;
            
            // Determine language
            var contentType = Response.Headers.FirstOrDefault(h => 
                h.Key.Equals("Content-Type", StringComparison.OrdinalIgnoreCase)).Value ?? "";
                
            if (contentType.Contains("xml", StringComparison.OrdinalIgnoreCase))
            {
                _responseLanguage = "xml";
            }
            else if (contentType.Contains("html", StringComparison.OrdinalIgnoreCase))
            {
                _responseLanguage = "html";
            }
            else
            {
                _responseLanguage = "json";
            }
        }
    }

    private void PrettifyResponseBody()
    {
        if (Response == null || string.IsNullOrWhiteSpace(Response.Body))
        {
            return;
        }

        try
        {
            // Try to detect content type from headers
            var contentType = Response.Headers.FirstOrDefault(h => 
                h.Key.Equals("Content-Type", StringComparison.OrdinalIgnoreCase)).Value ?? "";

            if (contentType.Contains("json", StringComparison.OrdinalIgnoreCase))
            {
                _responseBodyDisplay = FormatterService.FormatJson(Response.Body);
            }
            else if (contentType.Contains("xml", StringComparison.OrdinalIgnoreCase))
            {
                _responseBodyDisplay = FormatterService.FormatXml(Response.Body);
            }
            else
            {
                // Try to detect format by looking at content
                var trimmedBody = Response.Body.TrimStart();
                if (trimmedBody.StartsWith("{") || trimmedBody.StartsWith("["))
                {
                    var formatted = FormatterService.FormatJson(Response.Body);
                    if (!string.IsNullOrEmpty(formatted))
                    {
                        _responseBodyDisplay = formatted;
                    }
                    else
                    {
                        Snackbar.Add("Could not format as JSON. Body appears to be plain text.", Severity.Info);
                        return;
                    }
                }
                else if (trimmedBody.StartsWith("<"))
                {
                    var formatted = FormatterService.FormatXml(Response.Body);
                    if (!string.IsNullOrEmpty(formatted))
                    {
                        _responseBodyDisplay = formatted;
                    }
                    else
                    {
                        Snackbar.Add("Could not format as XML. Body appears to be plain text.", Severity.Info);
                        return;
                    }
                }
                else
                {
                    Snackbar.Add("Could not detect format. Body appears to be plain text.", Severity.Info);
                    return;
                }
            }
            StateHasChanged();
        }
        catch (Exception ex)
        {
            Snackbar.Add($"Error formatting response: {ex.Message}", Severity.Warning);
        }
    }

    private void ExtractValue()
    {
        if (Response == null || string.IsNullOrWhiteSpace(Response.Body) || string.IsNullOrWhiteSpace(_extractionPattern))
        {
            return;
        }

        try
        {
            // Determine content type from headers
            var contentType = Response.Headers.FirstOrDefault(h => 
                h.Key.Equals("Content-Type", StringComparison.OrdinalIgnoreCase)).Value ?? "application/json";

            _extractedValue = ResponseValueExtractor.ExtractValue(Response.Body, _extractionPattern, contentType);
            _extractionError = _extractedValue == null;

            if (_extractedValue != null)
            {
                Snackbar.Add("Value extracted successfully!", Severity.Success);
            }
            else
            {
                Snackbar.Add("Could not extract value with the given pattern.", Severity.Warning);
            }
        }
        catch (Exception ex)
        {
            _extractionError = true;
            _extractedValue = null;
            Snackbar.Add($"Error extracting value: {ex.Message}", Severity.Error);
        }
        
        StateHasChanged();
    }

    private async Task CopyExtractedValue()
    {
        if (string.IsNullOrEmpty(_extractedValue))
        {
            return;
        }

        try
        {
            await ClipboardService.SetTextAsync(_extractedValue);
            Snackbar.Add("Copied to clipboard!", Severity.Success);
        }
        catch (Exception ex)
        {
            Snackbar.Add($"Failed to copy to clipboard: {ex.Message}", Severity.Error);
        }
    }

    private Color GetEventTypeColor(string? eventType)
    {
        return eventType?.ToLowerInvariant() switch
        {
            "message" => Color.Primary,
            "sent" => Color.Info,
            "error" => Color.Error,
            "warning" => Color.Warning,
            "close" => Color.Secondary,
            "timeout" => Color.Warning,
            _ => Color.Default
        };
    }
}
