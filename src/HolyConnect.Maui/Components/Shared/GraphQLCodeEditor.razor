@inject IJSRuntime JSRuntime
@inject IGraphQLSchemaService SchemaService
@implements IAsyncDisposable

<div style="border: 1px solid #ccc; border-radius: 4px; overflow: hidden; @(string.IsNullOrEmpty(Height) ? "height: 400px;" : $"height: {Height};")">
    <div id="@_editorId" style="width: 100%; height: 100%;"></div>
</div>

@code {
    [Parameter]
    public string? Value { get; set; }

    [Parameter]
    public EventCallback<string?> ValueChanged { get; set; }

    [Parameter]
    public string? Height { get; set; }

    [Parameter]
    public GraphQLRequest? Request { get; set; }

    [Parameter]
    public bool ReadOnly { get; set; }

    [Parameter]
    public string Theme { get; set; } = "vs-dark";

    private string _editorId = $"monaco-editor-{Guid.NewGuid()}";
    private DotNetObjectReference<GraphQLCodeEditor>? _dotNetHelper;
    private bool _isInitialized;
    private string? _lastUrl;

    protected override async Task OnAfterRenderAsync(bool firstRender)
    {
        if (firstRender)
        {
            try
            {
                _dotNetHelper = DotNetObjectReference.Create(this);
                
                // Initialize Monaco Editor
                var success = await JSRuntime.InvokeAsync<bool>(
                    "monacoEditorInterop.initializeEditor",
                    _editorId,
                    Value ?? string.Empty,
                    "graphql",
                    Theme,
                    ReadOnly
                );

                if (success)
                {
                    _isInitialized = true;

                    // Register value change callback
                    await JSRuntime.InvokeVoidAsync(
                        "monacoEditorInterop.onValueChanged",
                        _editorId,
                        _dotNetHelper
                    );

                    // Load schema if URL is available
                    if (Request != null && !string.IsNullOrWhiteSpace(Request.Url))
                    {
                        await LoadSchemaAsync();
                    }
                }
            }
            catch (Exception ex)
            {
                Console.WriteLine($"Error initializing Monaco Editor: {ex.Message}");
            }
        }
    }

    protected override async Task OnParametersSetAsync()
    {
        if (_isInitialized)
        {
            // Update value if changed externally
            var currentValue = await JSRuntime.InvokeAsync<string?>("monacoEditorInterop.getValue", _editorId);
            if (currentValue != Value)
            {
                await JSRuntime.InvokeVoidAsync("monacoEditorInterop.setValue", _editorId, Value ?? string.Empty);
            }

            // Reload schema if URL changed
            if (Request != null && Request.Url != _lastUrl)
            {
                _lastUrl = Request.Url;
                await LoadSchemaAsync();
            }
        }
    }

    [JSInvokable]
    public async Task OnValueChanged(string value)
    {
        Value = value;
        await ValueChanged.InvokeAsync(value);
    }

    private async Task LoadSchemaAsync()
    {
        if (Request == null || string.IsNullOrWhiteSpace(Request.Url))
        {
            return;
        }

        try
        {
            var schemaJson = await SchemaService.FetchSchemaAsync(Request.Url, Request);
            
            if (!string.IsNullOrEmpty(schemaJson))
            {
                await JSRuntime.InvokeVoidAsync(
                    "monacoEditorInterop.registerGraphQLCompletionProvider",
                    _editorId,
                    schemaJson
                );
            }
        }
        catch (Exception ex)
        {
            Console.WriteLine($"Error loading GraphQL schema: {ex.Message}");
        }
    }

    public async Task TriggerSuggestionsAsync()
    {
        if (_isInitialized)
        {
            await JSRuntime.InvokeVoidAsync("monacoEditorInterop.triggerSuggest", _editorId);
        }
    }

    public async Task FormatDocumentAsync()
    {
        if (_isInitialized)
        {
            await JSRuntime.InvokeVoidAsync("monacoEditorInterop.formatDocument", _editorId);
        }
    }

    public async ValueTask DisposeAsync()
    {
        if (_isInitialized)
        {
            try
            {
                await JSRuntime.InvokeVoidAsync("monacoEditorInterop.disposeEditor", _editorId);
            }
            catch
            {
                // Ignore disposal errors
            }
        }

        _dotNetHelper?.Dispose();
    }
}
