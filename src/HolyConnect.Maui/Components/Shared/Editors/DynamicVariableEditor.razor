@using HolyConnect.Domain.Entities

<MudTable Items="@DynamicVariables" Dense="true" Hover="true" Elevation="1" Class="mb-4">
    <ToolBarContent>
        <MudText Typo="Typo.h6">
            <MudIcon Icon="@Icons.Material.Filled.AutoAwesome" Class="mr-2" />
            Dynamic Test Data Variables
        </MudText>
        <MudSpacer />
        <MudText Typo="Typo.caption" Color="Color.Default" Class="mr-4">
            Dynamic variables generate fake test data on each request.
        </MudText>
    </ToolBarContent>
    <HeaderContent>
        <MudTh>Variable Name</MudTh>
        <MudTh>Data Type</MudTh>
        <MudTh Style="text-align:center">Secret</MudTh>
        <MudTh>Constraints</MudTh>
        <MudTh Style="text-align:center">Actions</MudTh>
    </HeaderContent>
    <RowTemplate>
        <MudTd DataLabel="Variable Name">
            <MudTextField @bind-Value="@context.Name" 
                          Variant="Variant.Outlined" 
                          Margin="Margin.Dense" 
                          Dense="true"
                          Placeholder="e.g. variableName"
                          HideSpinButtons="true" />
        </MudTd>
        <MudTd DataLabel="Data Type">
            <MudSelect @bind-Value="@context.GeneratorType" 
                       Variant="Variant.Outlined" 
                       Margin="Margin.Dense" 
                       Dense="true">
                <MudSelectItem Value="DataGeneratorType.FirstName">First Name</MudSelectItem>
                <MudSelectItem Value="DataGeneratorType.LastName">Last Name</MudSelectItem>
                <MudSelectItem Value="DataGeneratorType.FullName">Full Name</MudSelectItem>
                <MudSelectItem Value="DataGeneratorType.Email">Email</MudSelectItem>
                <MudSelectItem Value="DataGeneratorType.PhoneNumber">Phone Number</MudSelectItem>
                <MudSelectItem Value="DataGeneratorType.Username">Username</MudSelectItem>
                <MudSelectItem Value="DataGeneratorType.Integer">Integer</MudSelectItem>
                <MudSelectItem Value="DataGeneratorType.Decimal">Decimal</MudSelectItem>
                <MudSelectItem Value="DataGeneratorType.Date">Date</MudSelectItem>
                <MudSelectItem Value="DataGeneratorType.DatePast">Date (Past)</MudSelectItem>
                <MudSelectItem Value="DataGeneratorType.DateFuture">Date (Future)</MudSelectItem>
                <MudSelectItem Value="DataGeneratorType.DateTime">Date Time</MudSelectItem>
                <MudSelectItem Value="DataGeneratorType.Boolean">Boolean</MudSelectItem>
                <MudSelectItem Value="DataGeneratorType.Guid">GUID/UUID</MudSelectItem>
                <MudSelectItem Value="DataGeneratorType.Url">URL</MudSelectItem>
                <MudSelectItem Value="DataGeneratorType.IpAddress">IP Address</MudSelectItem>
                <MudSelectItem Value="DataGeneratorType.StreetAddress">Street Address</MudSelectItem>
                <MudSelectItem Value="DataGeneratorType.City">City</MudSelectItem>
                <MudSelectItem Value="DataGeneratorType.Country">Country</MudSelectItem>
                <MudSelectItem Value="DataGeneratorType.ZipCode">Zip Code</MudSelectItem>
                <MudSelectItem Value="DataGeneratorType.CreditCardNumber">Credit Card Number</MudSelectItem>
                <MudSelectItem Value="DataGeneratorType.Word">Word</MudSelectItem>
                <MudSelectItem Value="DataGeneratorType.Sentence">Sentence</MudSelectItem>
            </MudSelect>
        </MudTd>
        <MudTd DataLabel="Secret" Style="text-align: center;">
            <MudCheckBox @bind-Value="@context.IsSecret" Color="Color.Primary" Dense="true" Size="Size.Small" />
        </MudTd>
        <MudTd DataLabel="Constraints">
            <MudStack Row="true" AlignItems="AlignItems.Center" Spacing="1">
                <MudIconButton Icon="@Icons.Material.Filled.Settings" 
                               Size="Size.Small"
                               Color="@(context.Constraints.Any() ? Color.Primary : Color.Default)"
                               OnClick="@(() => EditConstraints(context))"
                               Title="Configure Constraints" />
                
                @if (context.Constraints.Any())
                {
                    <MudChipSet T="ConstraintRule" Class="d-flex flex-wrap gap-1">
                        @foreach (var constraint in context.Constraints)
                        {
                            <MudChip Size="Size.Small" Color="Color.Info" Variant="Variant.Text" Class="mx-0 my-0">
                                @GetConstraintDisplay(constraint)
                            </MudChip>
                        }
                    </MudChipSet>
                }
            </MudStack>
        </MudTd>
        <MudTd DataLabel="Actions" Style="text-align: center;">
            <MudIconButton Icon="@Icons.Material.Filled.Delete" 
                           Size="Size.Small"
                           Color="Color.Error"
                           OnClick="@(() => RemoveDynamicVariable(context))" />
        </MudTd>
    </RowTemplate>
    <FooterContent>
        <MudTd ColSpan="5" Class="pa-2">
            <MudButton Variant="Variant.Outlined" 
                       Color="Color.Primary" 
                       StartIcon="@Icons.Material.Filled.Add"
                       OnClick="AddDynamicVariable"
                       FullWidth="true"
                       Class="dashed-border">
                Add Dynamic Variable
            </MudButton>
        </MudTd>
    </FooterContent>
</MudTable>

<style>
    .dashed-border {
        border-style: dashed !important;
    }
</style>

<MudDialog @bind-Visible="_showConstraintDialog" Options="_dialogOptions">
    <TitleContent>
        <MudText Typo="Typo.h6">
            <MudIcon Icon="@Icons.Material.Filled.Settings" Class="mr-2" />
            Configure Constraints for @_selectedVariable?.Name
        </MudText>
    </TitleContent>
    <DialogContent>
        @if (_selectedVariable != null)
        {
            @if (IsNumericType(_selectedVariable.GeneratorType))
            {
                <MudTextField @bind-Value="_minValue" 
                              Label="Minimum Value" 
                              Variant="Variant.Outlined"
                              Class="mb-3" />
                <MudTextField @bind-Value="_maxValue" 
                              Label="Maximum Value" 
                              Variant="Variant.Outlined"
                              Class="mb-3" />
            }
            else if (IsDateType(_selectedVariable.GeneratorType))
            {
                <MudText Typo="Typo.subtitle2" Class="mb-2">Date/Time Offsets (relative to now)</MudText>
                <MudTextField @bind-Value="_daysOffset" 
                              Label="Days Offset" 
                              Variant="Variant.Outlined"
                              Class="mb-3"
                              HelperText="e.g., 0 = today, 1 = tomorrow, -1 = yesterday" />
                <MudTextField @bind-Value="_hoursOffset" 
                              Label="Hours Offset" 
                              Variant="Variant.Outlined"
                              Class="mb-3"
                              HelperText="e.g., 1 = 1 hour from now, -2 = 2 hours ago" />
                <MudTextField @bind-Value="_minutesOffset" 
                              Label="Minutes Offset" 
                              Variant="Variant.Outlined"
                              Class="mb-3"
                              HelperText="e.g., 30 = 30 minutes from now" />
                <MudTextField @bind-Value="_secondsOffset" 
                              Label="Seconds Offset" 
                              Variant="Variant.Outlined"
                              Class="mb-3"
                              HelperText="e.g., 45 = 45 seconds from now" />
                
                @if (_selectedVariable.GeneratorType == DataGeneratorType.Date)
                {
                    <MudDivider Class="my-3" />
                    <MudText Typo="Typo.subtitle2" Class="mb-2">Age Constraints (for birthdates)</MudText>
                    <MudTextField @bind-Value="_minAge" 
                                  Label="Minimum Age (years)" 
                                  Variant="Variant.Outlined"
                                  Class="mb-3"
                                  HelperText="For generating birthdates" />
                    <MudTextField @bind-Value="_maxAge" 
                                  Label="Maximum Age (years)" 
                                  Variant="Variant.Outlined"
                                  Class="mb-3" 
                                  HelperText="For generating birthdates" />
                }
                
                <MudDivider Class="my-3" />
                <MudTextField @bind-Value="_formatString" 
                              Label="Custom Format (optional)" 
                              Variant="Variant.Outlined"
                              Class="mb-3"
                              HelperText="e.g., yyyy-MM-dd HH:mm or MM/dd/yyyy" />
            }
            else
            {
                <MudText Typo="Typo.body2" Color="Color.Default">
                    No constraints available for this data type.
                </MudText>
            }
        }
    </DialogContent>
    <DialogActions>
        <MudButton OnClick="CloseConstraintDialog">Cancel</MudButton>
        <MudButton Color="Color.Primary" Variant="Variant.Filled" OnClick="SaveConstraints">Save</MudButton>
    </DialogActions>
</MudDialog>

@code {
    [Parameter]
    public List<DynamicVariable> DynamicVariables { get; set; } = new();

    private bool _showConstraintDialog = false;
    private DynamicVariable? _selectedVariable;
    private string _minValue = string.Empty;
    private string _maxValue = string.Empty;
    private string _minAge = string.Empty;
    private string _maxAge = string.Empty;
    private string _daysOffset = string.Empty;
    private string _hoursOffset = string.Empty;
    private string _minutesOffset = string.Empty;
    private string _secondsOffset = string.Empty;
    private string _formatString = string.Empty;

    private readonly DialogOptions _dialogOptions = new()
    {
        MaxWidth = MaxWidth.Medium,
        FullWidth = true
    };

    private void AddDynamicVariable()
    {
        // Find next available variable name
        var counter = 1;
        while (DynamicVariables.Any(v => v.Name == $"variable{counter}"))
        {
            counter++;
        }
        
        DynamicVariables.Add(new DynamicVariable
        {
            Name = $"variable{counter}",
            GeneratorType = DataGeneratorType.FirstName
        });
    }

    private void RemoveDynamicVariable(DynamicVariable dynamicVar)
    {
        DynamicVariables.Remove(dynamicVar);
    }

    private void EditConstraints(DynamicVariable dynamicVar)
    {
        _selectedVariable = dynamicVar;
        _minValue = string.Empty;
        _maxValue = string.Empty;
        _minAge = string.Empty;
        _maxAge = string.Empty;
        _daysOffset = string.Empty;
        _hoursOffset = string.Empty;
        _minutesOffset = string.Empty;
        _secondsOffset = string.Empty;
        _formatString = string.Empty;

        // Load existing constraints
        foreach (var constraint in dynamicVar.Constraints)
        {
            switch (constraint.Type)
            {
                case ConstraintType.Minimum:
                    _minValue = constraint.Value;
                    break;
                case ConstraintType.Maximum:
                    _maxValue = constraint.Value;
                    break;
                case ConstraintType.MinimumAge:
                    _minAge = constraint.Value;
                    break;
                case ConstraintType.MaximumAge:
                    _maxAge = constraint.Value;
                    break;
                case ConstraintType.DaysOffset:
                    _daysOffset = constraint.Value;
                    break;
                case ConstraintType.HoursOffset:
                    _hoursOffset = constraint.Value;
                    break;
                case ConstraintType.MinutesOffset:
                    _minutesOffset = constraint.Value;
                    break;
                case ConstraintType.SecondsOffset:
                    _secondsOffset = constraint.Value;
                    break;
                case ConstraintType.Format:
                    _formatString = constraint.Value;
                    break;
            }
        }

        _showConstraintDialog = true;
    }

    private void CloseConstraintDialog()
    {
        _showConstraintDialog = false;
        _selectedVariable = null;
    }

    private void SaveConstraints()
    {
        if (_selectedVariable == null) return;

        _selectedVariable.Constraints.Clear();

        if (IsNumericType(_selectedVariable.GeneratorType))
        {
            if (!string.IsNullOrWhiteSpace(_minValue))
            {
                _selectedVariable.Constraints.Add(new ConstraintRule
                {
                    Type = ConstraintType.Minimum,
                    Value = _minValue
                });
            }
            if (!string.IsNullOrWhiteSpace(_maxValue))
            {
                _selectedVariable.Constraints.Add(new ConstraintRule
                {
                    Type = ConstraintType.Maximum,
                    Value = _maxValue
                });
            }
        }
        else if (IsDateType(_selectedVariable.GeneratorType))
        {
            // Add offset constraints
            if (!string.IsNullOrWhiteSpace(_daysOffset))
            {
                _selectedVariable.Constraints.Add(new ConstraintRule
                {
                    Type = ConstraintType.DaysOffset,
                    Value = _daysOffset
                });
            }
            if (!string.IsNullOrWhiteSpace(_hoursOffset))
            {
                _selectedVariable.Constraints.Add(new ConstraintRule
                {
                    Type = ConstraintType.HoursOffset,
                    Value = _hoursOffset
                });
            }
            if (!string.IsNullOrWhiteSpace(_minutesOffset))
            {
                _selectedVariable.Constraints.Add(new ConstraintRule
                {
                    Type = ConstraintType.MinutesOffset,
                    Value = _minutesOffset
                });
            }
            if (!string.IsNullOrWhiteSpace(_secondsOffset))
            {
                _selectedVariable.Constraints.Add(new ConstraintRule
                {
                    Type = ConstraintType.SecondsOffset,
                    Value = _secondsOffset
                });
            }
            
            // Add age constraints (for Date type only)
            if (_selectedVariable.GeneratorType == DataGeneratorType.Date)
            {
                if (!string.IsNullOrWhiteSpace(_minAge))
                {
                    _selectedVariable.Constraints.Add(new ConstraintRule
                    {
                        Type = ConstraintType.MinimumAge,
                        Value = _minAge
                    });
                }
                if (!string.IsNullOrWhiteSpace(_maxAge))
                {
                    _selectedVariable.Constraints.Add(new ConstraintRule
                    {
                        Type = ConstraintType.MaximumAge,
                        Value = _maxAge
                    });
                }
            }
            
            // Add format constraint
            if (!string.IsNullOrWhiteSpace(_formatString))
            {
                _selectedVariable.Constraints.Add(new ConstraintRule
                {
                    Type = ConstraintType.Format,
                    Value = _formatString
                });
            }
        }

        _showConstraintDialog = false;
    }

    private string GetConstraintDisplay(ConstraintRule constraint)
    {
        return constraint.Type switch
        {
            ConstraintType.Minimum => $"Min: {constraint.Value}",
            ConstraintType.Maximum => $"Max: {constraint.Value}",
            ConstraintType.MinimumAge => $"Min Age: {constraint.Value} years",
            ConstraintType.MaximumAge => $"Max Age: {constraint.Value} years",
            ConstraintType.DaysOffset => $"Days: {(constraint.Value.StartsWith("-") ? "" : "+")}{constraint.Value}",
            ConstraintType.HoursOffset => $"Hours: {(constraint.Value.StartsWith("-") ? "" : "+")}{constraint.Value}",
            ConstraintType.MinutesOffset => $"Minutes: {(constraint.Value.StartsWith("-") ? "" : "+")}{constraint.Value}",
            ConstraintType.SecondsOffset => $"Seconds: {(constraint.Value.StartsWith("-") ? "" : "+")}{constraint.Value}",
            ConstraintType.Format => $"Format: {constraint.Value}",
            _ => $"{constraint.Type}: {constraint.Value}"
        };
    }

    private bool IsNumericType(DataGeneratorType type)
    {
        return type == DataGeneratorType.Integer || type == DataGeneratorType.Decimal;
    }

    private bool IsDateType(DataGeneratorType type)
    {
        return type == DataGeneratorType.Date || 
               type == DataGeneratorType.DatePast || 
               type == DataGeneratorType.DateFuture ||
               type == DataGeneratorType.DateTime;
    }
}
