@inject IFormatterService FormatterService
@inject ISnackbar Snackbar

@if (Response != null)
{
    <MudCard Class="mt-4">
        <MudCardContent>
            <MudText Typo="Typo.h6">Response</MudText>
            <MudText Typo="Typo.body2">Status: @Response.StatusCode - @Response.StatusMessage</MudText>
            <MudText Typo="Typo.body2">Time: @Response.ResponseTime ms</MudText>
            <MudText Typo="Typo.body2">Size: @Response.Size bytes</MudText>
            
            <MudTabs Class="mt-2" Elevation="2" Rounded="true">
                <MudTabPanel Text="Body">
                    <div class="pa-4">
                        <MudStack Row="true" Justify="Justify.FlexEnd" Class="mb-2">
                            <MudButton Variant="Variant.Outlined" Color="Color.Primary" Size="Size.Small" OnClick="PrettifyResponseBody">
                                Prettify
                            </MudButton>
                        </MudStack>
                        <MudTextField Value="@_responseBodyDisplay" Lines="20" Variant="Variant.Outlined" ReadOnly="true" />
                    </div>
                </MudTabPanel>
                
                <MudTabPanel Text="Headers">
                    <div class="pa-4">
                        @foreach (var header in Response.Headers)
                        {
                            <MudText Typo="Typo.body2" Style="word-break: break-all; white-space: normal;"><strong>@header.Key:</strong> @header.Value</MudText>
                        }
                    </div>
                </MudTabPanel>
                
                @if (Response.SentRequest != null)
                {
                    <MudTabPanel Text="Request">
                        <div class="pa-4">
                            <MudText Typo="Typo.subtitle1" Class="mb-2"><strong>What was sent:</strong></MudText>
                            <MudText Typo="Typo.body2" Class="mb-1"><strong>Method:</strong> @Response.SentRequest.Method</MudText>
                            <MudText Typo="Typo.body2" Class="mb-2"><strong>URL:</strong> @Response.SentRequest.Url</MudText>
                            
                            <MudText Typo="Typo.subtitle2" Class="mt-3 mb-2"><strong>Headers:</strong></MudText>
                            @foreach (var header in @Response.SentRequest.Headers)
                            {
                                <MudText Typo="Typo.body2">@header.Key: @header.Value</MudText>
                            }
                            
                            @if (!string.IsNullOrEmpty(@Response.SentRequest.Body))
                            {
                                <MudText Typo="Typo.subtitle2" Class="mt-3 mb-2"><strong>Body:</strong></MudText>
                                <MudTextField Value="@Response.SentRequest.Body" Lines="10" Variant="Variant.Outlined" ReadOnly="true" />
                            }
                            
                            @if (@Response.SentRequest.QueryParameters.Any())
                            {
                                <MudText Typo="Typo.subtitle2" Class="mt-3 mb-2"><strong>Query Parameters:</strong></MudText>
                                @foreach (var param in @Response.SentRequest.QueryParameters)
                                {
                                    <MudText Typo="Typo.body2">@param.Key: @param.Value</MudText>
                                }
                            }
                        </div>
                    </MudTabPanel>
                }
            </MudTabs>
        </MudCardContent>
    </MudCard>
}

@code {
    [Parameter]
    public RequestResponse? Response { get; set; }

    private string _responseBodyDisplay = string.Empty;
    private RequestResponse? _previousResponse;

    protected override void OnParametersSet()
    {
        // Only reset display if we have a new response (not just a re-render)
        if (Response != null && Response != _previousResponse)
        {
            _responseBodyDisplay = Response.Body;
            _previousResponse = Response;
        }
    }

    private void PrettifyResponseBody()
    {
        if (Response == null || string.IsNullOrWhiteSpace(Response.Body))
        {
            return;
        }

        try
        {
            // Try to detect content type from headers
            var contentType = Response.Headers.FirstOrDefault(h => 
                h.Key.Equals("Content-Type", StringComparison.OrdinalIgnoreCase)).Value ?? "";

            if (contentType.Contains("json", StringComparison.OrdinalIgnoreCase))
            {
                _responseBodyDisplay = FormatterService.FormatJson(Response.Body);
            }
            else if (contentType.Contains("xml", StringComparison.OrdinalIgnoreCase))
            {
                _responseBodyDisplay = FormatterService.FormatXml(Response.Body);
            }
            else
            {
                // Try to detect format by looking at content
                var trimmedBody = Response.Body.TrimStart();
                if (trimmedBody.StartsWith("{") || trimmedBody.StartsWith("["))
                {
                    var formatted = FormatterService.FormatJson(Response.Body);
                    if (!string.IsNullOrEmpty(formatted))
                    {
                        _responseBodyDisplay = formatted;
                    }
                    else
                    {
                        Snackbar.Add("Could not format as JSON. Body appears to be plain text.", Severity.Info);
                        return;
                    }
                }
                else if (trimmedBody.StartsWith("<"))
                {
                    var formatted = FormatterService.FormatXml(Response.Body);
                    if (!string.IsNullOrEmpty(formatted))
                    {
                        _responseBodyDisplay = formatted;
                    }
                    else
                    {
                        Snackbar.Add("Could not format as XML. Body appears to be plain text.", Severity.Info);
                        return;
                    }
                }
                else
                {
                    Snackbar.Add("Could not detect format. Body appears to be plain text.", Severity.Info);
                    return;
                }
            }
            StateHasChanged();
        }
        catch (Exception ex)
        {
            Snackbar.Add($"Error formatting response: {ex.Message}", Severity.Warning);
        }
    }
}
