@inject IFormatterService FormatterService
@inject IResponseValueExtractor ResponseValueExtractor
@inject IClipboardService ClipboardService
@inject ISnackbar Snackbar

@if (Response != null)
{
    <MudCard Style="height: 100%; display: flex; flex-direction: column;">
        <MudCardContent Style="flex: 1; display: flex; flex-direction: column; overflow: hidden; padding: 12px;">
            <div style="flex: 0 0 auto; margin-bottom: 8px;">
                <MudText Typo="Typo.subtitle1" Style="margin-bottom: 4px;"><strong>Response</strong></MudText>
                <MudStack Row="true" Spacing="2" Wrap="Wrap.Wrap">
                    <MudChip T="string" Size="Size.Small" Color="@GetStatusColor(Response.StatusCode)">@Response.StatusCode - @Response.StatusMessage</MudChip>
                    <MudChip T="string" Size="Size.Small" Icon="@Icons.Material.Filled.Timer">@Response.ResponseTime ms</MudChip>
                    <MudChip T="string" Size="Size.Small" Icon="@Icons.Material.Filled.Storage">@FormatSize(Response.Size)</MudChip>
                </MudStack>
            </div>
            
            <MudTabs Class="mt-1" Elevation="2" Rounded="true" PanelClass="pa-2" Style="flex: 1; display: flex; flex-direction: column; overflow: hidden;">
                <MudTabPanel Text="Body" Style="flex: 1; display: flex; flex-direction: column; overflow: hidden;">
                    <MudStack Row="true" Justify="Justify.FlexEnd" Class="mb-2" Style="flex: 0 0 auto;">
                        <MudButton Variant="Variant.Outlined" Color="Color.Primary" Size="Size.Small" OnClick="PrettifyResponseBody">
                            Prettify
                        </MudButton>
                    </MudStack>
                    <div style="flex: 1; min-height: 0; overflow-y: auto;">
                        <MudTextField Value="@_responseBodyDisplay" Lines="25" Variant="Variant.Outlined" ReadOnly="true" />
                    </div>
                </MudTabPanel>
                
                <MudTabPanel Text="Headers" Style="flex: 1; display: flex; flex-direction: column; overflow: hidden;">
                    <div style="flex: 1; overflow-y: auto;">
                        @foreach (var header in Response.Headers)
                        {
                            <MudText Typo="Typo.caption" Style="word-break: break-word; overflow-wrap: break-word; white-space: normal; max-width: 100%; margin-bottom: 4px;"><strong>@header.Key:</strong> @header.Value</MudText>
                        }
                    </div>
                </MudTabPanel>
                
                @if (Response.SentRequest != null)
                {
                    <MudTabPanel Text="Request" Style="flex: 1; display: flex; flex-direction: column; overflow: hidden;">
                        <div style="flex: 1; overflow-y: auto;">
                            <MudText Typo="Typo.caption" Class="mb-2" Color="Color.Primary"><strong>What was sent:</strong></MudText>
                            <MudText Typo="Typo.caption" Class="mb-1"><strong>Method:</strong> @Response.SentRequest.Method</MudText>
                            <MudText Typo="Typo.caption" Class="mb-2" Style="word-break: break-all;"><strong>URL:</strong> @Response.SentRequest.Url</MudText>
                            
                            <MudText Typo="Typo.caption" Class="mt-2 mb-1" Color="Color.Primary"><strong>Headers:</strong></MudText>
                            @foreach (var header in @Response.SentRequest.Headers)
                            {
                                <MudText Typo="Typo.caption">@header.Key: @header.Value</MudText>
                            }
                            
                            @if (!string.IsNullOrEmpty(@Response.SentRequest.Body))
                            {
                                <MudText Typo="Typo.caption" Class="mt-2 mb-1" Color="Color.Primary"><strong>Body:</strong></MudText>
                                <MudTextField Value="@Response.SentRequest.Body" Lines="8" Variant="Variant.Outlined" ReadOnly="true" />
                            }
                            
                            @if (@Response.SentRequest.QueryParameters.Any())
                            {
                                <MudText Typo="Typo.caption" Class="mt-2 mb-1" Color="Color.Primary"><strong>Query Parameters:</strong></MudText>
                                @foreach (var param in @Response.SentRequest.QueryParameters)
                                {
                                    <MudText Typo="Typo.caption">@param.Key: @param.Value</MudText>
                                }
                            }
                        </div>
                    </MudTabPanel>
                }
                
                <MudTabPanel Text="Extract" Style="flex: 1; display: flex; flex-direction: column; overflow: hidden;">
                    <div style="flex: 1; overflow-y: auto;">
                        <MudText Typo="Typo.caption" Class="mb-2"><strong>Extract Values from Response</strong></MudText>
                        <MudText Typo="Typo.caption" Color="Color.Secondary" Class="mb-2">
                            Use JSONPath (e.g., <code>$.data.user.id</code>) for JSON/GraphQL or XPath (e.g., <code>//user/id</code>) for XML.
                        </MudText>
                        
                        <MudStack Spacing="2">
                            <MudTextField @bind-Value="_extractionPattern" 
                                          Label="Pattern" 
                                          Variant="Variant.Outlined"
                                          Dense="true"
                                          Placeholder="$.data.id or //id"
                                          HelperText="JSONPath for JSON/GraphQL, XPath for XML" />
                            
                            <MudStack Row="true" Spacing="2">
                                <MudButton Variant="Variant.Filled" 
                                           Color="Color.Primary" 
                                           OnClick="ExtractValue"
                                           Disabled="@string.IsNullOrWhiteSpace(_extractionPattern)">
                                    Extract
                                </MudButton>
                                
                                @if (!string.IsNullOrEmpty(_extractedValue))
                                {
                                    <MudButton Variant="Variant.Outlined" 
                                               Color="Color.Secondary" 
                                               OnClick="CopyExtractedValue"
                                               StartIcon="@Icons.Material.Filled.ContentCopy">
                                        Copy to Clipboard
                                    </MudButton>
                                }
                            </MudStack>
                            
                            @if (_extractionError)
                            {
                                <MudAlert Severity="Severity.Warning">Failed to extract value. Check your pattern.</MudAlert>
                            }
                            
                            @if (!string.IsNullOrEmpty(_extractedValue))
                            {
                                <MudPaper Class="pa-3" Elevation="1">
                                    <MudText Typo="Typo.subtitle2" Class="mb-2"><strong>Extracted Value:</strong></MudText>
                                    <MudTextField Value="@_extractedValue" 
                                                  Lines="5" 
                                                  Variant="Variant.Outlined" 
                                                  ReadOnly="true" />
                                </MudPaper>
                            }
                        </MudStack>
                    </div>
                </MudTabPanel>
            </MudTabs>
        </MudCardContent>
    </MudCard>
}

@code {
    [Parameter]
    public RequestResponse? Response { get; set; }

    private string _responseBodyDisplay = string.Empty;
    private RequestResponse? _previousResponse;
    private string _extractionPattern = string.Empty;
    private string? _extractedValue;
    private bool _extractionError = false;

    protected override void OnParametersSet()
    {
        // Only reset display if we have a new response (not just a re-render)
        if (Response != null && Response != _previousResponse)
        {
            _responseBodyDisplay = Response.Body;
            _previousResponse = Response;
            // Reset extraction when response changes
            _extractionPattern = string.Empty;
            _extractedValue = null;
            _extractionError = false;
        }
    }

    private void PrettifyResponseBody()
    {
        if (Response == null || string.IsNullOrWhiteSpace(Response.Body))
        {
            return;
        }

        try
        {
            // Try to detect content type from headers
            var contentType = Response.Headers.FirstOrDefault(h => 
                h.Key.Equals("Content-Type", StringComparison.OrdinalIgnoreCase)).Value ?? "";

            if (contentType.Contains("json", StringComparison.OrdinalIgnoreCase))
            {
                _responseBodyDisplay = FormatterService.FormatJson(Response.Body);
            }
            else if (contentType.Contains("xml", StringComparison.OrdinalIgnoreCase))
            {
                _responseBodyDisplay = FormatterService.FormatXml(Response.Body);
            }
            else
            {
                // Try to detect format by looking at content
                var trimmedBody = Response.Body.TrimStart();
                if (trimmedBody.StartsWith("{") || trimmedBody.StartsWith("["))
                {
                    var formatted = FormatterService.FormatJson(Response.Body);
                    if (!string.IsNullOrEmpty(formatted))
                    {
                        _responseBodyDisplay = formatted;
                    }
                    else
                    {
                        Snackbar.Add("Could not format as JSON. Body appears to be plain text.", Severity.Info);
                        return;
                    }
                }
                else if (trimmedBody.StartsWith("<"))
                {
                    var formatted = FormatterService.FormatXml(Response.Body);
                    if (!string.IsNullOrEmpty(formatted))
                    {
                        _responseBodyDisplay = formatted;
                    }
                    else
                    {
                        Snackbar.Add("Could not format as XML. Body appears to be plain text.", Severity.Info);
                        return;
                    }
                }
                else
                {
                    Snackbar.Add("Could not detect format. Body appears to be plain text.", Severity.Info);
                    return;
                }
            }
            StateHasChanged();
        }
        catch (Exception ex)
        {
            Snackbar.Add($"Error formatting response: {ex.Message}", Severity.Warning);
        }
    }

    private void ExtractValue()
    {
        if (Response == null || string.IsNullOrWhiteSpace(Response.Body) || string.IsNullOrWhiteSpace(_extractionPattern))
        {
            return;
        }

        try
        {
            // Determine content type from headers
            var contentType = Response.Headers.FirstOrDefault(h => 
                h.Key.Equals("Content-Type", StringComparison.OrdinalIgnoreCase)).Value ?? "application/json";

            _extractedValue = ResponseValueExtractor.ExtractValue(Response.Body, _extractionPattern, contentType);
            _extractionError = _extractedValue == null;

            if (_extractedValue != null)
            {
                Snackbar.Add("Value extracted successfully!", Severity.Success);
            }
            else
            {
                Snackbar.Add("Could not extract value with the given pattern.", Severity.Warning);
            }
        }
        catch (Exception ex)
        {
            _extractionError = true;
            _extractedValue = null;
            Snackbar.Add($"Error extracting value: {ex.Message}", Severity.Error);
        }
        
        StateHasChanged();
    }

    private async Task CopyExtractedValue()
    {
        if (string.IsNullOrEmpty(_extractedValue))
        {
            return;
        }

        try
        {
            await ClipboardService.SetTextAsync(_extractedValue);
            Snackbar.Add("Copied to clipboard!", Severity.Success);
        }
        catch (Exception ex)
        {
            Snackbar.Add($"Failed to copy to clipboard: {ex.Message}", Severity.Error);
        }
    }

    private Color GetStatusColor(int statusCode)
    {
        return statusCode switch
        {
            >= 200 and < 300 => Color.Success,
            >= 300 and < 400 => Color.Info,
            >= 400 and < 500 => Color.Warning,
            >= 500 => Color.Error,
            _ => Color.Default
        };
    }

    private string FormatSize(long bytes)
    {
        if (bytes < 1024) return $"{bytes} B";
        if (bytes < 1024 * 1024) return $"{bytes / 1024.0:F2} KB";
        return $"{bytes / (1024.0 * 1024.0):F2} MB";
    }
}
