@inject IJSRuntime JSRuntime
@inject SettingsService SettingsService
@implements IAsyncDisposable

<MudPaper Elevation="2" Class="pa-0" Style="@(string.IsNullOrEmpty(Height) ? "height: 31.25rem;" : $"height: {Height};")">
    <div style="display: flex; flex-direction: column; height: 100%;">
        @if (!string.IsNullOrEmpty(Title))
        {
            <MudStack Row="true" Justify="Justify.SpaceBetween" AlignItems="AlignItems.Center" Class="px-3 py-2" Style="border-bottom: 1px solid var(--mud-palette-divider);">
                <MudText Typo="Typo.subtitle2" Color="Color.Default">@Title</MudText>
                <MudChip T="string" Size="Size.Small" Color="@GetStatusColor()" Variant="Variant.Text">
                    @Status
                </MudChip>
            </MudStack>
        }
        <div id="@_editorId" style="flex: 1; overflow: hidden;"></div>
    </div>
</MudPaper>

@code {
    [Parameter]
    public string? OriginalContent { get; set; }

    [Parameter]
    public string? ModifiedContent { get; set; }

    [Parameter]
    public string? Height { get; set; }

    [Parameter]
    public string? Title { get; set; }

    [Parameter]
    public string Language { get; set; } = "plaintext";

    [Parameter]
    public string Status { get; set; } = string.Empty;

    [Parameter]
    public string? Theme { get; set; }

    private string _editorId = $"monaco-diff-editor-{Guid.NewGuid()}";
    private bool _isInitialized;
    private string _currentTheme = "vs-dark";
    private string _currentLanguage = "plaintext";

    protected override async Task OnAfterRenderAsync(bool firstRender)
    {
        if (firstRender)
        {
            try
            {
                // Determine theme based on app settings
                await DetermineThemeAsync();
                
                // Determine language
                _currentLanguage = GetMonacoLanguage(Language);
                
                // Initialize Monaco Diff Editor
                var success = await JSRuntime.InvokeAsync<bool>(
                    "monacoEditorInterop.initializeDiffEditor",
                    _editorId,
                    OriginalContent ?? string.Empty,
                    ModifiedContent ?? string.Empty,
                    _currentLanguage,
                    _currentTheme,
                    true // Read-only
                );

                if (success)
                {
                    _isInitialized = true;
                }
            }
            catch (Exception ex)
            {
                Console.WriteLine($"Error initializing Monaco Diff Editor: {ex.Message}");
            }
        }
    }
    
    private async Task DetermineThemeAsync()
    {
        if (!string.IsNullOrEmpty(Theme))
        {
            _currentTheme = Theme;
            return;
        }
        
        try
        {
            var settings = await SettingsService.GetSettingsAsync();
            _currentTheme = settings.IsDarkMode ? "vs-dark" : "vs";
        }
        catch
        {
            _currentTheme = "vs-dark"; // Default fallback
        }
    }

    private string GetMonacoLanguage(string language)
    {
        return language?.ToLowerInvariant() switch
        {
            "json" => "json",
            "xml" => "xml",
            "html" => "html",
            "javascript" => "javascript",
            "csharp" or "cs" => "csharp",
            "text" => "plaintext",
            _ => "plaintext"
        };
    }

    protected override async Task OnParametersSetAsync()
    {
        if (_isInitialized)
        {
            // Update content if changed externally
            var newLanguage = GetMonacoLanguage(Language);
            
            await JSRuntime.InvokeVoidAsync(
                "monacoEditorInterop.updateDiffEditor", 
                _editorId, 
                OriginalContent ?? string.Empty,
                ModifiedContent ?? string.Empty,
                newLanguage != _currentLanguage ? newLanguage : null
            );

            _currentLanguage = newLanguage;
        }
    }

    private Color GetStatusColor()
    {
        return Status?.ToLowerInvariant() switch
        {
            "added" => Color.Success,
            "modified" => Color.Warning,
            "deleted" => Color.Error,
            "renamed" => Color.Primary,
            _ => Color.Default
        };
    }

    public async ValueTask DisposeAsync()
    {
        if (_isInitialized)
        {
            try
            {
                await JSRuntime.InvokeVoidAsync("monacoEditorInterop.disposeEditor", _editorId);
            }
            catch
            {
                // Ignore disposal errors
            }
        }
    }
}
