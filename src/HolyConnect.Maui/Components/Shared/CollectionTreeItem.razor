@inject IDialogService DialogService
@inject NavigationManager NavigationManager

@if (Collection != null)
{
    <div>
        <MudPaper Class="pa-2 mb-1" Style="display: flex; align-items: center; justify-content: space-between;">
            <MudText Style="flex: 1;">
                <span @onclick="@(() => ToggleExpanded())" style="cursor: pointer;">
                    @if (HasChildren)
                    {
                        <MudIcon Icon="@(_isExpanded ? Icons.Material.Filled.ExpandMore : Icons.Material.Filled.ChevronRight)" Size="Size.Small" />
                    }
                    else
                    {
                        <span style="display: inline-block; width: 24px;"></span>
                    }
                </span>
                <span @onclick="@(() => OnSelect.InvokeAsync(Collection))" style="cursor: pointer;">
                    <MudIcon Icon="@Icons.Material.Filled.Folder" Size="Size.Small" /> @Collection.Name
                </span>
            </MudText>
            <div style="display: flex; gap: 4px;" @onclick:stopPropagation="true">
                <MudIconButton Icon="@Icons.Material.Filled.Add" Size="Size.Small" OnClick="@(() => ShowAddMenu())" aria-label="Add sub-collection or request" />
                <MudIconButton Icon="@Icons.Material.Filled.Edit" Size="Size.Small" OnClick="@(() => RenameCollection())" aria-label="Rename collection" />
                <MudIconButton Icon="@Icons.Material.Filled.Delete" Size="Size.Small" Color="Color.Error" OnClick="@(() => DeleteCollection())" aria-label="Delete collection" />
            </div>
        </MudPaper>
        
        @if (_isExpanded)
        {
            <div Class="ml-4">
                @if (Collection.Requests != null && Collection.Requests.Any())
                {
                    @foreach (var request in Collection.Requests)
                    {
                        <MudPaper Class="pa-2 mb-1" Style="display: flex; align-items: center; justify-content: space-between;">
                            <MudText Style="flex: 1; cursor: pointer;" @onclick="@(() => OnRequestSelect.InvokeAsync(request))">
                                <MudIcon Icon="@GetRequestIcon(request.Type)" Size="Size.Small" Color="@GetRequestColor(request.Type)" /> @request.Name
                            </MudText>
                            <div style="display: flex; gap: 4px;" @onclick:stopPropagation="true">
                                <MudIconButton Icon="@Icons.Material.Filled.Edit" Size="Size.Small" OnClick="@(() => RenameRequest(request))" aria-label="Rename request" />
                                <MudIconButton Icon="@Icons.Material.Filled.Delete" Size="Size.Small" Color="Color.Error" OnClick="@(() => DeleteRequest(request))" aria-label="Delete request" />
                            </div>
                        </MudPaper>
                    }
                }
                
                @if (Collection.SubCollections != null && Collection.SubCollections.Any())
                {
                    @foreach (var subCollection in Collection.SubCollections)
                    {
                        <CollectionTreeItem Collection="@subCollection" 
                                          OnSelect="@OnSelect" 
                                          OnRequestSelect="@OnRequestSelect"
                                          OnCollectionUpdated="@OnCollectionUpdated"
                                          OnRequestUpdated="@OnRequestUpdated" />
                    }
                }
            </div>
        }
    </div>
}

@code {
    [Parameter]
    public Collection? Collection { get; set; }

    [Parameter]
    public EventCallback<Collection> OnSelect { get; set; }

    [Parameter]
    public EventCallback<Request> OnRequestSelect { get; set; }

    [Parameter]
    public EventCallback<(Guid CollectionId, string NewName, bool IsDelete)> OnCollectionUpdated { get; set; }

    [Parameter]
    public EventCallback<(Guid RequestId, string NewName, bool IsDelete)> OnRequestUpdated { get; set; }

    private bool _isExpanded = false;

    private bool HasChildren => 
        (Collection?.SubCollections != null && Collection.SubCollections.Any()) || 
        (Collection?.Requests != null && Collection.Requests.Any());

    private void ToggleExpanded()
    {
        if (HasChildren)
        {
            _isExpanded = !_isExpanded;
        }
    }

    private string GetRequestIcon(RequestType type) => type switch
    {
        RequestType.Rest => Icons.Material.Filled.Http,
        RequestType.GraphQL => Icons.Material.Filled.GraphicEq,
        _ => Icons.Material.Filled.Article
    };

    private Color GetRequestColor(RequestType type) => type switch
    {
        RequestType.Rest => Color.Primary,
        RequestType.GraphQL => Color.Secondary,
        _ => Color.Default
    };

    private async Task ShowAddMenu()
    {
        if (Collection == null) return;

        var options = new List<string> { "New Sub-Collection", "New Request" };
        var parameters = new DialogParameters
        {
            ["Options"] = options
        };

        var dialog = await DialogService.ShowAsync<SelectOptionDialog>("Add", parameters);
        var result = await dialog.Result;

        if (!result.Canceled && result.Data is string selectedOption)
        {
            if (selectedOption == "New Sub-Collection")
            {
                CreateSubCollection();
            }
            else if (selectedOption == "New Request")
            {
                CreateRequest();
            }
        }
    }

    private void CreateSubCollection()
    {
        if (Collection == null) return;
        NavigationManager.NavigateTo($"/collection/{Collection.Id}/subcollection/create");
    }

    private void CreateRequest()
    {
        if (Collection == null) return;
        NavigationManager.NavigateTo($"/collection/{Collection.Id}/request/create");
    }

    private async Task RenameCollection()
    {
        if (Collection == null) return;

        var parameters = new DialogParameters
        {
            ["CurrentName"] = Collection.Name
        };

        var dialog = await DialogService.ShowAsync<RenameDialog>("Rename Collection", parameters);
        var result = await dialog.Result;

        if (!result.Canceled && result.Data is string newName && !string.IsNullOrWhiteSpace(newName))
        {
            await OnCollectionUpdated.InvokeAsync((Collection.Id, newName, false));
        }
    }

    private async Task DeleteCollection()
    {
        if (Collection == null) return;

        var parameters = new DialogParameters
        {
            ["ContentText"] = $"Are you sure you want to delete the collection '{Collection.Name}'? This action cannot be undone.",
            ["ButtonText"] = "Delete",
            ["Color"] = Color.Error
        };

        var dialog = await DialogService.ShowAsync<ConfirmDialog>("Delete Collection", parameters);
        var result = await dialog.Result;

        if (!result.Canceled)
        {
            await OnCollectionUpdated.InvokeAsync((Collection.Id, string.Empty, true));
        }
    }

    private async Task RenameRequest(Request request)
    {
        var parameters = new DialogParameters
        {
            ["CurrentName"] = request.Name
        };

        var dialog = await DialogService.ShowAsync<RenameDialog>("Rename Request", parameters);
        var result = await dialog.Result;

        if (!result.Canceled && result.Data is string newName && !string.IsNullOrWhiteSpace(newName))
        {
            await OnRequestUpdated.InvokeAsync((request.Id, newName, false));
        }
    }

    private async Task DeleteRequest(Request request)
    {
        var parameters = new DialogParameters
        {
            ["ContentText"] = $"Are you sure you want to delete the request '{request.Name}'? This action cannot be undone.",
            ["ButtonText"] = "Delete",
            ["Color"] = Color.Error
        };

        var dialog = await DialogService.ShowAsync<ConfirmDialog>("Delete Request", parameters);
        var result = await dialog.Result;

        if (!result.Canceled)
        {
            await OnRequestUpdated.InvokeAsync((request.Id, string.Empty, true));
        }
    }
}
