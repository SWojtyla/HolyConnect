@if (Collection != null)
{
    <div>
        <MudPaper Class="pa-2 mb-1" Style="cursor: pointer;">
            <MudText>
                <span @onclick="@(() => ToggleExpanded())">
                    @if (HasChildren)
                    {
                        <MudIcon Icon="@(_isExpanded ? Icons.Material.Filled.ExpandMore : Icons.Material.Filled.ChevronRight)" Size="Size.Small" />
                    }
                    else
                    {
                        <span style="display: inline-block; width: 24px;"></span>
                    }
                </span>
                <span @onclick="@(() => OnSelect.InvokeAsync(Collection))">
                    <MudIcon Icon="@Icons.Material.Filled.Folder" Size="Size.Small" /> @Collection.Name
                </span>
            </MudText>
        </MudPaper>
        
        @if (_isExpanded)
        {
            <div Class="ml-4">
                @if (Collection.Requests != null && Collection.Requests.Any())
                {
                    @foreach (var request in Collection.Requests)
                    {
                        <MudPaper Class="pa-2 mb-1" Style="cursor: pointer;" @onclick="@(() => OnRequestSelect.InvokeAsync(request))">
                            <MudText>
                                <MudIcon Icon="@GetRequestIcon(request.Type)" Size="Size.Small" Color="@GetRequestColor(request.Type)" /> @request.Name
                            </MudText>
                        </MudPaper>
                    }
                }
                
                @if (Collection.SubCollections != null && Collection.SubCollections.Any())
                {
                    @foreach (var subCollection in Collection.SubCollections)
                    {
                        <CollectionTreeItem Collection="@subCollection" OnSelect="@OnSelect" OnRequestSelect="@OnRequestSelect" />
                    }
                }
            </div>
        }
    </div>
}

@code {
    [Parameter]
    public Collection? Collection { get; set; }

    [Parameter]
    public EventCallback<Collection> OnSelect { get; set; }

    [Parameter]
    public EventCallback<Request> OnRequestSelect { get; set; }

    private bool _isExpanded = false;

    private bool HasChildren => 
        (Collection?.SubCollections != null && Collection.SubCollections.Any()) || 
        (Collection?.Requests != null && Collection.Requests.Any());

    private void ToggleExpanded()
    {
        if (HasChildren)
        {
            _isExpanded = !_isExpanded;
        }
    }

    private string GetRequestIcon(RequestType type) => type switch
    {
        RequestType.Rest => Icons.Material.Filled.Http,
        RequestType.GraphQL => Icons.Material.Filled.GraphicEq,
        _ => Icons.Material.Filled.Article
    };

    private Color GetRequestColor(RequestType type) => type switch
    {
        RequestType.Rest => Color.Primary,
        RequestType.GraphQL => Color.Secondary,
        _ => Color.Default
    };
}
